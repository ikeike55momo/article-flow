# フェーズ4.5: AI画像生成・最適化

## 入力情報
- optimized_content: {{04_optimized.html}}
- article_structure: {{02_structure.json}}
- main_keyword: {{main_kw}}
- target_audience: {{target}}
- store_info: {{store_url}}, {{store_type}}

## AI画像生成プロンプト作成タスク

**重要**: 記事の各セクションに最適な画像生成プロンプトを作成し、ユーザーが外部ツールで画像生成できるようにします。

### 1. 各セクションの画像要件分析

HTMLコンテンツから各H2セクションを抽出し、以下を分析：

1. **セクション内容の理解**
   - 核心メッセージの特定
   - 読者が視覚的に理解したい情報
   - テキストだけでは伝わりにくい概念

2. **画像タイプの決定**
   各セクションに最適な画像タイプを選択：
   - **写真風**: 具体的な対象物や状況
   - **図解・インフォグラフィック**: プロセスや比較
   - **概念図**: 抽象的なアイデアの視覚化
   - **チャート・グラフ**: データの視覚化

### 2. Gemini用画像プロンプトの生成

#### プロンプト構造テンプレート
```
{
  "style": "{{選択したスタイル}}",
  "subject": "{{具体的な主題}}",
  "composition": "{{構図の説明}}",
  "mood": "{{雰囲気・感情}}",
  "colors": "{{カラーパレット}}",
  "details": "{{重要な詳細要素}}",
  "avoid": "{{避けるべき要素}}"
}
```

#### セクション別プロンプト例

**基本知識セクション**:
```
プロフェッショナルな医療イラスト風の画像。{{main_kw}}の構造を分かりやすく示す断面図。
清潔感のある白とパステルブルーを基調とし、重要な部分は優しいピンクでハイライト。
テキストやラベルは含めず、視覚的に理解できる構成。医学的に正確でありながら親しみやすい表現。
```

**実践方法セクション**:
```
ステップバイステップのプロセスを示す連続イラスト。{{main_kw}}の正しい{{実践内容}}を3-4段階で表現。
明るく清潔な環境設定、手の動きを中心に構成。プロ仕様の道具を含む。
上から見下ろす視点で、各ステップが明確に区別できる配置。
```

**比較・選択セクション**:
```
Before/Afterまたは複数オプションの比較を示すスプリットスクリーン構成。
左右または上下で明確な違いを視覚化。良い例は明るく、問題のある例は控えめな色調。
判断基準が一目で分かる視覚的な差異を強調。
```

### 3. 画像生成プロンプトの作成と出力

各セクションに最適化された画像生成プロンプトを作成：

1. **プロンプトの詳細化**
   各セクションについて以下の情報を含むプロンプトを生成：
   ```
   セクション: {{H2タイトル}}
   
   メインプロンプト:
   {{具体的で詳細な画像生成指示}}
   
   スタイル指定:
   - アスペクト比: 4:3 (800x600推奨)
   - スタイル: プロフェッショナル、清潔、信頼感
   - カラー: 明るく親しみやすい色調
   - 品質: 高品質、商用利用可能
   
   ネガティブプロンプト:
   text, watermark, logo, copyright, signature, low quality, blurry
   
   推奨生成ツール:
   - Google AI Imagen 3
   - DALL-E 3
   - Midjourney v6
   - Stable Diffusion XL
   ```

2. **画像配置情報**
   ```html
   <!-- 画像挿入位置: {{H2タイトル}}セクション -->
   <figure class="content-image">
     <img src="images/{{推奨ファイル名}}.webp"
          alt="{{SEO最適化されたalt属性（80-120字）}}"
          loading="lazy" decoding="async"
          width="800" height="600">
     <figcaption>{{専門的な補足説明}}</figcaption>
   </figure>
   ```

3. **外部ツール用の設定値**
   ```json
   {
     "recommended_settings": {
       "width": 800,
       "height": 600,
       "quality": "high",
       "format": "webp",
       "variations": 2,
       "model": "imagen-3"
     },
     "cost_estimate": {
       "imagen_3": "$0.04/image",
       "dalle_3": "$0.04/image",
       "midjourney": "$0.0025/image",
       "local_sd": "$0.00/image"
     }
   }
   ```

### 4. 画像の後処理と最適化

1. **WebP変換と圧縮**
   - 品質設定: 85（高品質を維持しつつファイルサイズ削減）
   - 最大ファイルサイズ: 200KB
   - 寸法: 800x600px（レスポンシブ対応）

2. **メタデータ追加**
   - 著作権情報
   - 生成日時
   - 使用モデル情報

3. **アクセシビリティ対応**
   - 詳細なalt属性の生成（80-120字）
   - figcaptionの作成

### 5. 品質評価チェックリスト

各生成画像を以下の基準で評価：

#### コンテンツ適合性（40点）
- [ ] セクション内容と一致（15点）
- [ ] メインキーワードとの関連性（10点）
- [ ] 読者の理解を助ける（10点）
- [ ] 誤解を招く要素がない（5点）

#### ビジュアル品質（30点）
- [ ] プロフェッショナルな外観（10点）
- [ ] 明瞭で見やすい（10点）
- [ ] ブランドイメージと調和（10点）

#### 技術的品質（30点）
- [ ] 適切な解像度とサイズ（10点）
- [ ] WebP形式で最適化済み（10点）
- [ ] 読み込み速度への配慮（10点）

### 6. 出力形式

#### 画像メタデータJSON
```json
{
  "section_images": [
    {
      "section_id": "h2_{{index}}",
      "section_title": "{{H2タイトル}}",
      "image_type": "{{写真風|図解|概念図}}",
      "prompt_used": "{{実際に使用したプロンプト}}",
      "variations": [
        {
          "filename": "{{main_kw}}-{{section_slug}}-v1.webp",
          "filesize": "{{KB}}",
          "dimensions": "800x600",
          "quality_score": {{0-100}},
          "selected": {{true|false}}
        }
      ],
      "alt_text": "{{詳細な説明、キーワード含む}}",
      "figcaption": "{{専門的な補足説明}}",
      "placement_code": "{{HTML挿入コード}}"
    }
  ],
  "generation_summary": {
    "total_images": {{数}},
    "average_quality": {{0-100}},
    "total_filesize": "{{KB}}",
    "api_calls": {{回数}}
  }
}
```

#### 更新されたHTML
各セクションの適切な位置に画像を挿入：
```html
<!-- 画像挿入位置: {{H2タイトル}}セクション -->
<figure class="content-image">
  <img src="output/images/{{filename}}"
       alt="{{alt_text}}"
       loading="lazy" decoding="async"
       width="800" height="600">
  <figcaption>{{figcaption}}</figcaption>
</figure>
```

### 7. エラーハンドリング

- **生成制限**: 制限に達した場合はプレースホルダーを使用
- **生成失敗**: 代替プロンプトで再試行（最大3回）
- **品質不足**: プレースホルダー画像を維持し、警告を出力
- **安全性フィルタ**: より安全なプロンプトで再生成

## ファイル保存

1. 画像ファイル：
   ```
   output/{date}-{title_slug}/images/
   ```

2. 画像メタデータ：
   ```
   output/{date}-{title_slug}/04_5_image_metadata.json
   ```

3. 画像を含む更新版HTML：
   ```
   output/{date}-{title_slug}/04_5_with_images.html
   ```

## 重要な注意事項

1. **医療・健康関連の画像**
   - 医学的に正確な表現を心がける
   - 誇大表現や誤解を招く表現を避ける
   - 薬機法・景表法に配慮

2. **著作権・商標**
   - ブランドロゴや他社製品を含めない
   - 一般的な表現を使用
   - 生成された画像の商用利用可能性を確認

3. **文化的配慮**
   - 多様性を意識した表現
   - ステレオタイプを避ける
   - 普遍的に受け入れられる表現

4. **ユーザビリティ**
   - 色覚多様性に配慮したカラー選択
   - 十分なコントラスト
   - モバイルでも見やすいサイズと構成