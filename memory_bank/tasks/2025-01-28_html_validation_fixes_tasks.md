# HTML バリデーション処理改善タスクリスト

## Phase 1: 緊急修正（優先度1）

### タスク1: Markdown番号付きリスト変換機能の作成 【最優先】
- [ ] 1.1 `convert_markdown_lists_to_html.py` スクリプト作成
  - [ ] BeautifulSoupを使用したHTML解析機能
  - [ ] 番号付きリスト検出ロジック（正規表現: `^\s*\d+\.\s+(.+)$`）
  - [ ] `<ol><li>` タグへの変換機能
  - [ ] pre/codeタグ内除外機能
  - [ ] 2行以上連続条件のチェック
  - [ ] エラーハンドリングと詳細ログ出力
- [ ] 1.2 単体テスト作成
  - [ ] 正常な番号付きリスト変換テスト
  - [ ] pre/code内除外テスト
  - [ ] 単発行（誤検出）回避テスト
  - [ ] エッジケース（空行、改行等）テスト
- [ ] 1.3 動作確認（実際のHTMLファイルでテスト）

### タスク2: ワークフローの continue-on-error 設定 【緊急】
- [ ] 2.1 v4ワークフローの Advanced HTML Validation & Auto-Fix ステップ修正
  - [ ] Validate HTML (1st) に continue-on-error: true を追加
  - [ ] Convert shortcodes に continue-on-error: true を追加
  - [ ] Convert markdown lists ステップを追加
  - [ ] Auto-fix に continue-on-error: true を追加
  - [ ] Final validation gate を最後に追加
- [ ] 2.2 v4-freeワークフローの同様修正
- [ ] 2.3 動作確認（エラー時も処理が継続することを確認）

## Phase 2: 安定性向上（優先度2）

### タスク3: 環境変数エラー解決機能 【重要】
- [ ] 3.1 Secrets存在チェック機能の追加
  - [ ] Check ANTHROPIC_API_KEY presence ステップ作成
  - [ ] has_key=true/false の output 設定
  - [ ] ログでの存在確認（値は出力しない）
- [ ] 3.2 Auto-fix実行条件の改善
  - [ ] Secrets存在時のみ実行する条件式
  - [ ] フォークPRでのスキップ条件
  - [ ] env: ANTHROPIC_API_KEY の明示的設定
- [ ] 3.3 両ワークフローへの適用と動作確認

### タスク4: convert_markdown_lists_to_html.py のワークフロー統合 【重要】
- [ ] 4.1 v4ワークフローへの統合
  - [ ] Convert shortcodes ステップの後に追加
  - [ ] エラーハンドリングの設定
  - [ ] ログ出力の設定
- [ ] 4.2 v4-freeワークフローへの統合（同様）
- [ ] 4.3 統合テスト（実際のワークフロー実行で確認）

## Phase 3: 改善・堅牢性（優先度3）

### タスク5: 段階的バリデーション機能 【改善】
- [ ] 5.1 各変換後のバリデーション実行
  - [ ] ショートコード変換後のバリデーション
  - [ ] 番号付きリスト変換後のバリデーション
  - [ ] Auto-fix後のバリデーション
- [ ] 5.2 バリデーションレポートの段階管理
  - [ ] report1.json（初回バリデーション）
  - [ ] report2.json（変換処理後）
  - [ ] report3.json（Auto-fix後）
- [ ] 5.3 進捗と改善度の可視化

### タスク6: アーティファクト保存とデバッグ機能 【改善】
- [ ] 6.1 各段階のHTML保存
  - [ ] 変換前HTMLの保存
  - [ ] 各変換処理後のHTML保存
  - [ ] 最終HTMLの保存
- [ ] 6.2 詳細ログとエラー情報の保存
  - [ ] 変換処理の詳細ログ
  - [ ] エラー発生時のスタックトレース
  - [ ] バリデーション結果の詳細情報
- [ ] 6.3 デバッグ用アーティファクトのアップロード設定

## Phase 4: テストと検証

### タスク7: 統合テストと品質保証 【検証】
- [ ] 7.1 正常ケースのテスト
  - [ ] 番号付きリストを含むHTMLでのワークフロー実行
  - [ ] ショートコードと番号付きリスト混在ケース
  - [ ] 完全にクリーンなHTMLケース
- [ ] 7.2 エラーケースのテスト
  - [ ] API KEY なしでのワークフロー実行
  - [ ] フォークPRでのワークフロー実行
  - [ ] 変換不可能なHTMLでのワークフロー実行
- [ ] 7.3 パフォーマンステスト
  - [ ] 大容量HTMLファイルでの処理時間測定
  - [ ] メモリ使用量の測定
  - [ ] 複数ファイル処理の負荷テスト

### タスク8: 実装レポート作成と文書化 【完了】
- [ ] 8.1 実装内容の詳細レポート作成
  - [ ] 修正内容と影響範囲
  - [ ] テスト結果とパフォーマンス数値
  - [ ] 既知の制限事項と今後の改善点
- [ ] 8.2 運用ガイドの作成
  - [ ] エラー発生時の対処方法
  - [ ] デバッグ手順とログの見方
  - [ ] 設定変更時の注意点
- [ ] 8.3 memory_bank への保存

## 実装順序と依存関係

### Critical Path（最重要経路）
1. **タスク1** → **タスク4** → **タスク7.1** : 主機能の実装とテスト
2. **タスク2** → **タスク7.2** : エラーハンドリングとテスト  
3. **タスク3** → **タスク7.2** : 環境変数対策とテスト

### 並行実行可能
- タスク1とタスク2は並行実行可能
- タスク5とタスク6は Phase 3 で並行実行可能
- タスク7の各サブタスクは並行実行可能

### 依存関係
- タスク4 は タスク1 完了後
- タスク7 は タスク2, タスク3, タスク4 完了後
- タスク8 は 全タスク完了後

## 注意事項とリスク対策

### 開発時注意事項
- CLAUDE.mdルール遵守：勝手な機能変更禁止、ハードコード禁止
- 他機能への影響最小化：既存ワークフローとの互換性保持
- テスト駆動開発：実装前にテストケース作成

### リスク対策
- **誤変換リスク**: pre/code除外、2行以上条件、詳細ログ
- **パフォーマンス劣化**: タイムアウト設定、メモリ監視
- **互換性問題**: 段階的導入、ロールバック計画

### 成功基準
- ✅ 番号付きリスト変換率: 100%
- ✅ ワークフロー成功率: 98%以上
- ✅ 処理時間増加: 1分以内
- ✅ エラー時フォールバック: 正常動作