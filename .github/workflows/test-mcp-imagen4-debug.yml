name: Test MCP Imagen4 Debug

on:
  workflow_dispatch:

jobs:
  test-mcp-debug:
    runs-on: ubuntu-latest
    environment: GA
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Create test directory
        run: |
          mkdir -p test-output/images
          echo "Test directory created" > test-output/test.txt
        
      - name: Debug Claude + MCP Setup
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            ãƒ‡ãƒãƒƒã‚°ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
            
            1. MCPã‚µãƒ¼ãƒãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèª:
               - åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«ã‚’ãƒªã‚¹ãƒˆ
               - mcp__gemini-imagen__list_models ã‚’å®Ÿè¡Œã—ã¦ãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—
            
            2. ãƒ†ã‚¹ãƒˆç”»åƒç”Ÿæˆ:
               - ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€Œé’ã„ç©ºã¨ç™½ã„é›²ã€ã§ç”»åƒã‚’ç”Ÿæˆ
               - mcp__gemini-imagen__generate_image ã‚’ä½¿ç”¨
            
            3. çµæžœã®è¨˜éŒ²:
               - test-output/debug_log.txt ã«ã™ã¹ã¦ã®å®Ÿè¡Œçµæžœã‚’è¨˜éŒ²
               - ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨˜éŒ²
            
            å„ã‚¹ãƒ†ãƒƒãƒ—ã®å®Ÿè¡Œçµæžœã‚’è©³ç´°ã«å ±å‘Šã—ã¦ãã ã•ã„ã€‚
          
          mcp_config: |
            {
              "mcpServers": {
                "gemini-imagen": {
                  "command": "npx",
                  "args": [
                    "-y", 
                    "gemini-imagen-mcp-server",
                    "--model", "imagen-4",
                    "--debug"
                  ],
                  "env": {
                    "GEMINI_API_KEY": "${{ secrets.GEMINI_API_KEY }}",
                    "DEBUG": "true"
                  }
                }
              }
            }
          
          allowed_tools: |
            View,
            Write,
            mcp__gemini-imagen__generate_image,
            mcp__gemini-imagen__list_models
          
          max_turns: "10"
          
      - name: Check debug results
        if: always()
        run: |
          echo "=== Debug Results ==="
          if [ -f "test-output/debug_log.txt" ]; then
            echo "Debug log found:"
            cat test-output/debug_log.txt
          else
            echo "No debug log found"
          fi
          
          echo ""
          echo "=== Directory contents ==="
          ls -la test-output/ || echo "test-output directory not found"
          
          echo ""
          echo "=== Environment check ==="
          echo "GEMINI_API_KEY exists: ${{ secrets.GEMINI_API_KEY != '' }}"
          
      - name: Alternative test - Direct Gemini check
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "=== Testing Gemini API directly ==="
          
          # Test if Gemini API key works
          curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1/models?key=${GEMINI_API_KEY}" \
            -H "Content-Type: application/json" \
            > gemini_test.json || echo "Gemini API test failed"
          
          if [ -f gemini_test.json ]; then
            echo "Gemini API response:"
            cat gemini_test.json | head -20
          fi
          
      - name: Create detailed summary
        if: always()
        run: |
          echo "## ðŸ” MCP Imagen4 Debug Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment" >> $GITHUB_STEP_SUMMARY
          echo "- GEMINI_API_KEY configured: ${{ secrets.GEMINI_API_KEY != '' }}" >> $GITHUB_STEP_SUMMARY
          echo "- ANTHROPIC_API_KEY configured: ${{ secrets.ANTHROPIC_API_KEY != '' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "test-output/debug_log.txt" ]; then
            echo "### Debug Log" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat test-output/debug_log.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ No debug log generated" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-mcp-imagen-${{ github.run_number }}
          path: |
            test-output/
            gemini_test.json
          retention-days: 7