name: Article Generation V4 (Simplified Output)

on:
  workflow_dispatch:
    inputs:
      article_title:
        description: 'ã‚¿ã‚¤ãƒˆãƒ«æ¡ˆï¼ˆ30ã€œ32å­—ï¼‰'
        required: true
        type: string
        default: ''
      
      main_keywords:
        description: 'ä¸»è¦KWï¼ˆæœ€å¤§3èªã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰'
        required: true
        type: string
        default: ''
      
      approach_target:
        description: 'åˆ‡ã‚Šå£ãƒ»ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ'
        required: true
        type: string
        default: ''
      
      eeat_elements:
        description: 'E-E-A-Tè¦ç´ ï¼ˆExperience, Expertise, Authoritativeness, Trustworthinessï¼‰'
        required: true
        type: string
        default: ''
      
      word_count:
        description: 'ç›®æ¨™æ–‡å­—æ•°'
        required: false
        type: string
        default: '3200'
      
      enable_image_generation:
        description: 'ç”»åƒç”Ÿæˆã‚’æœ‰åŠ¹ã«ã™ã‚‹'
        required: false
        type: boolean
        default: true
      
      # Google Drive upload removed

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ã‚¸ãƒ§ãƒ–1: åˆæœŸåŒ–
  initialize:
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 5
    outputs:
      article_id: ${{ steps.init.outputs.article_id }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize article generation
        id: init
        run: |
          # ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰IDã‚’ç”Ÿæˆ
          CLEAN_TITLE=$(echo "${{ inputs.article_title }}" | sed 's/[^a-zA-Z0-9ã‚-ã‚“ã‚¢-ãƒ³ä¸€-é¾¯]/_/g' | cut -c1-50)
          ARTICLE_ID=$(date +%Y%m%d_%H%M%S)_${CLEAN_TITLE}
          echo "article_id=${ARTICLE_ID}" >> $GITHUB_OUTPUT
          echo "Article ID: ${ARTICLE_ID}"
          
          # å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p output/${ARTICLE_ID}
          
          # å…¥åŠ›æƒ…å ±ã‚’ä¿å­˜
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          echo '{' > "output/${ARTICLE_ID}/input_params.json"
          echo "  \"article_id\": \"${ARTICLE_ID}\"," >> "output/${ARTICLE_ID}/input_params.json"
          echo "  \"title\": \"${{ inputs.article_title }}\"," >> "output/${ARTICLE_ID}/input_params.json"
          echo "  \"main_keywords\": \"${{ inputs.main_keywords }}\"," >> "output/${ARTICLE_ID}/input_params.json"
          echo "  \"approach_target\": \"${{ inputs.approach_target }}\"," >> "output/${ARTICLE_ID}/input_params.json"
          echo "  \"eeat_elements\": \"${{ inputs.eeat_elements }}\"," >> "output/${ARTICLE_ID}/input_params.json"
          echo "  \"word_count\": \"${{ inputs.word_count }}\"," >> "output/${ARTICLE_ID}/input_params.json"
          echo "  \"created_at\": \"${TIMESTAMP}\"" >> "output/${ARTICLE_ID}/input_params.json"
          echo '}' >> "output/${ARTICLE_ID}/input_params.json"

      - name: Upload initialization artifacts
        uses: actions/upload-artifact@v4
        with:
          name: init-${{ steps.init.outputs.article_id }}
          path: output/${{ steps.init.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–2: ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ†æ
  analysis:
    needs: initialize
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 10
    outputs:
      main_keyword: ${{ steps.analyze.outputs.main_keyword }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download initialization artifacts
        uses: actions/download-artifact@v4
        with:
          name: init-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd github-actions
          pip install -r requirements.txt

      - name: Create analysis input
        run: |
          cd output/${{ needs.initialize.outputs.article_id }}
          # Phase1ãŒæœŸå¾…ã™ã‚‹å½¢å¼ã®JSONã‚’ä½œæˆ
          echo '{' > request_params.json
          echo "  \"topic\": \"${{ inputs.article_title }}\"," >> request_params.json
          echo "  \"main_keywords\": \"${{ inputs.main_keywords }}\"," >> request_params.json
          echo "  \"approach_target\": \"${{ inputs.approach_target }}\"," >> request_params.json
          echo "  \"eeat_elements\": \"${{ inputs.eeat_elements }}\"," >> request_params.json
          echo "  \"word_count\": \"${{ inputs.word_count }}\"" >> request_params.json
          echo '}' >> request_params.json

      - name: Run Phase 1 Analysis with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt_file: Prompt_v2/CHAT_01_phase1_analysis.md
          
          allowed_tools: |
            Read,
            Write
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
            ARTICLE_TITLE=${{ inputs.article_title }}
            MAIN_KEYWORDS=${{ inputs.main_keywords }}
            APPROACH_TARGET=${{ inputs.approach_target }}
            EEAT_ELEMENTS=${{ inputs.eeat_elements }}
            WORD_COUNT=${{ inputs.word_count }}
          
          max_turns: "5"
      
      - name: Verify and prepare analysis results
        run: |
          echo "ğŸ” Checking for analysis files..."
          echo "Current working directory: $(pwd)"
          echo "Files in root:"
          ls -la
          echo "Files in output directory:"
          ls -la output/${{ needs.initialize.outputs.article_id }}/
          
          cd output/${{ needs.initialize.outputs.article_id }}
          if [ -f "phase1_output.json" ]; then
            echo "âœ… Phase 1 analysis file found"
            cat phase1_output.json
          else
            echo "âš ï¸ Phase 1 analysis file not found, creating default"
            # Check if file was created in root directory by mistake
            if [ -f "../../phase1_output.json" ]; then
              echo "ğŸ“ Found phase1_output.json in root, moving to correct location"
              mv ../../phase1_output.json ./phase1_output.json
            else
              echo "ğŸ”§ Creating fallback analysis file"
              # Create fallback analysis if Claude didn't create the file
              TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
              TITLE="${{ inputs.article_title }}"
              APPROACH="${{ inputs.approach_target }}"
              KEYWORDS="${{ inputs.main_keywords }}"
              EEAT="${{ inputs.eeat_elements }}"
              
              # å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦JSONã‚’ä½œæˆ
              TITLE="${TITLE}" APPROACH="${APPROACH}" KEYWORDS="${KEYWORDS}" EEAT="${EEAT}" TIMESTAMP="${TIMESTAMP}" OUTPUT_DIR="." python3 ../../github-actions/scripts/create_phase1_fallback.py
            fi
          fi
          
          echo "ğŸ“‹ Final verification - files in current directory:"
          ls -la

      - name: Split research queries into batches
        id: analyze
        run: |
          # ã‚¯ã‚¨ãƒªã‚’5ãƒãƒƒãƒã«åˆ†å‰²
          cd output/${{ needs.initialize.outputs.article_id }}
          python3 ../../github-actions/scripts/split_research_queries.py
          
          # ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å‡ºåŠ›
          if [ -f "research_meta.json" ]; then
            MAIN_KW=$(python -c "import json; print(json.load(open('research_meta.json'))['main_keyword'])")
            echo "main_keyword=${MAIN_KW}" >> $GITHUB_OUTPUT
          fi
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ENABLE_GEMINI_RESEARCH: "true"

      - name: Upload analysis artifacts
        uses: actions/upload-artifact@v4
        with:
          name: analysis-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–3: ãƒªã‚µãƒ¼ãƒï¼ˆGeminiä½¿ç”¨ - ä¸¦åˆ—å®Ÿè¡Œï¼‰
  research:
    needs: [initialize, analysis]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 15
    strategy:
      matrix:
        batch: [0, 1, 2]  # Reduced to 3 batches to match max-parallel
      max-parallel: 3  # Balanced for rate limiting with gemini-2.5-flash
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download initialization artifacts
        uses: actions/download-artifact@v4
        with:
          name: init-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}

      - name: Download analysis artifacts
        uses: actions/download-artifact@v4
        with:
          name: analysis-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd github-actions
          pip install -r requirements.txt
          
      - name: Install Gemini API dependencies  
        run: |
          pip install google-genai

      - name: Research with Gemini (Batch ${{ matrix.batch }})
        run: |
          cd output/${{ needs.initialize.outputs.article_id }}
          
          # ãƒãƒƒãƒç”¨ã®åˆ†æãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          BATCH_NUM=${{ matrix.batch }} python3 ../../github-actions/scripts/create_batch_analysis.py
          
          # ãƒãƒƒãƒã‚¯ã‚¨ãƒªã‚’èª­ã¿è¾¼ã‚“ã§Gemini APIã§ç›´æ¥æ¤œç´¢ï¼ˆå¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½¿ç”¨ï¼‰
          python3 ../../github-actions/scripts/research_batch_gemini.py ${{ matrix.batch }}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Upload research batch artifacts
        uses: actions/upload-artifact@v4
        with:
          name: research-batch-${{ matrix.batch }}-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}/batch_${{ matrix.batch }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–4: ãƒªã‚µãƒ¼ãƒçµæœã®çµ±åˆ
  research-merge:
    needs: [initialize, research]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create output directory
        run: mkdir -p output/${{ needs.initialize.outputs.article_id }}

      - name: Download all research batches
        uses: actions/download-artifact@v4
        with:
          pattern: research-batch-*-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}/batches

      - name: Download analysis artifacts
        uses: actions/download-artifact@v4
        with:
          name: analysis-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}

      - name: Merge research results
        run: |
          cd output/${{ needs.initialize.outputs.article_id }}
          
          # ãƒªã‚µãƒ¼ãƒçµæœã‚’çµ±åˆã—ã¦V4å‡ºåŠ›å½¢å¼ã«ã™ã‚‹
          python3 ../../github-actions/scripts/merge_research_results.py
          
          # V4ç”¨ã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´
          if [ -f "phase2_research.json" ]; then
            mv phase2_research.json research_results.json
            echo "âœ… Created research_results.json for V4"
          fi

      - name: Upload merged research artifacts
        uses: actions/upload-artifact@v4
        with:
          name: research-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–5: è¨˜äº‹æ§‹æˆã®ç”Ÿæˆï¼ˆSEOå‰Šé™¤ç‰ˆï¼‰
  generate-structure:
    needs: [initialize, analysis, research-merge]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 15
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: Generate article structure with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt_file: Prompt_v2/CHAT_02_structure_generation.md
          
          allowed_tools: |
            Read,
            Write,
            Edit
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
            ARTICLE_TITLE=${{ inputs.article_title }}
            MAIN_KEYWORDS=${{ inputs.main_keywords }}
            APPROACH_TARGET=${{ inputs.approach_target }}
            EEAT_ELEMENTS=${{ inputs.eeat_elements }}
            WORD_COUNT=${{ inputs.word_count }}
          
          max_turns: "10"

      - name: Upload structure artifacts
        uses: actions/upload-artifact@v4
        with:
          name: structure-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–6: è¨˜äº‹æœ¬æ–‡ã®ç”Ÿæˆï¼ˆMDå°‚ç”¨ï¼‰
  generate-content:
    needs: [initialize, generate-structure]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 20
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: Generate article content with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt_file: Prompt_v2/CHAT_03_content_generation_v2.md
          
          allowed_tools: |
            Read,
            Write,
            Edit
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
            ARTICLE_TITLE=${{ inputs.article_title }}
            MAIN_KEYWORDS=${{ inputs.main_keywords }}
            APPROACH_TARGET=${{ inputs.approach_target }}
            EEAT_ELEMENTS=${{ inputs.eeat_elements }}
            WORD_COUNT=${{ inputs.word_count }}
          
          max_turns: "15"

      - name: Verify article generation with fallback
        id: verify-article
        run: |
          ARTICLE_DIR="output/${{ needs.initialize.outputs.article_id }}"
          echo "ğŸ” Checking for generated article file..."
          
          if [ -f "$ARTICLE_DIR/final_article.html" ]; then
            echo "âœ… Found final_article.html"
            echo "article_found=true" >> $GITHUB_OUTPUT
            echo "fallback_used=false" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Primary generation failed, checking for fallback..."
            echo "ğŸ“ Contents of $ARTICLE_DIR:"
            ls -la "$ARTICLE_DIR/" || echo "Directory not found"
            
            # Check if any HTML file exists
            if [ -f "$ARTICLE_DIR/article.html" ]; then
              mv "$ARTICLE_DIR/article.html" "$ARTICLE_DIR/final_article.html"
              echo "âœ… Found article.html, renamed to final_article.html"
              echo "article_found=true" >> $GITHUB_OUTPUT
              echo "fallback_used=false" >> $GITHUB_OUTPUT
            else
              echo "âŒ ERROR: No HTML article generated!"
              echo "article_found=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      - name: Upload content artifacts
        uses: actions/upload-artifact@v4
        with:
          name: content-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–7: ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆå“è³ªã‚¹ã‚³ã‚¢ä»˜ãï¼‰
  factcheck:
    needs: [initialize, generate-content]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: Debug - Check files before factcheck
        run: |
          echo "ğŸ“ Files before factcheck:"
          ls -la output/${{ needs.initialize.outputs.article_id }}/
          echo ""
          echo "ğŸ”§ Environment variables:"
          echo "ARTICLE_ID: ${{ needs.initialize.outputs.article_id }}"
          echo "WORKSPACE: ${{ github.workspace }}"
          echo "Expected factcheck path: ${{ github.workspace }}/output/${{ needs.initialize.outputs.article_id }}/factcheck_report.json"
          echo ""
          echo "ğŸ“„ Checking final_article.md:"
          if [ -f "output/${{ needs.initialize.outputs.article_id }}/final_article.md" ]; then
            echo "âœ… final_article.md exists"
            wc -l output/${{ needs.initialize.outputs.article_id }}/final_article.md
          else
            echo "âŒ final_article.md NOT found"
          fi
          echo ""
          echo "ğŸ“„ Checking research_results.json:"
          if [ -f "output/${{ needs.initialize.outputs.article_id }}/research_results.json" ]; then
            echo "âœ… research_results.json exists"
            wc -l output/${{ needs.initialize.outputs.article_id }}/research_results.json
          else
            echo "âŒ research_results.json NOT found"
          fi

      - name: Fact-check article with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt_file: Prompt_v2/CHAT_04_factcheck.md
          
          allowed_tools: |
            Read,
            Write,
            Edit
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
            ARTICLE_TITLE=${{ inputs.article_title }}
            MAIN_KEYWORDS=${{ inputs.main_keywords }}
            APPROACH_TARGET=${{ inputs.approach_target }}
            EEAT_ELEMENTS=${{ inputs.eeat_elements }}
            WORKSPACE=${{ github.workspace }}
          
          max_turns: "10"

      - name: Debug - Check Claude execution
        run: |
          echo "ğŸ” Post-Claude execution check:"
          echo "Working directory: $(pwd)"
          echo ""
          echo "ğŸ“ All files in output directory after Claude:"
          ls -la output/${{ needs.initialize.outputs.article_id }}/
          echo ""
          echo "ğŸ” Looking for any JSON files created:"
          find output/${{ needs.initialize.outputs.article_id }}/ -name "*.json" -type f

      - name: Verify factcheck output
        run: |
          echo "ğŸ” Checking factcheck output..."
          if [ -f "output/${{ needs.initialize.outputs.article_id }}/factcheck_report.json" ]; then
            echo "âœ… factcheck_report.json created successfully"
            ls -la output/${{ needs.initialize.outputs.article_id }}/factcheck_report.json
          else
            echo "âŒ factcheck_report.json NOT found!"
            echo "ğŸ“ Contents of output directory:"
            ls -la output/${{ needs.initialize.outputs.article_id }}/ || echo "Directory not found"
          fi

      - name: Upload factcheck artifacts
        uses: actions/upload-artifact@v4
        with:
          name: factcheck-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–8: SEOãƒ¡ã‚¿æƒ…å ±ç”Ÿæˆ
  generate-seo-meta:
    needs: [initialize, analysis, generate-content]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: Debug - Check files before SEO
        run: |
          echo "ğŸ“ Files before SEO metadata generation:"
          ls -la output/${{ needs.initialize.outputs.article_id }}/
          echo ""
          echo "ğŸ”§ Environment variables:"
          echo "ARTICLE_ID: ${{ needs.initialize.outputs.article_id }}"
          echo "WORKSPACE: ${{ github.workspace }}"
          echo "Expected SEO path: ${{ github.workspace }}/output/${{ needs.initialize.outputs.article_id }}/seo_metadata.json"
          echo ""
          echo "ğŸ“„ Checking required files:"
          for file in final_article.md input_params.json phase1_output.json; do
            if [ -f "output/${{ needs.initialize.outputs.article_id }}/$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file NOT found"
            fi
          done

      - name: Generate SEO metadata with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt_file: Prompt_v2/CHAT_05_seo_metadata.md
          
          allowed_tools: |
            Read,
            Write
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
            ARTICLE_TITLE=${{ inputs.article_title }}
            MAIN_KEYWORDS=${{ inputs.main_keywords }}
            APPROACH_TARGET=${{ inputs.approach_target }}
            EEAT_ELEMENTS=${{ inputs.eeat_elements }}
            WORD_COUNT=${{ inputs.word_count }}
            WORKSPACE=${{ github.workspace }}
          
          max_turns: "30"

      - name: Debug - Check Claude execution for SEO
        run: |
          echo "ğŸ” Post-Claude SEO execution check:"
          echo "Working directory: $(pwd)"
          echo ""
          echo "ğŸ“ All files in output directory after Claude SEO:"
          ls -la output/${{ needs.initialize.outputs.article_id }}/
          echo ""
          echo "ğŸ” Looking for any JSON files created:"
          find output/${{ needs.initialize.outputs.article_id }}/ -name "*.json" -type f

      - name: Verify SEO metadata output
        run: |
          echo "ğŸ” Checking SEO metadata output..."
          if [ -f "output/${{ needs.initialize.outputs.article_id }}/seo_metadata.json" ]; then
            echo "âœ… seo_metadata.json created successfully"
            ls -la output/${{ needs.initialize.outputs.article_id }}/seo_metadata.json
          else
            echo "âŒ seo_metadata.json NOT found!"
            echo "ğŸ“ Contents of output directory:"
            ls -la output/${{ needs.initialize.outputs.article_id }}/ || echo "Directory not found"
          fi

      - name: Upload SEO metadata artifacts
        uses: actions/upload-artifact@v4
        with:
          name: seo-meta-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–9: ç”»åƒç”Ÿæˆï¼ˆMCP + Imagen4ï¼‰
  generate-images:
    if: ${{ inputs.enable_image_generation }}
    needs: [initialize, generate-structure]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 20
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: Generate Images with Claude + MCP Imagen4
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            è¨˜äº‹ã«æœ€é©ãªç”»åƒã‚’è¤‡æ•°æšç”Ÿæˆã—ã¦ãã ã•ã„ã€‚åˆè¨ˆ4-5æšã®ç”»åƒã‚’ç”Ÿæˆã—ã¾ã™ã€‚
            
            ã‚¿ã‚¹ã‚¯:
            1. è¨˜äº‹å†…å®¹ã‚’ç†è§£:
               - input_params.json ã§ãƒšãƒ«ã‚½ãƒŠã‚’ç¢ºèª
               - final_article.md ã§è¨˜äº‹å†…å®¹ã‚’æŠŠæ¡ï¼ˆã‚ã‚Œã°ï¼‰
               - 01_article_structure.md ã§æ§‹æˆã‚’ç†è§£
            
            2. ä»¥ä¸‹ã®æ‰‹é †ã§å€‹åˆ¥ã«ç”»åƒã‚’ç”Ÿæˆ:
               
               **ã‚¹ãƒ†ãƒƒãƒ—1**: ãƒ’ãƒ¼ãƒ­ãƒ¼ç”»åƒï¼ˆ16:9ï¼‰ã‚’ç”Ÿæˆ
               - mcp__gemini-imagen__generate_image ã‚’ä½¿ç”¨
               - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: "è¨˜äº‹å…¨ä½“ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’è¡¨ç¾ã™ã‚‹16:9ã®ãƒ’ãƒ¼ãƒ­ãƒ¼ç”»åƒ"
               - ãƒšãƒ«ã‚½ãƒŠã«åˆã‚ã›ãŸãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«
               
               **ã‚¹ãƒ†ãƒƒãƒ—2**: ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”»åƒ1ï¼ˆ4:3ï¼‰ã‚’ç”Ÿæˆ  
               - mcp__gemini-imagen__generate_image ã‚’ä½¿ç”¨
               - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: "è¨˜äº‹ã®å°å…¥éƒ¨åˆ†ã‚’è¡¨ç¾ã™ã‚‹4:3ã®ç”»åƒ"
               
               **ã‚¹ãƒ†ãƒƒãƒ—3**: ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”»åƒ2ï¼ˆ4:3ï¼‰ã‚’ç”Ÿæˆ
               - mcp__gemini-imagen__generate_image ã‚’ä½¿ç”¨  
               - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: "è¨˜äº‹ã®æ–¹æ³•ãƒ»æ‰‹é †éƒ¨åˆ†ã‚’è¡¨ç¾ã™ã‚‹4:3ã®ç”»åƒ"
               
               **ã‚¹ãƒ†ãƒƒãƒ—4**: ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”»åƒ3ï¼ˆ4:3ï¼‰ã‚’ç”Ÿæˆ
               - mcp__gemini-imagen__generate_image ã‚’ä½¿ç”¨
               - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: "è¨˜äº‹ã®çµæœãƒ»åŠ¹æœéƒ¨åˆ†ã‚’è¡¨ç¾ã™ã‚‹4:3ã®ç”»åƒ"
               
               **ã‚¹ãƒ†ãƒƒãƒ—5**: ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”»åƒ4ï¼ˆ4:3ï¼‰ã‚’ç”Ÿæˆ
               - mcp__gemini-imagen__generate_image ã‚’ä½¿ç”¨
               - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: "è¨˜äº‹ã®ã¾ã¨ã‚éƒ¨åˆ†ã‚’è¡¨ç¾ã™ã‚‹4:3ã®ç”»åƒ"
            
            3. ç”»åƒç”Ÿæˆã®æ–¹é‡ï¼ˆå…¨ç”»åƒå…±é€šï¼‰:
               - ãƒšãƒ«ã‚½ãƒŠã®å¹´ä»£ãƒ»æ€§åˆ¥ã«åˆã‚ã›ãŸãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«
               - æ¸…æ½”æ„Ÿã¨ä¿¡é ¼æ„Ÿã®ã‚ã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³
               - è¨˜äº‹å†…å®¹ã¨èª¿å’Œã—ãŸã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
               - ãƒ†ã‚­ã‚¹ãƒˆã‚„ãƒ­ã‚´ã¯å«ã¾ãªã„
               - imagen-4 ã¾ãŸã¯ imagen-4-ultra ã‚’ä½¿ç”¨
            
            4. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä½œæˆ:
               - images/metadata.json ã«ç”Ÿæˆæƒ…å ±ã‚’è¨˜éŒ²
               - å„ç”»åƒã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€ç”¨é€”ã€ã‚µã‚¤ã‚ºã‚’è¨˜è¼‰
               
            é‡è¦: å¿…ãš5å›ã®mcp__gemini-imagen__generate_imageã‚’å®Ÿè¡Œã—ã¦ã€è¤‡æ•°æšã®ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
          
          mcp_config: |
            {
              "mcpServers": {
                "gemini-imagen": {
                  "command": "npx",
                  "args": [
                    "-y", 
                    "gemini-imagen-mcp-server",
                    "--model", "imagen-4"
                  ],
                  "env": {
                    "GEMINI_API_KEY": "${{ secrets.GEMINI_API_KEY }}"
                  }
                }
              }
            }
          
          allowed_tools: |
            Read,
            Write,
            mcp__gemini-imagen__generate_image,
            mcp__gemini-imagen__list_models
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
          
          max_turns: "30"

      - name: Process generated images
        run: |
          ARTICLE_DIR="output/${{ needs.initialize.outputs.article_id }}"
          IMAGE_DIR="${ARTICLE_DIR}/images"
          
          # MCPã‚µãƒ¼ãƒãƒ¼ã¯ imagen/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã™ã‚‹
          if [ -d "imagen" ] && [ "$(ls -A imagen 2>/dev/null)" ]; then
            echo "âœ… Images found in imagen directory:"
            ls -la imagen/
            
            # ç”»åƒã‚’è¨˜äº‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
            mkdir -p $IMAGE_DIR
            cp imagen/*.png $IMAGE_DIR/ 2>/dev/null || true
            cp imagen/*.jpg $IMAGE_DIR/ 2>/dev/null || true
            
            # ãƒªãƒãƒ¼ãƒ ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            cd $IMAGE_DIR
            i=1
            for img in *.png *.jpg; do
              if [ -f "$img" ]; then
                if [ $i -eq 1 ]; then
                  mv "$img" "hero_image.png" 2>/dev/null || true
                else
                  mv "$img" "section_$((i-1))_image.png" 2>/dev/null || true
                fi
                i=$((i+1))
              fi
            done
            cd -
            
            echo "Final images:"
            ls -la $IMAGE_DIR
          else
            echo "âš ï¸ No images generated"
          fi

      - name: Upload image artifacts
        uses: actions/upload-artifact@v4
        with:
          name: images-${{ needs.initialize.outputs.article_id }}
          path: |
            output/${{ needs.initialize.outputs.article_id }}/images
            imagen/
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–10: æœ€çµ‚å‡¦ç†ï¼ˆ5ã¤ã®æˆæœç‰©ï¼‰
  finalize:
    needs: [initialize, analysis, research-merge, generate-structure, generate-content, factcheck, generate-seo-meta, generate-images]
    if: always()
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: Create final package with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt_file: Prompt_v2/CHAT_06_finalize.md
          
          allowed_tools: |
            Read,
            Write,
            Edit
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
            ARTICLE_TITLE=${{ inputs.article_title }}
            MAIN_KEYWORDS=${{ inputs.main_keywords }}
            APPROACH_TARGET=${{ inputs.approach_target }}
            EEAT_ELEMENTS=${{ inputs.eeat_elements }}
            WORD_COUNT=${{ inputs.word_count }}
          
          max_turns: "10"

      # Google Drive upload removed - using GitHub Artifacts only

      - name: Create workflow summary
        if: always()
        run: |
          ARTICLE_DIR="output/${{ needs.initialize.outputs.article_id }}"
          
          echo "## ğŸ“ Article Generation V4 Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Input Parameters" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¿ã‚¤ãƒˆãƒ«æ¡ˆ**: ${{ inputs.article_title }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¸»è¦KW**: ${{ inputs.main_keywords }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ‡ã‚Šå£ãƒ»ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ**: ${{ inputs.approach_target }}" >> $GITHUB_STEP_SUMMARY
          echo "- **E-E-A-Tè¦ç´ **: ${{ inputs.eeat_elements }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ¯ V4 Deliverables (Prompt_v2æº–æ‹ )" >> $GITHUB_STEP_SUMMARY
          echo "1. **research_results.json** - Research data with reliability scores" >> $GITHUB_STEP_SUMMARY
          echo "2. **factcheck_report.json** - Quality scores and fact-checking results" >> $GITHUB_STEP_SUMMARY
          echo "3. **seo_metadata.json** - SEO metadata (keywords, meta description, etc.)" >> $GITHUB_STEP_SUMMARY
          echo "4. **final_article.html** - HTML article with embedded styling" >> $GITHUB_STEP_SUMMARY
          echo "5. **deliverables_summary.md** - Complete package summary" >> $GITHUB_STEP_SUMMARY
          echo "6. **images/** - Generated images (optional)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "$ARTICLE_DIR/V4_deliverables.md" ]; then
            echo "### ğŸ“Š Generation Summary" >> $GITHUB_STEP_SUMMARY
            cat "$ARTICLE_DIR/V4_deliverables.md" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "$ARTICLE_DIR/images" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ–¼ï¸ Generated Images" >> $GITHUB_STEP_SUMMARY
            echo "- Image count: $(find $ARTICLE_DIR/images -name "*.png" -o -name "*.jpg" | wc -l)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create organized final package
        run: |
          ARTICLE_DIR="output/${{ needs.initialize.outputs.article_id }}"
          FINAL_DIR="final_package"
          
          # è©³ç´°ãƒ‡ãƒãƒƒã‚°: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo "====== FINAL PACKAGE CREATION DEBUG ======"
          echo "ğŸ” ARTICLE_DIR: $ARTICLE_DIR"
          echo "ğŸ“ Article directory check:"
          [ -d "$ARTICLE_DIR" ] && echo "âœ… Directory exists" || echo "âŒ Directory NOT found"
          
          echo ""
          echo "ğŸ“‹ All downloaded artifacts and files:"
          find . -name "*.json" -o -name "*.md" -o -name "*.png" -o -name "*.jpg" | head -20
          
          echo ""
          echo "ğŸ–¼ï¸ Specifically looking for images:"
          echo "PNG files:"
          find . -name "*.png" -type f 2>/dev/null | head -10
          echo "JPG files:"
          find . -name "*.jpg" -o -name "*.jpeg" -type f 2>/dev/null | head -10
          echo ""
          echo "Image directories:"
          find . -name "images" -type d 2>/dev/null
          find . -name "imagen" -type d 2>/dev/null
          
          echo ""
          echo "ğŸ” Current working directory contents:"
          ls -la
          
          echo ""
          echo "ğŸ” Specifically looking for factcheck and SEO files:"
          echo "Factcheck files:"
          find . -name "*factcheck*" -type f 2>/dev/null || echo "No factcheck files found"
          echo "SEO files:"
          find . -name "*seo*" -type f 2>/dev/null || echo "No SEO files found"
          
          echo ""
          echo "ğŸ” Output directory contents:"
          if [ -d "output/" ]; then
            find output/ -type f | head -20
          else
            echo "âŒ No output directory found"
          fi
          
          echo "=============================================="
          
          # æœ€çµ‚ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p $FINAL_DIR
          
          # V4ã®4ã¤ã®æˆæœç‰©ã‚’åé›†ï¼ˆã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰ç›´æ¥ï¼‰
          echo ""
          echo "ğŸ”„ Collecting V4 deliverables from artifacts..."
          
          # 1. ãƒ¡ã‚¤ãƒ³è¨˜äº‹ (HTML) - ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰æ¤œç´¢
          ARTICLE_FOUND=false
          
          # è¤‡æ•°ã®å ´æ‰€ã‹ã‚‰è¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ï¼ˆPrompt_v2æº–æ‹ ï¼‰
          POSSIBLE_ARTICLES=(
            "$ARTICLE_DIR/final_article.html"
            "$ARTICLE_DIR/article.html"
            "final_article.html"
            "article.html"
          )
          
          for article_path in "${POSSIBLE_ARTICLES[@]}"; do
            if [ -f "$article_path" ]; then
              cp "$article_path" "$FINAL_DIR/final_article.html"
              echo "âœ… Found and copied article: $article_path ($(wc -c < "$article_path") bytes)"
              ARTICLE_FOUND=true
              break
            fi
          done
          
          # è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯.htmlãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
          if [ "$ARTICLE_FOUND" = false ]; then
            echo "âš ï¸ Standard article files not found, searching for any .html files..."
            HTML_FILE=$(find . -name "*.html" -type f ! -name "index.html" | head -1)
            if [ -n "$HTML_FILE" ]; then
              cp "$HTML_FILE" "$FINAL_DIR/final_article.html"
              echo "âœ… Using fallback .html file: $HTML_FILE ($(wc -c < "$HTML_FILE") bytes)"
              ARTICLE_FOUND=true
            fi
          fi
          
          if [ "$ARTICLE_FOUND" = false ]; then
            echo "âŒ ERROR: No article file found in any location!"
            echo "Creating minimal article as last resort..."
            echo '<div class="article-content"><h2>è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼</h2><p>è¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p></div>' > "$FINAL_DIR/final_article.html"
          fi
          
          # 2. ãƒªã‚µãƒ¼ãƒçµæœ - è¤‡æ•°ã®å ´æ‰€ã‹ã‚‰æ¤œç´¢
          RESEARCH_LOCATIONS=(
            "$ARTICLE_DIR/research_results.json"
            "research_results.json"
            "research-*.json"
          )
          
          RESEARCH_FOUND=false
          for loc in "${RESEARCH_LOCATIONS[@]}"; do
            if [ -f "$loc" ]; then
              cp "$loc" "$FINAL_DIR/research_results.json"
              echo "âœ… Found research results: $loc"
              RESEARCH_FOUND=true
              break
            fi
          done
          
          if [ "$RESEARCH_FOUND" = false ]; then
            # æ¤œç´¢ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨
            RESEARCH_FILE=$(find . -name "*research*.json" | head -1)
            if [ -n "$RESEARCH_FILE" ]; then
              cp "$RESEARCH_FILE" "$FINAL_DIR/research_results.json"
              echo "âœ… Using research file: $RESEARCH_FILE"
            else
              echo "âš ï¸ No research results found"
            fi
          fi
          
          # 3. SEOãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ - è¤‡æ•°ã®å ´æ‰€ã‹ã‚‰æ¤œç´¢
          SEO_LOCATIONS=(
            "$ARTICLE_DIR/seo_metadata.json"
            "seo_metadata.json"
            "seo-*.json"
          )
          
          SEO_FOUND=false
          for loc in "${SEO_LOCATIONS[@]}"; do
            if [ -f "$loc" ]; then
              cp "$loc" "$FINAL_DIR/seo_metadata.json"
              echo "âœ… Found SEO metadata: $loc"
              SEO_FOUND=true
              break
            fi
          done
          
          if [ "$SEO_FOUND" = false ]; then
            echo "âš ï¸ No SEO metadata found"
            echo "ğŸ“ Searching for SEO metadata files..."
            find . -name "*seo*.json" -type f 2>/dev/null | head -10
          fi
          
          # 4. ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯å“è³ªãƒ¬ãƒãƒ¼ãƒˆ - è¤‡æ•°ã®å ´æ‰€ã‹ã‚‰æ¤œç´¢
          FACTCHECK_LOCATIONS=(
            "$ARTICLE_DIR/factcheck_report.json"
            "factcheck_report.json"
            "factcheck-*.json"
          )
          
          FACTCHECK_FOUND=false
          for loc in "${FACTCHECK_LOCATIONS[@]}"; do
            if [ -f "$loc" ]; then
              cp "$loc" "$FINAL_DIR/factcheck_report.json"
              echo "âœ… Found factcheck report: $loc"
              FACTCHECK_FOUND=true
              break
            fi
          done
          
          if [ "$FACTCHECK_FOUND" = false ]; then
            # æ¤œç´¢ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨
            FACTCHECK_FILE=$(find . -name "*factcheck*.json" | head -1)
            if [ -n "$FACTCHECK_FILE" ]; then
              cp "$FACTCHECK_FILE" "$FINAL_DIR/factcheck_report.json"
              echo "âœ… Using factcheck file: $FACTCHECK_FILE"
            else
              echo "âš ï¸ No factcheck report found"
              echo "ğŸ“ Searching for factcheck files..."
              find . -name "*factcheck*.json" -type f 2>/dev/null | head -10
            fi
          fi
          
          # 5. ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ - è¤‡æ•°ã®å ´æ‰€ã‹ã‚‰æ¤œç´¢
          mkdir -p "$FINAL_DIR/images"
          IMAGES_FOUND=false
          
          # æ¨™æº–çš„ãªç”»åƒãƒ•ã‚©ãƒ«ãƒ€ã®å ´æ‰€
          if [ -d "$ARTICLE_DIR/images" ]; then
            cp -r "$ARTICLE_DIR/images/"* "$FINAL_DIR/images/" 2>/dev/null || true
            echo "âœ… Found images in $ARTICLE_DIR/images"
            IMAGES_FOUND=true
          fi
          
          # imagen/ ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰ç”»åƒã‚’æ¤œç´¢ï¼ˆMCPç”»åƒç”Ÿæˆã®å ´æ‰€ï¼‰
          if [ -d "imagen" ]; then
            echo "ğŸ“ Checking imagen/ directory for MCP generated images..."
            cp imagen/*.png "$FINAL_DIR/images/" 2>/dev/null || true
            cp imagen/*.jpg "$FINAL_DIR/images/" 2>/dev/null || true
            if [ "$(ls -A imagen/*.png 2>/dev/null)" ] || [ "$(ls -A imagen/*.jpg 2>/dev/null)" ]; then
              echo "âœ… Found images in imagen/"
              IMAGES_FOUND=true
            fi
          fi
          
          # images-*/output/*/images/ ã‹ã‚‰ç”»åƒã‚’æ¤œç´¢ï¼ˆã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®æ§‹é€ ï¼‰
          IMAGE_ARTIFACT_PATHS=$(find . -path "*/images-*/output/*/images" -type d 2>/dev/null)
          if [ -n "$IMAGE_ARTIFACT_PATHS" ]; then
            for img_path in $IMAGE_ARTIFACT_PATHS; do
              echo "ğŸ“ Found image artifact path: $img_path"
              cp "$img_path"/*.png "$FINAL_DIR/images/" 2>/dev/null || true
              cp "$img_path"/*.jpg "$FINAL_DIR/images/" 2>/dev/null || true
              IMAGES_FOUND=true
            done
          fi
          
          # ç›´æ¥ output/*/images ã¾ãŸã¯ output/*/imagen ã‹ã‚‰æ¤œç´¢
          if [ -d "$ARTICLE_DIR/images" ] || [ -d "$ARTICLE_DIR/imagen" ]; then
            echo "ğŸ“ Checking output artifact directories..."
            [ -d "$ARTICLE_DIR/images" ] && cp -r "$ARTICLE_DIR/images/"* "$FINAL_DIR/images/" 2>/dev/null || true
            [ -d "$ARTICLE_DIR/imagen" ] && cp -r "$ARTICLE_DIR/imagen/"* "$FINAL_DIR/images/" 2>/dev/null || true
            IMAGES_FOUND=true
          fi
          
          # ãã®ä»–ã®å ´æ‰€ã‹ã‚‰ç”»åƒã‚’æ¤œç´¢ï¼ˆæœ€å¾Œã®æ‰‹æ®µï¼‰
          if [ "$IMAGES_FOUND" = false ]; then
            echo "âš ï¸ Standard image locations not found, searching all directories..."
            find . -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | while read img; do
              if [[ "$img" != *"README"* ]] && [[ "$img" != *"node_modules"* ]]; then
                cp "$img" "$FINAL_DIR/images/" 2>/dev/null || true
                echo "âœ… Found image: $img"
                IMAGES_FOUND=true
              fi
            done
          fi
          
          # ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ã®å†…å®¹ã‚’ç¢ºèª
          echo "ğŸ“ Final images directory contents:"
          ls -la "$FINAL_DIR/images/" 2>/dev/null || echo "No images directory created"
          
          
          # æˆæœç‰©èª¬æ˜æ›¸ï¼ˆPrompt_v2æº–æ‹ ï¼‰
          if [ -f "$ARTICLE_DIR/deliverables_summary.md" ]; then
            cp "$ARTICLE_DIR/deliverables_summary.md" "$FINAL_DIR/deliverables_summary.md"
          elif [ -f "$ARTICLE_DIR/V4_deliverables.md" ]; then
            cp "$ARTICLE_DIR/V4_deliverables.md" "$FINAL_DIR/deliverables_summary.md"
          fi
          
          # æœ€çµ‚ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å†…å®¹ç¢ºèª
          echo ""
          echo "ğŸ“¦ Final package contents:"
          find "$FINAL_DIR" -type f -exec ls -la {} \;
          
          # READMEä½œæˆ
          echo "# V4 è¨˜äº‹ç”Ÿæˆå®Œäº†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆPrompt_v2æº–æ‹ ï¼‰" > "$FINAL_DIR/README.md"
          echo "" >> "$FINAL_DIR/README.md"
          echo "**è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«**: ${{ inputs.article_title }}" >> "$FINAL_DIR/README.md"
          echo "**ç”Ÿæˆæ—¥æ™‚**: $(date +%Y-%m-%d\ %H:%M:%S)" >> "$FINAL_DIR/README.md"
          echo "**è¨˜äº‹ID**: ${{ needs.initialize.outputs.article_id }}" >> "$FINAL_DIR/README.md"
          echo "" >> "$FINAL_DIR/README.md"
          echo "## ğŸ“ æˆæœç‰©ï¼ˆPrompt_v2æº–æ‹ ï¼‰" >> "$FINAL_DIR/README.md"
          echo "" >> "$FINAL_DIR/README.md"
          echo "1. **final_article.html** - è¨˜äº‹æœ¬æ–‡ï¼ˆHTMLå½¢å¼ã€Prompt_v2ã‚¹ã‚¿ã‚¤ãƒ«æº–æ‹ ï¼‰" >> "$FINAL_DIR/README.md"
          echo "2. **research_results.json** - ãƒªã‚µãƒ¼ãƒçµæœï¼ˆä¿¡é ¼æ€§ã‚¹ã‚³ã‚¢ä»˜ãï¼‰" >> "$FINAL_DIR/README.md"
          echo "3. **factcheck_report.json** - ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯å“è³ªã‚¹ã‚³ã‚¢ï¼ˆ0-100ç‚¹ï¼‰" >> "$FINAL_DIR/README.md"
          echo "4. **seo_metadata.json** - SEOãƒ¡ã‚¿æƒ…å ±ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ãƒ¡ã‚¿ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç­‰ï¼‰" >> "$FINAL_DIR/README.md"
          echo "5. **deliverables_summary.md** - æˆæœç‰©èª¬æ˜æ›¸" >> "$FINAL_DIR/README.md"
          echo "6. **images/** - ç”Ÿæˆç”»åƒï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰" >> "$FINAL_DIR/README.md"
          echo "" >> "$FINAL_DIR/README.md"
          echo "## ğŸ¯ è¨˜äº‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿" >> "$FINAL_DIR/README.md"
          echo "" >> "$FINAL_DIR/README.md"
          echo "- **ä¸»è¦KW**: ${{ inputs.main_keywords }}" >> "$FINAL_DIR/README.md"
          echo "- **åˆ‡ã‚Šå£ãƒ»ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ**: ${{ inputs.approach_target }}" >> "$FINAL_DIR/README.md"
          echo "- **E-E-A-Tè¦ç´ **: ${{ inputs.eeat_elements }}" >> "$FINAL_DIR/README.md"
          echo "" >> "$FINAL_DIR/README.md"
          echo "## ğŸ“ å‚™è€ƒ" >> "$FINAL_DIR/README.md"
          echo "" >> "$FINAL_DIR/README.md"
          echo "- **final_article.html**: Prompt_v2/article-style.mdæº–æ‹ ã®HTML" >> "$FINAL_DIR/README.md"
          echo "- CSSã‚¯ãƒ©ã‚¹åã¯Prompt_v2ä»•æ§˜æ›¸ã«å¾“ã£ã¦è¨­å®š" >> "$FINAL_DIR/README.md"
          echo "- WordPressã®HTMLãƒ–ãƒ­ãƒƒã‚¯ã«ç›´æ¥è²¼ã‚Šä»˜ã‘å¯èƒ½" >> "$FINAL_DIR/README.md"
          echo "- ç”»åƒç”Ÿæˆã¯æœ‰åŠ¹åŒ–è¨­å®šã«ã‚ˆã‚Šç”Ÿæˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰" >> "$FINAL_DIR/README.md"
          
          echo "ğŸ“¦ V4 final package created in: $FINAL_DIR"
          ls -la $FINAL_DIR/

      - name: Upload final package
        uses: actions/upload-artifact@v4
        with:
          name: FINAL_V4_ARTICLE_PACKAGE
          path: final_package
          retention-days: 30

