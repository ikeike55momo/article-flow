name: Article Generation V4 (New Architecture)

on:
  workflow_dispatch:
    inputs:
      article_title:
        description: 'ã‚¿ã‚¤ãƒˆãƒ«æ¡ˆï¼ˆ30ã€œ32å­—ï¼‰'
        required: true
        type: string
        default: ''
      
      main_keywords:
        description: 'ä¸»è¦KWï¼ˆæœ€å¤§3èªã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰'
        required: true
        type: string
        default: ''
      
      approach_target:
        description: 'åˆ‡ã‚Šå£ãƒ»ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ'
        required: true
        type: string
        default: ''
      
      eeat_elements:
        description: 'E-E-A-Tè¦ç´ ï¼ˆExperience, Expertise, Authoritativeness, Trustworthinessï¼‰'
        required: true
        type: string
        default: ''
      
      word_count:
        description: 'ç›®æ¨™æ–‡å­—æ•°'
        required: false
        type: string
        default: '3200'
      
      profile:
        description: 'Strategy Profile'
        required: false
        type: choice
        options:
          - 'v2'
          - 'v3'
        default: 'v2'
      
      enable_image_generation:
        description: 'ç”»åƒç”Ÿæˆã‚’æœ‰åŠ¹ã«ã™ã‚‹'
        required: false
        type: boolean
        default: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ã‚¸ãƒ§ãƒ–1: åˆæœŸåŒ–ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  initialize:
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 5
    outputs:
      article_id: ${{ steps.init.outputs.article_id }}
      profile: ${{ steps.init.outputs.profile }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install dependencies
        run: |
          pip install anthropic pyyaml pathlib
          # å¿…è¦ã«å¿œã˜ã¦ä»–ã®ä¾å­˜é–¢ä¿‚ã‚‚è¿½åŠ 

      - name: Initialize article generation
        id: init
        run: |
          # è¨˜äº‹IDã‚’ç”Ÿæˆ
          CLEAN_TITLE=$(echo "${{ inputs.article_title }}" | sed 's/[^a-zA-Z0-9ã‚-ã‚“ã‚¢-ãƒ³ä¸€-é¾¯]/_/g' | cut -c1-30)
          ARTICLE_ID=$(date +%Y%m%d_%H%M%S)_${CLEAN_TITLE}
          PROFILE="${{ inputs.profile }}"
          
          echo "article_id=${ARTICLE_ID}" >> $GITHUB_OUTPUT
          echo "profile=${PROFILE}" >> $GITHUB_OUTPUT
          
          echo "Article ID: ${ARTICLE_ID}"
          echo "Profile: ${PROFILE}"
          
          # å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p "output/${ARTICLE_ID}"
          
          # å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼ˆCLIãŒèª­ã¿è¾¼ã‚ã‚‹å½¢å¼ï¼‰
          cat > "output/${ARTICLE_ID}/input_params.json" << EOF
          {
            "article_id": "${ARTICLE_ID}",
            "title": "${{ inputs.article_title }}",
            "main_keywords": "${{ inputs.main_keywords }}",
            "approach_target": "${{ inputs.approach_target }}",
            "eeat_elements": "${{ inputs.eeat_elements }}",
            "word_count": "${{ inputs.word_count }}",
            "profile": "${PROFILE}",
            "enable_image_generation": ${{ inputs.enable_image_generation }},
            "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Validate inputs
        run: |
          # æ–°ã—ã„CLIã§dry-runã«ã‚ˆã‚‹å…¥åŠ›æ¤œè¨¼
          python -m article_flow.cli \
            --profile "${{ inputs.profile }}" \
            --title "${{ inputs.article_title }}" \
            --main-keywords "${{ inputs.main_keywords }}" \
            --approach-target "${{ inputs.approach_target }}" \
            --eeat-elements "${{ inputs.eeat_elements }}" \
            --word-count "${{ inputs.word_count }}" \
            --prompt-dir "Prompt_${{ inputs.profile }}" \
            --output-dir "output/${{ steps.init.outputs.article_id }}" \
            --config "article_flow/config/${{ inputs.profile }}.yaml" \
            --dry-run

      - name: Upload initialization artifacts
        uses: actions/upload-artifact@v4
        with:
          name: init-${{ steps.init.outputs.article_id }}
          path: output/${{ steps.init.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–2: è¨˜äº‹ç”Ÿæˆï¼ˆæ–°ã—ã„CLIä½¿ç”¨ï¼‰
  generate_article:
    needs: initialize
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 30
    outputs:
      generation_status: ${{ steps.generate.outputs.status }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install dependencies
        run: |
          pip install anthropic pyyaml pathlib
          # MCP imagené–¢é€£ã®ä¾å­˜é–¢ä¿‚ã‚‚å¿…è¦ã«å¿œã˜ã¦è¿½åŠ 

      - name: Download initialization artifacts
        uses: actions/download-artifact@v4
        with:
          name: init-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}

      - name: Generate article using new CLI
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          # MCPé–¢é€£ã®ç’°å¢ƒå¤‰æ•°ã‚‚å¿…è¦ã«å¿œã˜ã¦è¿½åŠ 
        run: |
          echo "Starting article generation with profile: ${{ needs.initialize.outputs.profile }}"
          
          # æ–°ã—ã„CLIã§ãƒ•ãƒ«ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ
          python -m article_flow.cli \
            --profile "${{ needs.initialize.outputs.profile }}" \
            --title "${{ inputs.article_title }}" \
            --main-keywords "${{ inputs.main_keywords }}" \
            --approach-target "${{ inputs.approach_target }}" \
            --eeat-elements "${{ inputs.eeat_elements }}" \
            --word-count "${{ inputs.word_count }}" \
            --prompt-dir "Prompt_${{ needs.initialize.outputs.profile }}" \
            --output-dir "output/${{ needs.initialize.outputs.article_id }}" \
            --config "article_flow/config/${{ needs.initialize.outputs.profile }}.yaml" \
            --enable-image-generation="${{ inputs.enable_image_generation }}" \
            --log-level "INFO" \
            --article-id "${{ needs.initialize.outputs.article_id }}"
          
          # å®Ÿè¡Œçµæœç¢ºèª
          if [ -f "output/${{ needs.initialize.outputs.article_id }}/final_result.json" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "Article generation completed successfully"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "Article generation failed"
            exit 1
          fi

      - name: Validate output quality
        run: |
          # å‡ºåŠ›å“è³ªã‚’ãƒã‚§ãƒƒã‚¯
          RESULT_FILE="output/${{ needs.initialize.outputs.article_id }}/final_result.json"
          
          if [ -f "$RESULT_FILE" ]; then
            # JSONã‹ã‚‰å“è³ªã‚¹ã‚³ã‚¢ã‚’æŠ½å‡ºï¼ˆä¾‹ï¼‰
            echo "Checking article quality..."
            python -c "
            import json
            with open('$RESULT_FILE', 'r', encoding='utf-8') as f:
                result = json.load(f)
            
            phases = result.get('phases', {})
            
            # Phase 4 (factcheck) ã®çµæœã‚’ç¢ºèª
            factcheck = phases.get('phase4', {})
            if factcheck:
                score = factcheck.get('overall_score', 0)
                print(f'Quality Score: {score}')
                if score < 85:
                    print('WARNING: Quality score below threshold')
                    exit(1)
            else:
                print('No factcheck results found')
            "
          else
            echo "Result file not found"
            exit 1

      - name: Generate summary report
        run: |
          # çµæœã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆ
          RESULT_FILE="output/${{ needs.initialize.outputs.article_id }}/final_result.json"
          SUMMARY_FILE="output/${{ needs.initialize.outputs.article_id }}/generation_summary.md"
          
          python -c "
          import json
          from datetime import datetime
          
          # çµæœã‚’èª­ã¿è¾¼ã¿
          with open('$RESULT_FILE', 'r', encoding='utf-8') as f:
              result = json.load(f)
          
          # ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆ
          summary = []
          summary.append('# Article Generation Summary')
          summary.append('')
          summary.append(f'**Article ID:** {result.get(\"article_id\", \"Unknown\")}')
          summary.append(f'**Profile:** ${{ needs.initialize.outputs.profile }}')
          summary.append(f'**Status:** {result.get(\"status\", \"Unknown\")}')
          summary.append(f'**Completed At:** {result.get(\"completed_at\", \"Unknown\")}')
          summary.append('')
          
          # ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã®çµæœ
          phases = result.get('phases', {})
          summary.append('## Phase Results')
          summary.append('')
          
          for phase_name, phase_result in phases.items():
              if phase_result:
                  status = 'âœ…' if not phase_result.get('error') else 'âŒ'
                  summary.append(f'- {status} **{phase_name}**: {phase_result.get(\"status\", \"completed\")}')
          
          # å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹
          factcheck = phases.get('phase4', {})
          if factcheck and 'factcheck_results' in factcheck:
              fc_results = factcheck['factcheck_results']
              summary.append('')
              summary.append('## Quality Metrics')
              summary.append('')
              summary.append(f'- Overall Score: {fc_results.get(\"overall_score\", \"N/A\")}')
              summary.append(f'- Factual Accuracy: {fc_results.get(\"factual_accuracy\", \"N/A\")}')
              summary.append(f'- Regulatory Compliance: {fc_results.get(\"regulatory_compliance\", \"N/A\")}')
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—
          with open('$SUMMARY_FILE', 'w', encoding='utf-8') as f:
              f.write('\\n'.join(summary))
          
          print('Summary report generated')
          "

      - name: Upload generation results
        uses: actions/upload-artifact@v4
        with:
          name: article-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–3: çµæœé€šçŸ¥ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  finalize:
    needs: [initialize, generate_article]
    runs-on: ubuntu-latest
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: Download generation results
        if: needs.generate_article.outputs.generation_status == 'success'
        uses: actions/download-artifact@v4
        with:
          name: article-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}

      - name: Display generation summary
        if: needs.generate_article.outputs.generation_status == 'success'
        run: |
          echo "## Article Generation Completed ğŸ‰"
          echo ""
          echo "**Article ID:** ${{ needs.initialize.outputs.article_id }}"
          echo "**Profile:** ${{ needs.initialize.outputs.profile }}"
          echo "**Title:** ${{ inputs.article_title }}"
          echo "**Keywords:** ${{ inputs.main_keywords }}"
          echo "**Target:** ${{ inputs.approach_target }}"
          echo ""
          
          # ã‚µãƒãƒªãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯è¡¨ç¤º
          if [ -f "output/${{ needs.initialize.outputs.article_id }}/generation_summary.md" ]; then
            echo "### Detailed Summary"
            cat "output/${{ needs.initialize.outputs.article_id }}/generation_summary.md"
          fi

      - name: Handle generation failure
        if: needs.generate_article.outputs.generation_status == 'failed'
        run: |
          echo "## Article Generation Failed âŒ"
          echo ""
          echo "**Article ID:** ${{ needs.initialize.outputs.article_id }}"
          echo "**Profile:** ${{ needs.initialize.outputs.profile }}"
          echo ""
          echo "Please check the generation logs for details."
          exit 1

      - name: Workflow summary
        run: |
          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Profile Used:** ${{ needs.initialize.outputs.profile }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Article ID:** ${{ needs.initialize.outputs.article_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Generation Status:** ${{ needs.generate_article.outputs.generation_status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Generation:** ${{ inputs.enable_image_generation }}" >> $GITHUB_STEP_SUMMARY