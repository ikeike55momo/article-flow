name: Article Generation V4 (Simplified Output)

on:
  workflow_dispatch:
    inputs:
      article_title:
        description: 'è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«'
        required: true
        type: string
        default: ''
      
      target_persona:
        description: 'ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒšãƒ«ã‚½ãƒŠï¼ˆä¾‹ï¼š30ä»£å¥³æ€§ã€å¥åº·æ„è­˜ãŒé«˜ã„ã€å­è‚²ã¦ä¸­ï¼‰'
        required: true
        type: string
        default: ''
      
      meta_keywords:
        description: 'ãƒ¡ã‚¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰'
        required: true
        type: string
        default: ''
      
      enable_image_generation:
        description: 'ç”»åƒç”Ÿæˆã‚’æœ‰åŠ¹ã«ã™ã‚‹'
        required: false
        type: boolean
        default: true
      
      # Google Drive upload removed

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ã‚¸ãƒ§ãƒ–1: åˆæœŸåŒ–
  initialize:
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 5
    outputs:
      article_id: ${{ steps.init.outputs.article_id }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize article generation
        id: init
        run: |
          # ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰IDã‚’ç”Ÿæˆ
          CLEAN_TITLE=$(echo "${{ inputs.article_title }}" | sed 's/[^a-zA-Z0-9ã‚-ã‚“ã‚¢-ãƒ³ä¸€-é¾¯]/_/g' | cut -c1-50)
          ARTICLE_ID=$(date +%Y%m%d_%H%M%S)_${CLEAN_TITLE}
          echo "article_id=${ARTICLE_ID}" >> $GITHUB_OUTPUT
          echo "Article ID: ${ARTICLE_ID}"
          
          # å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p output/${ARTICLE_ID}
          
          # å…¥åŠ›æƒ…å ±ã‚’ä¿å­˜
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          cat > output/${ARTICLE_ID}/input_params.json << EOJSON
          {
            "article_id": "${ARTICLE_ID}",
            "title": "${{ inputs.article_title }}",
            "target_persona": "${{ inputs.target_persona }}",
            "meta_keywords": "${{ inputs.meta_keywords }}",
            "created_at": "${TIMESTAMP}"
          }
          EOJSON

      - name: Upload initialization artifacts
        uses: actions/upload-artifact@v4
        with:
          name: init-${{ steps.init.outputs.article_id }}
          path: output/${{ steps.init.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–2: ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ†æ
  analysis:
    needs: initialize
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 10
    outputs:
      main_keyword: ${{ steps.analyze.outputs.main_keyword }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download initialization artifacts
        uses: actions/download-artifact@v4
        with:
          name: init-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd github-actions
          pip install -r requirements.txt

      - name: Create analysis input
        run: |
          cd output/${{ needs.initialize.outputs.article_id }}
          # Phase1ãŒæœŸå¾…ã™ã‚‹å½¢å¼ã®JSONã‚’ä½œæˆ
          cat > request_params.json << EOJSON
          {
            "topic": "${{ inputs.article_title }}",
            "target_audience": "${{ inputs.target_persona }}",
            "keywords": "${{ inputs.meta_keywords }}"
          }
          EOJSON

      - name: Run Phase 1 Analysis with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            è¨˜äº‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åˆ†æã—ã¦ã€è¨˜äº‹ç”Ÿæˆã®ãŸã‚ã®è©³ç´°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
            
            å…¥åŠ›æƒ…å ±:
            - ãƒˆãƒ”ãƒƒã‚¯: ${{ inputs.article_title }}  
            - ã‚¿ãƒ¼ã‚²ãƒƒãƒˆèª­è€…: ${{ inputs.target_persona }}
            - ãƒ¡ã‚¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${{ inputs.meta_keywords }}
            
            ã‚¿ã‚¹ã‚¯:
            1. output/${{ needs.initialize.outputs.article_id }}/request_params.json ã‚’èª­ã¿è¾¼ã‚“ã§ç†è§£
            2. ä»¥ä¸‹ã®åˆ†æã‚’å®Ÿè¡Œ:
               - ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ç‰¹å®š
               - é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æŠ½å‡ºï¼ˆ5-8å€‹ï¼‰
               - æ¤œç´¢æ„å›³ã®åˆ†æ
               - ãƒªã‚µãƒ¼ãƒã‚¯ã‚¨ãƒªã®ç”Ÿæˆï¼ˆ15-25å€‹ï¼‰
            
            3. åˆ†æçµæœã‚’ output/${{ needs.initialize.outputs.article_id }}/phase1_output.json ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦ãã ã•ã„
            
            é‡è¦ï¼šä»¥ä¸‹ã®å½¢å¼ã§analysisã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å«ã‚€JSONã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
            {
              "analysis": {
                "main_keyword": "æŠ½å‡ºã—ãŸãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰",
                "related_keywords": ["é–¢é€£1", "é–¢é€£2", "é–¢é€£3", "é–¢é€£4", "é–¢é€£5"],
                "search_intent": "informational",
                "content_type": "how-to", 
                "tone": "friendly",
                "key_points": ["ãƒã‚¤ãƒ³ãƒˆ1", "ãƒã‚¤ãƒ³ãƒˆ2", "ãƒã‚¤ãƒ³ãƒˆ3"],
                "research_queries": ["ã‚¯ã‚¨ãƒª1", "ã‚¯ã‚¨ãƒª2", "ã‚¯ã‚¨ãƒª3", "ã‚¯ã‚¨ãƒª4", "ã‚¯ã‚¨ãƒª5", "ã‚¯ã‚¨ãƒª6", "ã‚¯ã‚¨ãƒª7", "ã‚¯ã‚¨ãƒª8", "ã‚¯ã‚¨ãƒª9", "ã‚¯ã‚¨ãƒª10", "ã‚¯ã‚¨ãƒª11", "ã‚¯ã‚¨ãƒª12", "ã‚¯ã‚¨ãƒª13", "ã‚¯ã‚¨ãƒª14", "ã‚¯ã‚¨ãƒª15"],
                "competitor_analysis_needed": true,
                "local_seo_focus": false,
                "estimated_sections": 5
              },
              "topic": "${{ inputs.article_title }}",
              "target_audience": "${{ inputs.target_persona }}",
              "keywords": "${{ inputs.meta_keywords }}",
              "processed_at": "ç¾åœ¨æ™‚åˆ»",
              "workflow_version": "4.0.0"
            }
          
          allowed_tools: |
            Read,
            Write
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
          
          max_turns: "5"
      
      - name: Verify and prepare analysis results
        run: |
          echo "ğŸ” Checking for analysis files..."
          echo "Current working directory: $(pwd)"
          echo "Files in root:"
          ls -la
          echo "Files in output directory:"
          ls -la output/${{ needs.initialize.outputs.article_id }}/
          
          cd output/${{ needs.initialize.outputs.article_id }}
          if [ -f "phase1_output.json" ]; then
            echo "âœ… Phase 1 analysis file found"
            cat phase1_output.json
          else
            echo "âš ï¸ Phase 1 analysis file not found, creating default"
            # Check if file was created in root directory by mistake
            if [ -f "../../phase1_output.json" ]; then
              echo "ğŸ“ Found phase1_output.json in root, moving to correct location"
              mv ../../phase1_output.json ./phase1_output.json
            else
              echo "ğŸ”§ Creating fallback analysis file"
              # Create fallback analysis if Claude didn't create the file
              TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
              TITLE="${{ inputs.article_title }}"
              PERSONA="${{ inputs.target_persona }}"
              KEYWORDS="${{ inputs.meta_keywords }}"
              
              # å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦JSONã‚’ä½œæˆ
              TITLE="${TITLE}" PERSONA="${PERSONA}" KEYWORDS="${KEYWORDS}" TIMESTAMP="${TIMESTAMP}" OUTPUT_DIR="." python3 ../../github-actions/scripts/create_phase1_fallback.py
            fi
          fi
          
          echo "ğŸ“‹ Final verification - files in current directory:"
          ls -la

      - name: Split research queries into batches
        id: analyze
        run: |
          # ã‚¯ã‚¨ãƒªã‚’5ãƒãƒƒãƒã«åˆ†å‰²
          cd output/${{ needs.initialize.outputs.article_id }}
          python3 ../../github-actions/scripts/split_research_queries.py
          
          # ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å‡ºåŠ›
          if [ -f "research_meta.json" ]; then
            MAIN_KW=$(python -c "import json; print(json.load(open('research_meta.json'))['main_keyword'])")
            echo "main_keyword=${MAIN_KW}" >> $GITHUB_OUTPUT
          fi
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ENABLE_GEMINI_RESEARCH: "true"

      - name: Upload analysis artifacts
        uses: actions/upload-artifact@v4
        with:
          name: analysis-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–3: ãƒªã‚µãƒ¼ãƒï¼ˆGeminiä½¿ç”¨ - ä¸¦åˆ—å®Ÿè¡Œï¼‰
  research:
    needs: [initialize, analysis]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 25
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download initialization artifacts
        uses: actions/download-artifact@v4
        with:
          name: init-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}

      - name: Download analysis artifacts
        uses: actions/download-artifact@v4
        with:
          name: analysis-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd github-actions
          pip install -r requirements.txt
          
      - name: Install Gemini API dependencies  
        run: |
          pip install google-generativeai httpx

      - name: Research with Gemini (V2 Single Process Style)
        run: |
          cd output/${{ needs.initialize.outputs.article_id }}
          
          # ãƒãƒƒãƒç”¨ã®åˆ†æãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          BATCH_NUM=${{ matrix.batch }} python3 ../../github-actions/scripts/create_batch_analysis.py
          
          # ãƒãƒƒãƒã‚¯ã‚¨ãƒªã‚’èª­ã¿è¾¼ã‚“ã§Gemini APIã§ç›´æ¥æ¤œç´¢ï¼ˆV2æ–¹å¼ï¼‰
          cat > research_batch_${{ matrix.batch }}.py << 'EOF'
          import os
          import sys
          import json
          import google.generativeai as genai
          from datetime import datetime
          
          # Configure Gemini
          genai.configure(api_key=os.environ['GEMINI_API_KEY'])
          model = genai.GenerativeModel('gemini-2.0-flash-exp')
          
          # ãƒãƒƒãƒã‚¯ã‚¨ãƒªã‚’èª­ã¿è¾¼ã¿
          with open('research_batch_${{ matrix.batch }}.json', 'r') as f:
              batch_data = json.load(f)
          
          queries = batch_data.get('queries', [])
          results = []
          
          for i, query in enumerate(queries):
              print(f"Searching batch ${{ matrix.batch }} ({i+1}/{len(queries)}): {query}")
              
              prompt = f"""
              Webæ¤œç´¢ã‚’å®Ÿè¡Œ: "{query}"
              
              å„ªå…ˆé †ä½ï¼š
              1. æ”¿åºœæ©Ÿé–¢ï¼ˆ.go.jp, .govï¼‰
              2. å­¦è¡“æ©Ÿé–¢ï¼ˆ.ac.jp, .eduï¼‰  
              3. åŒ»å­¦ä¼šãƒ»å°‚é–€å›£ä½“
              4. å¤§æ‰‹ãƒ¡ãƒ‡ã‚£ã‚¢
              
              ä»¥ä¸‹ã®å½¢å¼ã§JSONã§è¿”ã—ã¦ãã ã•ã„ï¼š
              {{
                "query": "{query}",
                "results": [
                  {{
                    "url": "URL",
                    "title": "ã‚¿ã‚¤ãƒˆãƒ«", 
                    "source_type": "government/academic/medical/industry/media",
                    "reliability_score": 1-10,
                    "key_findings": ["é‡è¦ãªç™ºè¦‹"],
                    "publication_date": "YYYY-MM-DD"
                  }}
                ]
              }}
              """
              
              try:
                  response = model.generate_content(
                      prompt,
                      tools=[genai.protos.Tool(
                          google_search=genai.protos.GoogleSearch()
                      )],
                      generation_config=genai.GenerationConfig(
                          temperature=1.0,
                          max_output_tokens=2048
                      )
                  )
                  
                  text = response.text
                  json_start = text.find('{')
                  json_end = text.rfind('}') + 1
                  if json_start >= 0 and json_end > json_start:
                      result = json.loads(text[json_start:json_end])
                      results.append(result)
                  else:
                      print(f"âš ï¸ No valid JSON in response for: {query}")
                      
              except Exception as e:
                  print(f"âŒ Error searching '{query}': {e}")
          
          # ãƒãƒƒãƒçµæœã‚’ä¿å­˜
          os.makedirs('batch_${{ matrix.batch }}', exist_ok=True)
          output_data = {
              'batch_id': ${{ matrix.batch }},
              'results': results,
              'sources': [r.get('results', [{}])[0].get('url', '') for r in results if r.get('results')],
              'key_findings': [finding for r in results for result in r.get('results', []) for finding in result.get('key_findings', [])],
              'timestamp': datetime.now().isoformat(),
              'total_queries': len(queries),
              'successful_queries': len(results)
          }
          
          with open('batch_${{ matrix.batch }}/phase2_research.json', 'w') as f:
              json.dump(output_data, f, ensure_ascii=False, indent=2)
          
          print(f"âœ… Batch ${{ matrix.batch }} completed: {len(results)}/{len(queries)} successful")
          EOF
          
          python3 research_batch_${{ matrix.batch }}.py
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Upload research batch artifacts
        uses: actions/upload-artifact@v4
        with:
          name: research-batch-${{ matrix.batch }}-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}/batch_${{ matrix.batch }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–4: ãƒªã‚µãƒ¼ãƒçµæœã®çµ±åˆ
  research-merge:
    needs: [initialize, research]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create output directory
        run: mkdir -p output/${{ needs.initialize.outputs.article_id }}

      - name: Download all research batches
        uses: actions/download-artifact@v4
        with:
          pattern: research-batch-*-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}/batches

      - name: Download analysis artifacts
        uses: actions/download-artifact@v4
        with:
          name: analysis-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}

      - name: Merge research results
        run: |
          cd output/${{ needs.initialize.outputs.article_id }}
          
          # ãƒªã‚µãƒ¼ãƒçµæœã‚’çµ±åˆã—ã¦V4å‡ºåŠ›å½¢å¼ã«ã™ã‚‹
          python3 ../../github-actions/scripts/merge_research_results.py
          
          # V4ç”¨ã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´
          if [ -f "phase2_research.json" ]; then
            mv phase2_research.json research_results.json
            echo "âœ… Created research_results.json for V4"
          fi

      - name: Upload merged research artifacts
        uses: actions/upload-artifact@v4
        with:
          name: research-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–5: è¨˜äº‹æ§‹æˆã®ç”Ÿæˆï¼ˆSEOå‰Šé™¤ç‰ˆï¼‰
  generate-structure:
    needs: [initialize, analysis, research-merge]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 15
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: Generate article structure with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            å¥åº·ãƒ»ç¾å®¹ã«é–¢ã™ã‚‹è¨˜äº‹ã®åŸºæœ¬æ§‹æˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚ï¼ˆSEOæœ€é©åŒ–ã¯åˆ¶ä½œå´ã§å®Ÿæ–½ã™ã‚‹ãŸã‚ã€ç´”ç²‹ãªè¨˜äº‹æ§‹æˆã®ã¿ä½œæˆï¼‰
            
            å…¥åŠ›æƒ…å ±:
            - è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«: ${{ inputs.article_title }}
            - ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒšãƒ«ã‚½ãƒŠ: ${{ inputs.target_persona }}
            - ãƒ¡ã‚¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${{ inputs.meta_keywords }}
            
            ã‚¿ã‚¹ã‚¯:
            1. ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ç†è§£:
               - input_params.json: å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
               - phase1_output.json: åˆ†æçµæœ
               - research_results.json: ãƒªã‚µãƒ¼ãƒçµæœ
            2. åˆ†æã¨ãƒªã‚µãƒ¼ãƒçµæœã‚’è¸ã¾ãˆã¦ãƒšãƒ«ã‚½ãƒŠã«æœ€é©åŒ–ã•ã‚ŒãŸè¨˜äº‹æ§‹æˆã‚’ä½œæˆ
            3. ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ:
               - 01_article_structure.md: è©³ç´°ãªè¨˜äº‹æ§‹æˆ
               - 02_content_plan.md: å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å†…å®¹è¨ˆç”»
            
            è¦ä»¶:
            - ãƒšãƒ«ã‚½ãƒŠã®æ‚©ã¿ã‚„é–¢å¿ƒäº‹ã«å¯„ã‚Šæ·»ã†æ§‹æˆ
            - ãƒ¡ã‚¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è‡ªç„¶ã«çµ„ã¿è¾¼ã‚€
            - è–¬æ©Ÿæ³•ãƒ»æ™¯è¡¨æ³•ã‚’è€ƒæ…®ã—ãŸè¡¨ç¾è¨ˆç”»
            - èª­ã¿ã‚„ã™ãä¾¡å€¤ã®ã‚ã‚‹è¨˜äº‹æ§‹æˆ
            - SEOæœ€é©åŒ–ã¯è€ƒæ…®ã—ãªã„ï¼ˆåˆ¶ä½œå´ã§å®Ÿæ–½ã™ã‚‹ãŸã‚ï¼‰
          
          allowed_tools: |
            Read,
            Write,
            Edit
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
          
          max_turns: "20"

      - name: Upload structure artifacts
        uses: actions/upload-artifact@v4
        with:
          name: structure-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–6: è¨˜äº‹æœ¬æ–‡ã®ç”Ÿæˆï¼ˆMDå°‚ç”¨ï¼‰
  generate-content:
    needs: [initialize, generate-structure]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 20
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: Generate article content with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt_file: prompts/04_writing_v4.md
          
          allowed_tools: |
            Read,
            Write,
            Edit
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
            TITLE=${{ inputs.article_title }}
            TARGET_PERSONA=${{ inputs.persona }}
          
          max_turns: "15"

      - name: Verify article generation with fallback
        id: verify-article
        run: |
          ARTICLE_DIR="output/${{ needs.initialize.outputs.article_id }}"
          echo "ğŸ” Checking for generated article file..."
          
          if [ -f "$ARTICLE_DIR/final_article.md" ]; then
            echo "âœ… Found final_article.md"
            echo "article_found=true" >> $GITHUB_OUTPUT
            echo "fallback_used=false" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Primary generation failed, using bash fallback method"
            echo "ğŸ“ Contents of $ARTICLE_DIR:"
            ls -la "$ARTICLE_DIR/" || echo "Directory not found"
            
            # Create directory if needed
            mkdir -p "$ARTICLE_DIR"
            
            # Generate fallback article directly with bash
            cat > "$ARTICLE_DIR/final_article.md" << 'EOF'
# ${{ inputs.article_title }}

${{ inputs.persona }}ã®çš†ã•ã‚“ã«ã¨ã£ã¦ã€çˆªã®å¥åº·ã¯æ—¥å¸¸ç”Ÿæ´»ã«ãŠã‘ã‚‹é‡è¦ãªé–¢å¿ƒäº‹ã®ä¸€ã¤ã§ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯ã€å°‚é–€çš„ãªè¦³ç‚¹ã‹ã‚‰å®Ÿè·µçš„ãªã‚±ã‚¢æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬ã„ãŸã—ã¾ã™ã€‚

## çˆªãŒè–„ã„ãƒ»å‰²ã‚Œã‚„ã™ã„åŸå› ã¨ã¯

çˆªãŒè–„ããªã£ãŸã‚Šå‰²ã‚Œã‚„ã™ããªã£ãŸã‚Šã™ã‚‹åŸå› ã¯ã€ä¸€èˆ¬çš„ã«ä»¥ä¸‹ã®ã‚ˆã†ãªè¦å› ãŒè€ƒãˆã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

### æ „é¤Šä¸è¶³ã«ã‚ˆã‚‹å½±éŸ¿

ç ”ç©¶ã«ã‚ˆã‚‹ã¨ã€ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã‚„ãƒ“ã‚¿ãƒŸãƒ³ã€ãƒŸãƒãƒ©ãƒ«ã®ä¸è¶³ãŒçˆªã®å¥åº·ã«å¤§ããå½±éŸ¿ã™ã‚‹ã“ã¨ãŒçŸ¥ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ç‰¹ã«ä»¥ä¸‹ã®æ „é¤Šç´ ãŒé‡è¦ã¨ã•ã‚Œã¦ã„ã¾ã™ï¼š

- **ã‚¿ãƒ³ãƒ‘ã‚¯è³ª**: çˆªã®ä¸»æˆåˆ†ã§ã‚ã‚‹ã‚±ãƒ©ãƒãƒ³ã®ç”Ÿæˆã«å¿…è¦
- **ãƒ“ã‚ªãƒãƒ³**: çˆªã®å¼·åº¦å‘ä¸Šã«é–¢é€£ãŒã‚ã‚‹ã¨ã•ã‚Œã‚‹
- **é‰„åˆ†**: ä¸è¶³ã™ã‚‹ã¨çˆªãŒè–„ããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
- **äºœé‰›**: ç´°èƒã®æ–°é™³ä»£è¬ã«é‡è¦ãªå½¹å‰²ã‚’æœãŸã™

### å¤–çš„è¦å› ã®å½±éŸ¿

æ—¥å¸¸ç”Ÿæ´»ã«ãŠã‘ã‚‹å¤–çš„è¦å› ã‚‚çˆªã®çŠ¶æ…‹ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ã¨ã•ã‚Œã¦ã„ã¾ã™ï¼š

- éåº¦ãªæ°´ä»•äº‹ã‚„æ´—å‰¤ã®ä½¿ç”¨
- é »ç¹ãªãƒãƒ‹ã‚­ãƒ¥ã‚¢ã®ä½¿ç”¨
- çˆªã‚’é“å…·ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ç¿’æ…£
- ä¹¾ç‡¥ã—ãŸç’°å¢ƒã§ã®ç”Ÿæ´»

## å°‚é–€çš„ãªã‚±ã‚¢æ–¹æ³•

### åŸºæœ¬çš„ãªãŠæ‰‹å…¥ã‚Œ

å°‚é–€å®¶ãŒæ¨å¥¨ã™ã‚‹åŸºæœ¬çš„ãªã‚±ã‚¢æ–¹æ³•ã‚’ã”ç´¹ä»‹ã—ã¾ã™ï¼š

1. **é©åˆ‡ãªçˆªåˆ‡ã‚Š**
   - çˆªãŒæ¹¿ã£ã¦ã„ã‚‹çŠ¶æ…‹ã§åˆ‡ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™
   - ä¸€åº¦ã«å¤§ããåˆ‡ã‚‰ãšã€å°‘ã—ãšã¤ã‚«ãƒƒãƒˆã™ã‚‹
   - ã‚„ã™ã‚Šã§å½¢ã‚’æ•´ãˆã‚‹

2. **ä¿æ¹¿ã‚±ã‚¢**
   - ãƒãƒ³ãƒ‰ã‚¯ãƒªãƒ¼ãƒ ã‚„ã‚­ãƒ¥ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚ªã‚¤ãƒ«ã®ä½¿ç”¨
   - å°±å¯å‰ã®é›†ä¸­ã‚±ã‚¢ãŒåŠ¹æœçš„ã¨ã•ã‚Œã‚‹
   - æ‰‹è¢‹ã®ç€ç”¨ã«ã‚ˆã‚‹ä¿è­·

3. **æ „é¤Šãƒãƒ©ãƒ³ã‚¹ã®æ”¹å–„**
   - ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸé£Ÿäº‹ã‚’å¿ƒãŒã‘ã‚‹
   - å¿…è¦ã«å¿œã˜ã¦ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆã®æ¤œè¨
   - ååˆ†ãªæ°´åˆ†æ‘‚å–

### é¿ã‘ã‚‹ã¹ãç¿’æ…£

ä»¥ä¸‹ã®ã‚ˆã†ãªç¿’æ…£ã¯çˆªã®å¥åº·ã«æ‚ªå½±éŸ¿ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼š

- çˆªã‚’å™›ã‚€ç¿’æ…£
- ç„¡ç†ãªç”˜çš®å‡¦ç†
- éåº¦ãªãƒã‚¤ãƒ«ã‚¢ãƒ¼ãƒˆ
- ä¸é©åˆ‡ãªé™¤å…‰æ¶²ã®ä½¿ç”¨

## ã‚ˆãã‚ã‚‹è³ªå•

### Q: ã©ã®ãã‚‰ã„ã§åŠ¹æœãŒç¾ã‚Œã¾ã™ã‹ï¼Ÿ

A: å€‹äººå·®ãŒã‚ã‚Šã¾ã™ãŒã€ä¸€èˆ¬çš„ã«çˆªã®æˆé•·ã‚µã‚¤ã‚¯ãƒ«ã¯ç´„6ãƒ¶æœˆã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚é©åˆ‡ãªã‚±ã‚¢ã‚’ç¶™ç¶šã™ã‚‹ã“ã¨ã§ã€æ•°é€±é–“ã‹ã‚‰æ•°ãƒ¶æœˆã§å¤‰åŒ–ã‚’æ„Ÿã˜ã‚‹æ–¹ãŒå¤šã„ã‚ˆã†ã§ã™ã€‚

### Q: ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆã¯åŠ¹æœçš„ã§ã™ã‹ï¼Ÿ

A: æ „é¤Šä¸è¶³ãŒåŸå› ã®å ´åˆã€é©åˆ‡ãªã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆãŒæœ‰åŠ¹ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãŸã ã—ã€åŒ»å¸«ã‚„å°‚é–€å®¶ã«ç›¸è«‡ã•ã‚Œã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

### Q: å¸‚è²©ã®ã‚±ã‚¢ç”¨å“ã®é¸ã³æ–¹ã¯ï¼Ÿ

A: æˆåˆ†è¡¨ã‚’ç¢ºèªã—ã€ä¿æ¹¿æˆåˆ†ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚’é¸ã¶ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚ä½¿ç”¨å‰ã«ãƒ‘ãƒƒãƒãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã“ã¨ã‚‚å¤§åˆ‡ã§ã™ã€‚

## ã¾ã¨ã‚

çˆªã®å¥åº·ã¯æ—¥ã€…ã®ã‚±ã‚¢ã®ç©ã¿é‡ã­ã«ã‚ˆã£ã¦ç¶­æŒã•ã‚Œã‚‹ã‚‚ã®ã§ã™ã€‚ä»Šå›ã”ç´¹ä»‹ã—ãŸæ–¹æ³•ã‚’å‚è€ƒã«ã€ã”è‡ªèº«ã«åˆã£ãŸã‚±ã‚¢æ–¹æ³•ã‚’è¦‹ã¤ã‘ã¦ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

ç—‡çŠ¶ãŒæ”¹å–„ã•ã‚Œãªã„å ´åˆã‚„ã€æ°—ã«ãªã‚‹å¤‰åŒ–ãŒã‚ã‚‹å ´åˆã¯ã€å°‚é–€åŒ»ã«ç›¸è«‡ã•ã‚Œã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚å€‹äººå·®ãŒã‚ã‚‹ãŸã‚ã€ç„¡ç†ã‚’ã›ãšã€ç¶™ç¶šçš„ãªã‚±ã‚¢ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†ã€‚

*æœ¬è¨˜äº‹ã®å†…å®¹ã¯ä¸€èˆ¬çš„ãªæƒ…å ±æä¾›ã‚’ç›®çš„ã¨ã—ã¦ãŠã‚Šã€å€‹åˆ¥ã®è¨ºæ–­ã‚„æ²»ç™‚ã«ä»£ã‚ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ°—ã«ãªã‚‹ç—‡çŠ¶ãŒã‚ã‚‹å ´åˆã¯ã€åŒ»ç™‚å°‚é–€å®¶ã«ã”ç›¸è«‡ãã ã•ã„ã€‚*
EOF
            
            echo "âœ… Bash fallback article generated ($(wc -c < "$ARTICLE_DIR/final_article.md") bytes)"
            
            if [ -f "$ARTICLE_DIR/final_article.md" ]; then
              echo "âœ… Fallback article generated successfully"
              echo "article_found=true" >> $GITHUB_OUTPUT
              echo "fallback_used=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ ERROR: Both primary and fallback generation failed!"
              echo "article_found=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      - name: Upload content artifacts
        uses: actions/upload-artifact@v4
        with:
          name: content-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–7: ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆå“è³ªã‚¹ã‚³ã‚¢ä»˜ãï¼‰
  factcheck:
    needs: [initialize, generate-content]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: Fact-check article with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            è¨˜äº‹ã®ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã€å“è³ªã‚¹ã‚³ã‚¢ã‚’ç®—å‡ºã—ã¦ãã ã•ã„ã€‚
            
            ã‚¿ã‚¹ã‚¯:
            1. ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§å†…å®¹ã‚’ç¢ºèª:
               - final_article.md: è¨˜äº‹æœ¬æ–‡
               - research_results.json: ãƒªã‚µãƒ¼ãƒçµæœ
            
            2. ä»¥ä¸‹ã®è¦³ç‚¹ã§ãƒã‚§ãƒƒã‚¯:
               - äº‹å®Ÿã®æ­£ç¢ºæ€§ï¼ˆãƒªã‚µãƒ¼ãƒçµæœã¨ã®ç…§åˆï¼‰
               - è–¬æ©Ÿæ³•ãƒ»æ™¯è¡¨æ³•ã®éµå®ˆ
               - æ•°å€¤ã‚„çµ±è¨ˆã®æ­£ç¢ºæ€§
               - åŒ»å­¦çš„ãƒ»ç§‘å­¦çš„ä¸»å¼µã®å¦¥å½“æ€§
            
            3. ä¿®æ­£ãŒå¿…è¦ãªå ´åˆ:
               - final_article.md ã‚’ç›´æ¥ç·¨é›†
            
            4. å“è³ªãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ:
               - factcheck_report.json ã«ä»¥ä¸‹ã®å½¢å¼ã§ä¿å­˜:
               {
                 "overall_quality_score": 85,
                 "fact_accuracy_score": 90,
                 "legal_compliance_score": 95,
                 "scientific_validity_score": 80,
                 "source_reliability_score": 85,
                 "issues_found": [
                   {
                     "type": "fact_error",
                     "description": "å•é¡Œã®èª¬æ˜",
                     "location": "è¨˜äº‹å†…ã®å ´æ‰€",
                     "severity": "high/medium/low",
                     "corrected": true/false
                   }
                 ],
                 "recommendations": ["æ”¹å–„ææ¡ˆ1", "æ”¹å–„ææ¡ˆ2"],
                 "timestamp": "ç¾åœ¨æ™‚åˆ»",
                 "total_issues": 3,
                 "corrected_issues": 2
               }
            
            5. ãƒšãƒ«ã‚½ãƒŠã¸ã®é…æ…®:
               - ãƒšãƒ«ã‚½ãƒŠãŒèª¤è§£ã—ã‚„ã™ã„è¡¨ç¾ã®ä¿®æ­£
               - ã‚ˆã‚Šåˆ†ã‹ã‚Šã‚„ã™ã„èª¬æ˜ã¸ã®æ”¹å–„
          
          allowed_tools: |
            Read,
            Write,
            Edit
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
          
          max_turns: "20"

      - name: Upload factcheck artifacts
        uses: actions/upload-artifact@v4
        with:
          name: factcheck-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–8: ç”»åƒç”Ÿæˆï¼ˆMCP + Imagen4ï¼‰
  generate-images:
    if: ${{ inputs.enable_image_generation }}
    needs: [initialize, generate-structure]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 20
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: Generate Images with Claude + MCP Imagen4
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            è¨˜äº‹ã«æœ€é©ãªç”»åƒã‚’è¤‡æ•°æšç”Ÿæˆã—ã¦ãã ã•ã„ã€‚åˆè¨ˆ4-5æšã®ç”»åƒã‚’ç”Ÿæˆã—ã¾ã™ã€‚
            
            ã‚¿ã‚¹ã‚¯:
            1. è¨˜äº‹å†…å®¹ã‚’ç†è§£:
               - input_params.json ã§ãƒšãƒ«ã‚½ãƒŠã‚’ç¢ºèª
               - final_article.md ã§è¨˜äº‹å†…å®¹ã‚’æŠŠæ¡ï¼ˆã‚ã‚Œã°ï¼‰
               - 01_article_structure.md ã§æ§‹æˆã‚’ç†è§£
            
            2. ä»¥ä¸‹ã®æ‰‹é †ã§å€‹åˆ¥ã«ç”»åƒã‚’ç”Ÿæˆ:
               
               **ã‚¹ãƒ†ãƒƒãƒ—1**: ãƒ’ãƒ¼ãƒ­ãƒ¼ç”»åƒï¼ˆ16:9ï¼‰ã‚’ç”Ÿæˆ
               - mcp__gemini-imagen__generate_image ã‚’ä½¿ç”¨
               - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: "è¨˜äº‹å…¨ä½“ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’è¡¨ç¾ã™ã‚‹16:9ã®ãƒ’ãƒ¼ãƒ­ãƒ¼ç”»åƒ"
               - ãƒšãƒ«ã‚½ãƒŠã«åˆã‚ã›ãŸãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«
               
               **ã‚¹ãƒ†ãƒƒãƒ—2**: ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”»åƒ1ï¼ˆ4:3ï¼‰ã‚’ç”Ÿæˆ  
               - mcp__gemini-imagen__generate_image ã‚’ä½¿ç”¨
               - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: "è¨˜äº‹ã®å°å…¥éƒ¨åˆ†ã‚’è¡¨ç¾ã™ã‚‹4:3ã®ç”»åƒ"
               
               **ã‚¹ãƒ†ãƒƒãƒ—3**: ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”»åƒ2ï¼ˆ4:3ï¼‰ã‚’ç”Ÿæˆ
               - mcp__gemini-imagen__generate_image ã‚’ä½¿ç”¨  
               - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: "è¨˜äº‹ã®æ–¹æ³•ãƒ»æ‰‹é †éƒ¨åˆ†ã‚’è¡¨ç¾ã™ã‚‹4:3ã®ç”»åƒ"
               
               **ã‚¹ãƒ†ãƒƒãƒ—4**: ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”»åƒ3ï¼ˆ4:3ï¼‰ã‚’ç”Ÿæˆ
               - mcp__gemini-imagen__generate_image ã‚’ä½¿ç”¨
               - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: "è¨˜äº‹ã®çµæœãƒ»åŠ¹æœéƒ¨åˆ†ã‚’è¡¨ç¾ã™ã‚‹4:3ã®ç”»åƒ"
               
               **ã‚¹ãƒ†ãƒƒãƒ—5**: ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”»åƒ4ï¼ˆ4:3ï¼‰ã‚’ç”Ÿæˆ
               - mcp__gemini-imagen__generate_image ã‚’ä½¿ç”¨
               - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: "è¨˜äº‹ã®ã¾ã¨ã‚éƒ¨åˆ†ã‚’è¡¨ç¾ã™ã‚‹4:3ã®ç”»åƒ"
            
            3. ç”»åƒç”Ÿæˆã®æ–¹é‡ï¼ˆå…¨ç”»åƒå…±é€šï¼‰:
               - ãƒšãƒ«ã‚½ãƒŠã®å¹´ä»£ãƒ»æ€§åˆ¥ã«åˆã‚ã›ãŸãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«
               - æ¸…æ½”æ„Ÿã¨ä¿¡é ¼æ„Ÿã®ã‚ã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³
               - è¨˜äº‹å†…å®¹ã¨èª¿å’Œã—ãŸã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
               - ãƒ†ã‚­ã‚¹ãƒˆã‚„ãƒ­ã‚´ã¯å«ã¾ãªã„
               - imagen-4 ã¾ãŸã¯ imagen-4-ultra ã‚’ä½¿ç”¨
            
            4. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä½œæˆ:
               - images/metadata.json ã«ç”Ÿæˆæƒ…å ±ã‚’è¨˜éŒ²
               - å„ç”»åƒã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€ç”¨é€”ã€ã‚µã‚¤ã‚ºã‚’è¨˜è¼‰
               
            é‡è¦: å¿…ãš5å›ã®mcp__gemini-imagen__generate_imageã‚’å®Ÿè¡Œã—ã¦ã€è¤‡æ•°æšã®ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
          
          mcp_config: |
            {
              "mcpServers": {
                "gemini-imagen": {
                  "command": "npx",
                  "args": [
                    "-y", 
                    "gemini-imagen-mcp-server",
                    "--model", "imagen-4"
                  ],
                  "env": {
                    "GEMINI_API_KEY": "${{ secrets.GEMINI_API_KEY }}"
                  }
                }
              }
            }
          
          allowed_tools: |
            Read,
            Write,
            mcp__gemini-imagen__generate_image,
            mcp__gemini-imagen__list_models
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
          
          max_turns: "30"

      - name: Process generated images
        run: |
          ARTICLE_DIR="output/${{ needs.initialize.outputs.article_id }}"
          IMAGE_DIR="${ARTICLE_DIR}/images"
          
          # MCPã‚µãƒ¼ãƒãƒ¼ã¯ imagen/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã™ã‚‹
          if [ -d "imagen" ] && [ "$(ls -A imagen 2>/dev/null)" ]; then
            echo "âœ… Images found in imagen directory:"
            ls -la imagen/
            
            # ç”»åƒã‚’è¨˜äº‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
            mkdir -p $IMAGE_DIR
            cp imagen/*.png $IMAGE_DIR/ 2>/dev/null || true
            cp imagen/*.jpg $IMAGE_DIR/ 2>/dev/null || true
            
            # ãƒªãƒãƒ¼ãƒ ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            cd $IMAGE_DIR
            i=1
            for img in *.png *.jpg; do
              if [ -f "$img" ]; then
                if [ $i -eq 1 ]; then
                  mv "$img" "hero_image.png" 2>/dev/null || true
                else
                  mv "$img" "section_$((i-1))_image.png" 2>/dev/null || true
                fi
                i=$((i+1))
              fi
            done
            cd -
            
            echo "Final images:"
            ls -la $IMAGE_DIR
          else
            echo "âš ï¸ No images generated"
          fi

      - name: Upload image artifacts
        uses: actions/upload-artifact@v4
        with:
          name: images-${{ needs.initialize.outputs.article_id }}
          path: |
            output/${{ needs.initialize.outputs.article_id }}/images
            imagen/
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–9: æœ€çµ‚å‡¦ç†ï¼ˆ4ã¤ã®æˆæœç‰©ã®ã¿ï¼‰
  finalize:
    needs: [initialize, analysis, research-merge, generate-structure, generate-content, factcheck, generate-images]
    if: always()
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: Create final package with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            V4ã®æœ€çµ‚ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®4ã¤ã®æˆæœç‰©ã®ã¿ã‚’æ•´ç†ã—ã¦ãã ã•ã„ï¼š
            
            V4æœ€çµ‚æˆæœç‰©:
            1. research_results.json - ãƒªã‚µãƒ¼ãƒçµæœ
            2. factcheck_report.json - ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯å“è³ªã‚¹ã‚³ã‚¢
            3. images/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª - ç”Ÿæˆç”»åƒç¾¤
            4. final_article.md - æœ€çµ‚è¨˜äº‹ï¼ˆMarkdownï¼‰
            
            ã‚¿ã‚¹ã‚¯:
            1. ä¸Šè¨˜4ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
            2. V4_deliverables.md ã‚’ä½œæˆ:
               - 4ã¤ã®æˆæœç‰©ã®èª¬æ˜
               - ãƒšãƒ«ã‚½ãƒŠæœ€é©åŒ–ã®ãƒã‚¤ãƒ³ãƒˆ
               - å“è³ªã‚¹ã‚³ã‚¢ã®ã‚µãƒãƒªãƒ¼
               - ä½¿ç”¨ç”»åƒã®ãƒªã‚¹ãƒˆ
            3. ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã¯å‰Šé™¤ã—ãªã„ï¼ˆåˆ¶ä½œå´ã§é¸æŠï¼‰
          
          allowed_tools: |
            Read,
            Write,
            Edit
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
          
          max_turns: "20"

      # Google Drive upload removed - using GitHub Artifacts only

      - name: Create workflow summary
        if: always()
        run: |
          ARTICLE_DIR="output/${{ needs.initialize.outputs.article_id }}"
          
          echo "## ğŸ“ Article Generation V4 Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Input Parameters" >> $GITHUB_STEP_SUMMARY
          echo "- **Title**: ${{ inputs.article_title }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Persona**: ${{ inputs.target_persona }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Keywords**: ${{ inputs.meta_keywords }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ¯ V4 Deliverables" >> $GITHUB_STEP_SUMMARY
          echo "1. **research_results.json** - Research data with reliability scores" >> $GITHUB_STEP_SUMMARY
          echo "2. **factcheck_report.json** - Quality scores and fact-checking results" >> $GITHUB_STEP_SUMMARY
          echo "3. **images/** - Generated images (hero + section images)" >> $GITHUB_STEP_SUMMARY  
          echo "4. **final_article.md** - Pure Markdown article (SEO handled by production team)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "$ARTICLE_DIR/V4_deliverables.md" ]; then
            echo "### ğŸ“Š Generation Summary" >> $GITHUB_STEP_SUMMARY
            cat "$ARTICLE_DIR/V4_deliverables.md" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "$ARTICLE_DIR/images" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ–¼ï¸ Generated Images" >> $GITHUB_STEP_SUMMARY
            echo "- Image count: $(find $ARTICLE_DIR/images -name "*.png" -o -name "*.jpg" | wc -l)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create organized final package
        run: |
          ARTICLE_DIR="output/${{ needs.initialize.outputs.article_id }}"
          FINAL_DIR="final_package"
          
          # è©³ç´°ãƒ‡ãƒãƒƒã‚°: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo "====== FINAL PACKAGE CREATION DEBUG ======"
          echo "ğŸ” ARTICLE_DIR: $ARTICLE_DIR"
          echo "ğŸ“ Article directory check:"
          [ -d "$ARTICLE_DIR" ] && echo "âœ… Directory exists" || echo "âŒ Directory NOT found"
          
          echo ""
          echo "ğŸ“‹ All downloaded artifacts and files:"
          find . -name "*.json" -o -name "*.md" -o -name "*.png" -o -name "*.jpg" | head -20
          
          echo ""
          echo "ğŸ” Current working directory contents:"
          ls -la
          
          echo ""
          echo "ğŸ” Output directory contents:"
          if [ -d "output/" ]; then
            find output/ -type f | head -20
          else
            echo "âŒ No output directory found"
          fi
          
          echo "=============================================="
          
          # æœ€çµ‚ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p $FINAL_DIR
          
          # V4ã®4ã¤ã®æˆæœç‰©ã‚’åé›†ï¼ˆã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰ç›´æ¥ï¼‰
          echo ""
          echo "ğŸ”„ Collecting V4 deliverables from artifacts..."
          
          # 1. ãƒ¡ã‚¤ãƒ³è¨˜äº‹ (Markdown) - ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰æ¤œç´¢
          ARTICLE_FOUND=false
          
          # è¤‡æ•°ã®å ´æ‰€ã‹ã‚‰è¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
          POSSIBLE_ARTICLES=(
            "$ARTICLE_DIR/final_article.md"
            "$ARTICLE_DIR/04_draft_article.md" 
            "$ARTICLE_DIR/article.md"
            "final_article.md"
            "04_draft_article.md"
            "article.md"
          )
          
          for article_path in "${POSSIBLE_ARTICLES[@]}"; do
            if [ -f "$article_path" ]; then
              cp "$article_path" "$FINAL_DIR/article.md"
              echo "âœ… Found and copied article: $article_path ($(wc -c < "$article_path") bytes)"
              ARTICLE_FOUND=true
              break
            fi
          done
          
          # è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯.mdãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
          if [ "$ARTICLE_FOUND" = false ]; then
            echo "âš ï¸ Standard article files not found, searching for any .md files..."
            MD_FILE=$(find . -name "*.md" -type f ! -name "README.md" | head -1)
            if [ -n "$MD_FILE" ]; then
              cp "$MD_FILE" "$FINAL_DIR/article.md"
              echo "âœ… Using fallback .md file: $MD_FILE ($(wc -c < "$MD_FILE") bytes)"
              ARTICLE_FOUND=true
            fi
          fi
          
          if [ "$ARTICLE_FOUND" = false ]; then
            echo "âŒ ERROR: No article file found in any location!"
            echo "Creating minimal article as last resort..."
            cat > "$FINAL_DIR/article.md" << 'EOF'
# è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼
è¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
EOF
          fi
          
          # 2. ãƒªã‚µãƒ¼ãƒçµæœ - è¤‡æ•°ã®å ´æ‰€ã‹ã‚‰æ¤œç´¢
          RESEARCH_LOCATIONS=(
            "$ARTICLE_DIR/research_results.json"
            "research_results.json"
            "research-*.json"
          )
          
          RESEARCH_FOUND=false
          for loc in "${RESEARCH_LOCATIONS[@]}"; do
            if [ -f "$loc" ]; then
              cp "$loc" "$FINAL_DIR/research_results.json"
              echo "âœ… Found research results: $loc"
              RESEARCH_FOUND=true
              break
            fi
          done
          
          if [ "$RESEARCH_FOUND" = false ]; then
            # æ¤œç´¢ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨
            RESEARCH_FILE=$(find . -name "*research*.json" | head -1)
            if [ -n "$RESEARCH_FILE" ]; then
              cp "$RESEARCH_FILE" "$FINAL_DIR/research_results.json"
              echo "âœ… Using research file: $RESEARCH_FILE"
            else
              echo "âš ï¸ No research results found"
            fi
          fi
          
          # 3. ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯å“è³ªãƒ¬ãƒãƒ¼ãƒˆ - è¤‡æ•°ã®å ´æ‰€ã‹ã‚‰æ¤œç´¢
          FACTCHECK_LOCATIONS=(
            "$ARTICLE_DIR/factcheck_report.json"
            "factcheck_report.json"
            "factcheck-*.json"
          )
          
          FACTCHECK_FOUND=false
          for loc in "${FACTCHECK_LOCATIONS[@]}"; do
            if [ -f "$loc" ]; then
              cp "$loc" "$FINAL_DIR/factcheck_report.json"
              echo "âœ… Found factcheck report: $loc"
              FACTCHECK_FOUND=true
              break
            fi
          done
          
          if [ "$FACTCHECK_FOUND" = false ]; then
            # æ¤œç´¢ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨
            FACTCHECK_FILE=$(find . -name "*factcheck*.json" | head -1)
            if [ -n "$FACTCHECK_FILE" ]; then
              cp "$FACTCHECK_FILE" "$FINAL_DIR/factcheck_report.json"
              echo "âœ… Using factcheck file: $FACTCHECK_FILE"
            else
              echo "âš ï¸ No factcheck report found"
            fi
          fi
          
          # 4. ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ - è¤‡æ•°ã®å ´æ‰€ã‹ã‚‰æ¤œç´¢
          mkdir -p "$FINAL_DIR/images"
          IMAGES_FOUND=false
          
          # æ¨™æº–çš„ãªç”»åƒãƒ•ã‚©ãƒ«ãƒ€ã®å ´æ‰€
          if [ -d "$ARTICLE_DIR/images" ]; then
            cp -r "$ARTICLE_DIR/images/"* "$FINAL_DIR/images/" 2>/dev/null || true
            echo "âœ… Found images in $ARTICLE_DIR/images"
            IMAGES_FOUND=true
          fi
          
          # ãã®ä»–ã®å ´æ‰€ã‹ã‚‰ç”»åƒã‚’æ¤œç´¢
          if [ "$IMAGES_FOUND" = false ]; then
            find . -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | while read img; do
              if [[ "$img" != *"README"* ]]; then
                cp "$img" "$FINAL_DIR/images/" 2>/dev/null || true
                echo "âœ… Found image: $img"
                IMAGES_FOUND=true
              fi
            done
          fi
          
          # V4æˆæœç‰©èª¬æ˜
          if [ -f "$ARTICLE_DIR/V4_deliverables.md" ]; then
            cp "$ARTICLE_DIR/V4_deliverables.md" "$FINAL_DIR/deliverables.md"
          fi
          
          # æœ€çµ‚ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å†…å®¹ç¢ºèª
          echo ""
          echo "ğŸ“¦ Final package contents:"
          find "$FINAL_DIR" -type f -exec ls -la {} \;
          
          # READMEä½œæˆ
          cat > $FINAL_DIR/README.md << EOF
          # V4 è¨˜äº‹ç”Ÿæˆå®Œäº†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆåˆ¶ä½œå‘ã‘ç°¡æ˜“ç‰ˆï¼‰
          
          **è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«**: ${{ inputs.article_title }}
          **ç”Ÿæˆæ—¥æ™‚**: $(date +%Y-%m-%d\ %H:%M:%S)
          **è¨˜äº‹ID**: ${{ needs.initialize.outputs.article_id }}
          
          ## ğŸ“ V4æˆæœç‰©ï¼ˆ4ç‚¹ï¼‰
          
          1. **article.md** - è¨˜äº‹æœ¬æ–‡ï¼ˆç´”ç²‹ãªMarkdownã€SEOæ§‹é€ åŒ–ãªã—ï¼‰
          2. **research_results.json** - ãƒªã‚µãƒ¼ãƒçµæœï¼ˆä¿¡é ¼æ€§ã‚¹ã‚³ã‚¢ä»˜ãï¼‰
          3. **factcheck_report.json** - ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯å“è³ªã‚¹ã‚³ã‚¢ï¼ˆ0-100ç‚¹ï¼‰
          4. **images/** - ç”Ÿæˆç”»åƒï¼ˆãƒ’ãƒ¼ãƒ­ãƒ¼1æš + ã‚»ã‚¯ã‚·ãƒ§ãƒ³4æšï¼‰
          
          ## ğŸ¯ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæƒ…å ±
          
          - **ãƒšãƒ«ã‚½ãƒŠ**: ${{ inputs.target_persona }}
          - **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰**: ${{ inputs.meta_keywords }}
          
          ## ğŸ“ å‚™è€ƒ
          
          SEOæ§‹é€ åŒ–ã¨HTMLå¤‰æ›ã¯åˆ¶ä½œå´ã§å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚
          EOF
          
          echo "ğŸ“¦ V4 final package created in: $FINAL_DIR"
          ls -la $FINAL_DIR/

      - name: Upload final package
        uses: actions/upload-artifact@v4
        with:
          name: FINAL_V4_ARTICLE_PACKAGE
          path: final_package
          retention-days: 30

  # é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  notify:
    needs: [initialize, finalize]
    if: always() && vars.SLACK_WEBHOOK != ''
    runs-on: ubuntu-latest
    
    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          STATUS="${{ needs.finalize.result }}"
          COLOR="good"
          EMOJI="âœ…"
          
          if [ "$STATUS" != "success" ]; then
            COLOR="danger"
            EMOJI="âŒ"
          fi
          
          curl -X POST $SLACK_WEBHOOK \
            -H 'Content-type: application/json' \
            -d '{
              "attachments": [{
                "color": "'$COLOR'",
                "title": "'$EMOJI' Article Generation V4 '$STATUS'",
                "fields": [
                  {"title": "Title", "value": "'"${{ inputs.article_title }}"'", "short": false},
                  {"title": "Persona", "value": "'"${{ inputs.target_persona }}"'", "short": false},
                  {"title": "Deliverables", "value": "research_results.json, factcheck_report.json, images/, final_article.md", "short": false},
                  {"title": "Workflow", "value": "'"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"'", "short": false}
                ]
              }]
            }'