name: Article Generation V4 Test (Factcheck & SEO)

on:
  workflow_dispatch:
    inputs:
      article_title:
        description: '記事タイトル'
        required: true
        type: string
        default: 'テスト記事：爪のケア方法'

env:
  PYTHON_VERSION: '3.11'

jobs:
  # テスト用の簡易ジョブ
  test-factcheck-seo:
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          # テスト用のディレクトリ構造を作成
          TEST_ID="test-$(date +%Y%m%d%H%M%S)"
          mkdir -p output/$TEST_ID
          
          # テスト用の記事を作成
          cat > output/$TEST_ID/final_article.md << 'EOF'
          # 爪が薄い・割れやすい悩みを解決する専門ケアとは？

          爪の健康は多くの方にとって重要な関心事です。この記事では、専門的な観点から実践的なケア方法について解説いたします。

          ## 爪が薄くなる原因

          研究によると、爪が薄くなる主な原因は以下の通りです：

          1. **栄養不足** - 特にタンパク質、ビオチン、鉄分の不足
          2. **外的要因** - 過度な水仕事、洗剤の使用
          3. **加齢** - 年齢とともに爪の成長が遅くなる

          ## 効果的なケア方法

          ### 栄養補給
          - タンパク質を1日50g以上摂取
          - ビオチンサプリメントの活用（1日30μg）
          - 鉄分豊富な食材の摂取

          ### 外的ケア
          - ネイルオイルでの保湿（1日2回）
          - ゴム手袋の使用
          - 爪切りではなくやすりの使用

          ## まとめ

          爪の健康は日々のケアの積み重ねが大切です。栄養と保湿を中心としたケアを継続することで、健康的な爪を維持できます。
          EOF

          # テスト用のリサーチ結果を作成
          cat > output/$TEST_ID/research_results.json << 'EOF'
          {
            "results": [
              {
                "query": "爪 薄い 原因",
                "results": [
                  {
                    "url": "https://www.mhlw.go.jp/example",
                    "title": "爪の健康に関する調査",
                    "source_type": "government",
                    "reliability_score": 9,
                    "key_findings": ["タンパク質不足が主要因", "ビオチン摂取の重要性"]
                  }
                ]
              }
            ],
            "high_reliability_sources": [
              {
                "url": "https://www.mhlw.go.jp/example",
                "source_type": "government",
                "reliability_score": 9
              }
            ]
          }
          EOF

          # テスト用の入力パラメータを作成
          cat > output/$TEST_ID/input_params.json << 'EOF'
          {
            "article_title": "爪が薄い・割れやすい悩みを解決する専門ケアとは？",
            "target_persona": "30代女性、健康意識が高い",
            "meta_keywords": "爪 薄い,爪 割れやすい,爪 ケア,ネイルケア",
            "word_count": "3200"
          }
          EOF

          # テスト用の分析結果を作成
          cat > output/$TEST_ID/phase1_output.json << 'EOF'
          {
            "analysis": {
              "main_keyword": "爪 薄い",
              "search_intent": "爪が薄い原因と改善方法を知りたい"
            }
          }
          EOF

          echo "TEST_ID=$TEST_ID" >> $GITHUB_ENV
          echo "✅ Test environment created with ID: $TEST_ID"

      - name: Show test environment
        run: |
          echo "TEST_ID: ${{ env.TEST_ID }}"
          echo "Current directory: $(pwd)"
          echo "Working directory: ${{ github.workspace }}"
          echo "Output directory contents:"
          ls -la output/${{ env.TEST_ID }}/
          echo "Full path: $(pwd)/output/${{ env.TEST_ID }}"

      # Factcheckジョブのテスト
      - name: Test Factcheck Generation
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            1. Readツールで output/${{ env.TEST_ID }}/final_article.md を読み込む
            2. Readツールで output/${{ env.TEST_ID }}/research_results.json を読み込む
            3. 記事の内容を簡単に分析（事実確認、薬機法チェック）
            4. Writeツールで output/${{ env.TEST_ID }}/factcheck_report.json を作成
            
            factcheck_report.jsonの内容:
            ```json
            {
              "overall_quality_score": 85,
              "fact_accuracy_score": 90,
              "legal_compliance_score": 95,
              "scientific_validity_score": 80,
              "source_reliability_score": 85,
              "issues_found": [],
              "recommendations": ["継続的なケアの重要性を強調", "専門家への相談を推奨"],
              "timestamp": "2025-01-29T03:00:00Z",
              "total_issues": 0,
              "corrected_issues": 0
            }
            ```
          
          allowed_tools: |
            Read,
            Write,
            Edit
          
          claude_env: |
            ARTICLE_ID=${{ env.TEST_ID }}
            WORKING_DIR=/home/runner/work/article-flow/article-flow
          
          max_turns: "10"

      - name: Verify Factcheck Output
        run: |
          echo "🔍 Checking factcheck output..."
          if [ -f "output/${{ env.TEST_ID }}/factcheck_report.json" ]; then
            echo "✅ factcheck_report.json created successfully"
            echo "📄 Content:"
            cat output/${{ env.TEST_ID }}/factcheck_report.json | jq '.' || cat output/${{ env.TEST_ID }}/factcheck_report.json
          else
            echo "❌ factcheck_report.json NOT found!"
            echo "📁 Contents of test directory:"
            ls -la output/${{ env.TEST_ID }}/
          fi

      # SEOメタジョブのテスト
      - name: Test SEO Metadata Generation
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            1. Readツールで output/${{ env.TEST_ID }}/final_article.md を読み込む
            2. Readツールで output/${{ env.TEST_ID }}/input_params.json を読み込む
            3. 記事タイトルとメタキーワードを抽出
            4. Writeツールで output/${{ env.TEST_ID }}/seo_metadata.json を作成
            
            seo_metadata.jsonの内容:
            ```json
            {
              "title": "爪が薄い・割れやすい悩みを解決する専門ケアとは？",
              "meta_description": "爪が薄くて割れやすい悩みを持つ方へ。栄養補給と外的ケアの両面から、健康的な爪を育てる専門的なケア方法を詳しく解説します。",
              "meta_keywords": ["爪 薄い", "爪 割れやすい", "爪 ケア", "ネイルケア"],
              "og_title": "爪が薄い・割れやすい悩みを解決する専門ケアとは？",
              "og_description": "爪の健康を取り戻す実践的なケア方法",
              "focus_keyword": "爪 薄い",
              "secondary_keywords": ["爪 割れやすい", "爪 ケア"],
              "keyword_density": {
                "爪 薄い": 2.5,
                "爪 ケア": 1.8
              },
              "schema_type": "Article",
              "estimated_reading_time": "5分",
              "word_count": 3200,
              "created_at": "2025-01-29T03:00:00Z"
            }
            ```
          
          allowed_tools: |
            Read,
            Write
          
          claude_env: |
            ARTICLE_ID=${{ env.TEST_ID }}
            WORKING_DIR=/home/runner/work/article-flow/article-flow
            WORD_COUNT=3200
          
          max_turns: "5"

      - name: Verify SEO Metadata Output
        run: |
          echo "🔍 Checking SEO metadata output..."
          if [ -f "output/${{ env.TEST_ID }}/seo_metadata.json" ]; then
            echo "✅ seo_metadata.json created successfully"
            echo "📄 Content:"
            cat output/${{ env.TEST_ID }}/seo_metadata.json | jq '.' || cat output/${{ env.TEST_ID }}/seo_metadata.json
          else
            echo "❌ seo_metadata.json NOT found!"
            echo "📁 Contents of test directory:"
            ls -la output/${{ env.TEST_ID }}/
          fi

      - name: Final Test Summary
        run: |
          echo "=============================================="
          echo "📊 TEST SUMMARY"
          echo "=============================================="
          
          FACTCHECK_EXISTS=false
          SEO_EXISTS=false
          
          if [ -f "output/${{ env.TEST_ID }}/factcheck_report.json" ]; then
            FACTCHECK_EXISTS=true
          fi
          
          if [ -f "output/${{ env.TEST_ID }}/seo_metadata.json" ]; then
            SEO_EXISTS=true
          fi
          
          echo "✅ Test Article Created: output/${{ env.TEST_ID }}/final_article.md"
          echo "✅ Research Results Created: output/${{ env.TEST_ID }}/research_results.json"
          
          if [ "$FACTCHECK_EXISTS" = true ]; then
            echo "✅ Factcheck Report: CREATED"
          else
            echo "❌ Factcheck Report: MISSING"
          fi
          
          if [ "$SEO_EXISTS" = true ]; then
            echo "✅ SEO Metadata: CREATED"
          else
            echo "❌ SEO Metadata: MISSING"
          fi
          
          echo ""
          echo "📁 All files in test directory:"
          ls -la output/${{ env.TEST_ID }}/
          
          # 両方のファイルが存在する場合のみ成功
          if [ "$FACTCHECK_EXISTS" = true ] && [ "$SEO_EXISTS" = true ]; then
            echo ""
            echo "🎉 ALL TESTS PASSED!"
            exit 0
          else
            echo ""
            echo "❌ TESTS FAILED - Some files are missing"
            exit 1
          fi

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ env.TEST_ID }}
          path: output/${{ env.TEST_ID }}
          retention-days: 7