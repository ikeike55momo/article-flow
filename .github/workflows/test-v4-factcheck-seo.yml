name: Article Generation V4 Test (Factcheck & SEO)

on:
  workflow_dispatch:
    inputs:
      article_title:
        description: 'è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«'
        required: true
        type: string
        default: 'ãƒ†ã‚¹ãƒˆè¨˜äº‹ï¼šçˆªã®ã‚±ã‚¢æ–¹æ³•'

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ãƒ†ã‚¹ãƒˆç”¨ã®ç°¡æ˜“ã‚¸ãƒ§ãƒ–
  test-factcheck-seo:
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          # ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ä½œæˆ
          TEST_ID="test-$(date +%Y%m%d%H%M%S)"
          mkdir -p output/$TEST_ID
          
          # ãƒ†ã‚¹ãƒˆç”¨ã®è¨˜äº‹ã‚’ä½œæˆ
          cat > output/$TEST_ID/final_article.md << 'EOF'
          # çˆªãŒè–„ã„ãƒ»å‰²ã‚Œã‚„ã™ã„æ‚©ã¿ã‚’è§£æ±ºã™ã‚‹å°‚é–€ã‚±ã‚¢ã¨ã¯ï¼Ÿ

          çˆªã®å¥åº·ã¯å¤šãã®æ–¹ã«ã¨ã£ã¦é‡è¦ãªé–¢å¿ƒäº‹ã§ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯ã€å°‚é–€çš„ãªè¦³ç‚¹ã‹ã‚‰å®Ÿè·µçš„ãªã‚±ã‚¢æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬ã„ãŸã—ã¾ã™ã€‚

          ## çˆªãŒè–„ããªã‚‹åŸå› 

          ç ”ç©¶ã«ã‚ˆã‚‹ã¨ã€çˆªãŒè–„ããªã‚‹ä¸»ãªåŸå› ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š

          1. **æ „é¤Šä¸è¶³** - ç‰¹ã«ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã€ãƒ“ã‚ªãƒãƒ³ã€é‰„åˆ†ã®ä¸è¶³
          2. **å¤–çš„è¦å› ** - éåº¦ãªæ°´ä»•äº‹ã€æ´—å‰¤ã®ä½¿ç”¨
          3. **åŠ é½¢** - å¹´é½¢ã¨ã¨ã‚‚ã«çˆªã®æˆé•·ãŒé…ããªã‚‹

          ## åŠ¹æœçš„ãªã‚±ã‚¢æ–¹æ³•

          ### æ „é¤Šè£œçµ¦
          - ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã‚’1æ—¥50gä»¥ä¸Šæ‘‚å–
          - ãƒ“ã‚ªãƒãƒ³ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆã®æ´»ç”¨ï¼ˆ1æ—¥30Î¼gï¼‰
          - é‰„åˆ†è±Šå¯Œãªé£Ÿæã®æ‘‚å–

          ### å¤–çš„ã‚±ã‚¢
          - ãƒã‚¤ãƒ«ã‚ªã‚¤ãƒ«ã§ã®ä¿æ¹¿ï¼ˆ1æ—¥2å›ï¼‰
          - ã‚´ãƒ æ‰‹è¢‹ã®ä½¿ç”¨
          - çˆªåˆ‡ã‚Šã§ã¯ãªãã‚„ã™ã‚Šã®ä½¿ç”¨

          ## ã¾ã¨ã‚

          çˆªã®å¥åº·ã¯æ—¥ã€…ã®ã‚±ã‚¢ã®ç©ã¿é‡ã­ãŒå¤§åˆ‡ã§ã™ã€‚æ „é¤Šã¨ä¿æ¹¿ã‚’ä¸­å¿ƒã¨ã—ãŸã‚±ã‚¢ã‚’ç¶™ç¶šã™ã‚‹ã“ã¨ã§ã€å¥åº·çš„ãªçˆªã‚’ç¶­æŒã§ãã¾ã™ã€‚
          EOF

          # ãƒ†ã‚¹ãƒˆç”¨ã®ãƒªã‚µãƒ¼ãƒçµæœã‚’ä½œæˆ
          cat > output/$TEST_ID/research_results.json << 'EOF'
          {
            "results": [
              {
                "query": "çˆª è–„ã„ åŸå› ",
                "results": [
                  {
                    "url": "https://www.mhlw.go.jp/example",
                    "title": "çˆªã®å¥åº·ã«é–¢ã™ã‚‹èª¿æŸ»",
                    "source_type": "government",
                    "reliability_score": 9,
                    "key_findings": ["ã‚¿ãƒ³ãƒ‘ã‚¯è³ªä¸è¶³ãŒä¸»è¦å› ", "ãƒ“ã‚ªãƒãƒ³æ‘‚å–ã®é‡è¦æ€§"]
                  }
                ]
              }
            ],
            "high_reliability_sources": [
              {
                "url": "https://www.mhlw.go.jp/example",
                "source_type": "government",
                "reliability_score": 9
              }
            ]
          }
          EOF

          # ãƒ†ã‚¹ãƒˆç”¨ã®å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½œæˆ
          cat > output/$TEST_ID/input_params.json << 'EOF'
          {
            "article_title": "çˆªãŒè–„ã„ãƒ»å‰²ã‚Œã‚„ã™ã„æ‚©ã¿ã‚’è§£æ±ºã™ã‚‹å°‚é–€ã‚±ã‚¢ã¨ã¯ï¼Ÿ",
            "target_persona": "30ä»£å¥³æ€§ã€å¥åº·æ„è­˜ãŒé«˜ã„",
            "meta_keywords": "çˆª è–„ã„,çˆª å‰²ã‚Œã‚„ã™ã„,çˆª ã‚±ã‚¢,ãƒã‚¤ãƒ«ã‚±ã‚¢",
            "word_count": "3200"
          }
          EOF

          # ãƒ†ã‚¹ãƒˆç”¨ã®åˆ†æçµæœã‚’ä½œæˆ
          cat > output/$TEST_ID/phase1_output.json << 'EOF'
          {
            "analysis": {
              "main_keyword": "çˆª è–„ã„",
              "search_intent": "çˆªãŒè–„ã„åŸå› ã¨æ”¹å–„æ–¹æ³•ã‚’çŸ¥ã‚ŠãŸã„"
            }
          }
          EOF

          echo "TEST_ID=$TEST_ID" >> $GITHUB_ENV
          echo "âœ… Test environment created with ID: $TEST_ID"

      - name: Show test environment
        run: |
          echo "TEST_ID: ${{ env.TEST_ID }}"
          echo "Current directory: $(pwd)"
          echo "Working directory: ${{ github.workspace }}"
          echo "Output directory contents:"
          ls -la output/${{ env.TEST_ID }}/
          echo "Full path: $(pwd)/output/${{ env.TEST_ID }}"

      # Factcheckã‚¸ãƒ§ãƒ–ã®ãƒ†ã‚¹ãƒˆ
      - name: Test Factcheck Generation
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            1. Readãƒ„ãƒ¼ãƒ«ã§ output/${{ env.TEST_ID }}/final_article.md ã‚’èª­ã¿è¾¼ã‚€
            2. Readãƒ„ãƒ¼ãƒ«ã§ output/${{ env.TEST_ID }}/research_results.json ã‚’èª­ã¿è¾¼ã‚€
            3. è¨˜äº‹ã®å†…å®¹ã‚’ç°¡å˜ã«åˆ†æï¼ˆäº‹å®Ÿç¢ºèªã€è–¬æ©Ÿæ³•ãƒã‚§ãƒƒã‚¯ï¼‰
            4. Writeãƒ„ãƒ¼ãƒ«ã§ output/${{ env.TEST_ID }}/factcheck_report.json ã‚’ä½œæˆ
            
            factcheck_report.jsonã®å†…å®¹:
            ```json
            {
              "overall_quality_score": 85,
              "fact_accuracy_score": 90,
              "legal_compliance_score": 95,
              "scientific_validity_score": 80,
              "source_reliability_score": 85,
              "issues_found": [],
              "recommendations": ["ç¶™ç¶šçš„ãªã‚±ã‚¢ã®é‡è¦æ€§ã‚’å¼·èª¿", "å°‚é–€å®¶ã¸ã®ç›¸è«‡ã‚’æ¨å¥¨"],
              "timestamp": "2025-01-29T03:00:00Z",
              "total_issues": 0,
              "corrected_issues": 0
            }
            ```
          
          allowed_tools: |
            Read,
            Write,
            Edit
          
          claude_env: |
            ARTICLE_ID=${{ env.TEST_ID }}
            WORKING_DIR=/home/runner/work/article-flow/article-flow
          
          max_turns: "10"

      - name: Verify Factcheck Output
        run: |
          echo "ğŸ” Checking factcheck output..."
          if [ -f "output/${{ env.TEST_ID }}/factcheck_report.json" ]; then
            echo "âœ… factcheck_report.json created successfully"
            echo "ğŸ“„ Content:"
            cat output/${{ env.TEST_ID }}/factcheck_report.json | jq '.' || cat output/${{ env.TEST_ID }}/factcheck_report.json
          else
            echo "âŒ factcheck_report.json NOT found!"
            echo "ğŸ“ Contents of test directory:"
            ls -la output/${{ env.TEST_ID }}/
          fi

      # SEOãƒ¡ã‚¿ã‚¸ãƒ§ãƒ–ã®ãƒ†ã‚¹ãƒˆ
      - name: Test SEO Metadata Generation
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            1. Readãƒ„ãƒ¼ãƒ«ã§ output/${{ env.TEST_ID }}/final_article.md ã‚’èª­ã¿è¾¼ã‚€
            2. Readãƒ„ãƒ¼ãƒ«ã§ output/${{ env.TEST_ID }}/input_params.json ã‚’èª­ã¿è¾¼ã‚€
            3. è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ¡ã‚¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡º
            4. Writeãƒ„ãƒ¼ãƒ«ã§ output/${{ env.TEST_ID }}/seo_metadata.json ã‚’ä½œæˆ
            
            seo_metadata.jsonã®å†…å®¹:
            ```json
            {
              "title": "çˆªãŒè–„ã„ãƒ»å‰²ã‚Œã‚„ã™ã„æ‚©ã¿ã‚’è§£æ±ºã™ã‚‹å°‚é–€ã‚±ã‚¢ã¨ã¯ï¼Ÿ",
              "meta_description": "çˆªãŒè–„ãã¦å‰²ã‚Œã‚„ã™ã„æ‚©ã¿ã‚’æŒã¤æ–¹ã¸ã€‚æ „é¤Šè£œçµ¦ã¨å¤–çš„ã‚±ã‚¢ã®ä¸¡é¢ã‹ã‚‰ã€å¥åº·çš„ãªçˆªã‚’è‚²ã¦ã‚‹å°‚é–€çš„ãªã‚±ã‚¢æ–¹æ³•ã‚’è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚",
              "meta_keywords": ["çˆª è–„ã„", "çˆª å‰²ã‚Œã‚„ã™ã„", "çˆª ã‚±ã‚¢", "ãƒã‚¤ãƒ«ã‚±ã‚¢"],
              "og_title": "çˆªãŒè–„ã„ãƒ»å‰²ã‚Œã‚„ã™ã„æ‚©ã¿ã‚’è§£æ±ºã™ã‚‹å°‚é–€ã‚±ã‚¢ã¨ã¯ï¼Ÿ",
              "og_description": "çˆªã®å¥åº·ã‚’å–ã‚Šæˆ»ã™å®Ÿè·µçš„ãªã‚±ã‚¢æ–¹æ³•",
              "focus_keyword": "çˆª è–„ã„",
              "secondary_keywords": ["çˆª å‰²ã‚Œã‚„ã™ã„", "çˆª ã‚±ã‚¢"],
              "keyword_density": {
                "çˆª è–„ã„": 2.5,
                "çˆª ã‚±ã‚¢": 1.8
              },
              "schema_type": "Article",
              "estimated_reading_time": "5åˆ†",
              "word_count": 3200,
              "created_at": "2025-01-29T03:00:00Z"
            }
            ```
          
          allowed_tools: |
            Read,
            Write
          
          claude_env: |
            ARTICLE_ID=${{ env.TEST_ID }}
            WORKING_DIR=/home/runner/work/article-flow/article-flow
            WORD_COUNT=3200
          
          max_turns: "5"

      - name: Verify SEO Metadata Output
        run: |
          echo "ğŸ” Checking SEO metadata output..."
          if [ -f "output/${{ env.TEST_ID }}/seo_metadata.json" ]; then
            echo "âœ… seo_metadata.json created successfully"
            echo "ğŸ“„ Content:"
            cat output/${{ env.TEST_ID }}/seo_metadata.json | jq '.' || cat output/${{ env.TEST_ID }}/seo_metadata.json
          else
            echo "âŒ seo_metadata.json NOT found!"
            echo "ğŸ“ Contents of test directory:"
            ls -la output/${{ env.TEST_ID }}/
          fi

      - name: Final Test Summary
        run: |
          echo "=============================================="
          echo "ğŸ“Š TEST SUMMARY"
          echo "=============================================="
          
          FACTCHECK_EXISTS=false
          SEO_EXISTS=false
          
          if [ -f "output/${{ env.TEST_ID }}/factcheck_report.json" ]; then
            FACTCHECK_EXISTS=true
          fi
          
          if [ -f "output/${{ env.TEST_ID }}/seo_metadata.json" ]; then
            SEO_EXISTS=true
          fi
          
          echo "âœ… Test Article Created: output/${{ env.TEST_ID }}/final_article.md"
          echo "âœ… Research Results Created: output/${{ env.TEST_ID }}/research_results.json"
          
          if [ "$FACTCHECK_EXISTS" = true ]; then
            echo "âœ… Factcheck Report: CREATED"
          else
            echo "âŒ Factcheck Report: MISSING"
          fi
          
          if [ "$SEO_EXISTS" = true ]; then
            echo "âœ… SEO Metadata: CREATED"
          else
            echo "âŒ SEO Metadata: MISSING"
          fi
          
          echo ""
          echo "ğŸ“ All files in test directory:"
          ls -la output/${{ env.TEST_ID }}/
          
          # ä¸¡æ–¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿æˆåŠŸ
          if [ "$FACTCHECK_EXISTS" = true ] && [ "$SEO_EXISTS" = true ]; then
            echo ""
            echo "ğŸ‰ ALL TESTS PASSED!"
            exit 0
          else
            echo ""
            echo "âŒ TESTS FAILED - Some files are missing"
            exit 1
          fi

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ env.TEST_ID }}
          path: output/${{ env.TEST_ID }}
          retention-days: 7