name: Article Generation V4 Test (Factcheck & SEO)

on:
  workflow_dispatch:
    inputs:
      article_title:
        description: 'è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«'
        required: true
        type: string
        default: 'ãƒ†ã‚¹ãƒˆè¨˜äº‹ï¼šçˆªã®ã‚±ã‚¢æ–¹æ³•'

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ãƒ†ã‚¹ãƒˆç”¨ã®ç°¡æ˜“ã‚¸ãƒ§ãƒ–
  test-factcheck-seo:
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          # ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ä½œæˆ
          TEST_ID="test-$(date +%Y%m%d%H%M%S)"
          mkdir -p output/$TEST_ID
          
          # ãƒ†ã‚¹ãƒˆç”¨ã®è¨˜äº‹ã‚’ä½œæˆ
          cat > output/$TEST_ID/final_article.md << 'EOF'
          # çˆªãŒè–„ã„ãƒ»å‰²ã‚Œã‚„ã™ã„æ‚©ã¿ã‚’è§£æ±ºã™ã‚‹å°‚é–€ã‚±ã‚¢ã¨ã¯ï¼Ÿ

          çˆªã®å¥åº·ã¯å¤šãã®æ–¹ã«ã¨ã£ã¦é‡è¦ãªé–¢å¿ƒäº‹ã§ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯ã€å°‚é–€çš„ãªè¦³ç‚¹ã‹ã‚‰å®Ÿè·µçš„ãªã‚±ã‚¢æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬ã„ãŸã—ã¾ã™ã€‚

          ## çˆªãŒè–„ããªã‚‹åŸå› 

          ç ”ç©¶ã«ã‚ˆã‚‹ã¨ã€çˆªãŒè–„ããªã‚‹ä¸»ãªåŸå› ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š

          1. **æ „é¤Šä¸è¶³** - ç‰¹ã«ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã€ãƒ“ã‚ªãƒãƒ³ã€é‰„åˆ†ã®ä¸è¶³
          2. **å¤–çš„è¦å› ** - éåº¦ãªæ°´ä»•äº‹ã€æ´—å‰¤ã®ä½¿ç”¨
          3. **åŠ é½¢** - å¹´é½¢ã¨ã¨ã‚‚ã«çˆªã®æˆé•·ãŒé…ããªã‚‹

          ## åŠ¹æœçš„ãªã‚±ã‚¢æ–¹æ³•

          ### æ „é¤Šè£œçµ¦
          - ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã‚’1æ—¥50gä»¥ä¸Šæ‘‚å–
          - ãƒ“ã‚ªãƒãƒ³ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆã®æ´»ç”¨ï¼ˆ1æ—¥30Î¼gï¼‰
          - é‰„åˆ†è±Šå¯Œãªé£Ÿæã®æ‘‚å–

          ### å¤–çš„ã‚±ã‚¢
          - ãƒã‚¤ãƒ«ã‚ªã‚¤ãƒ«ã§ã®ä¿æ¹¿ï¼ˆ1æ—¥2å›ï¼‰
          - ã‚´ãƒ æ‰‹è¢‹ã®ä½¿ç”¨
          - çˆªåˆ‡ã‚Šã§ã¯ãªãã‚„ã™ã‚Šã®ä½¿ç”¨

          ## ã¾ã¨ã‚

          çˆªã®å¥åº·ã¯æ—¥ã€…ã®ã‚±ã‚¢ã®ç©ã¿é‡ã­ãŒå¤§åˆ‡ã§ã™ã€‚æ „é¤Šã¨ä¿æ¹¿ã‚’ä¸­å¿ƒã¨ã—ãŸã‚±ã‚¢ã‚’ç¶™ç¶šã™ã‚‹ã“ã¨ã§ã€å¥åº·çš„ãªçˆªã‚’ç¶­æŒã§ãã¾ã™ã€‚
          EOF

          # ãƒ†ã‚¹ãƒˆç”¨ã®ãƒªã‚µãƒ¼ãƒçµæœã‚’ä½œæˆ
          cat > output/$TEST_ID/research_results.json << 'EOF'
          {
            "results": [
              {
                "query": "çˆª è–„ã„ åŸå› ",
                "results": [
                  {
                    "url": "https://www.mhlw.go.jp/example",
                    "title": "çˆªã®å¥åº·ã«é–¢ã™ã‚‹èª¿æŸ»",
                    "source_type": "government",
                    "reliability_score": 9,
                    "key_findings": ["ã‚¿ãƒ³ãƒ‘ã‚¯è³ªä¸è¶³ãŒä¸»è¦å› ", "ãƒ“ã‚ªãƒãƒ³æ‘‚å–ã®é‡è¦æ€§"]
                  }
                ]
              }
            ],
            "high_reliability_sources": [
              {
                "url": "https://www.mhlw.go.jp/example",
                "source_type": "government",
                "reliability_score": 9
              }
            ]
          }
          EOF

          # ãƒ†ã‚¹ãƒˆç”¨ã®å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½œæˆ
          cat > output/$TEST_ID/input_params.json << 'EOF'
          {
            "article_title": "çˆªãŒè–„ã„ãƒ»å‰²ã‚Œã‚„ã™ã„æ‚©ã¿ã‚’è§£æ±ºã™ã‚‹å°‚é–€ã‚±ã‚¢ã¨ã¯ï¼Ÿ",
            "target_persona": "30ä»£å¥³æ€§ã€å¥åº·æ„è­˜ãŒé«˜ã„",
            "meta_keywords": "çˆª è–„ã„,çˆª å‰²ã‚Œã‚„ã™ã„,çˆª ã‚±ã‚¢,ãƒã‚¤ãƒ«ã‚±ã‚¢",
            "word_count": "3200"
          }
          EOF

          # ãƒ†ã‚¹ãƒˆç”¨ã®åˆ†æçµæœã‚’ä½œæˆ
          cat > output/$TEST_ID/phase1_output.json << 'EOF'
          {
            "analysis": {
              "main_keyword": "çˆª è–„ã„",
              "search_intent": "çˆªãŒè–„ã„åŸå› ã¨æ”¹å–„æ–¹æ³•ã‚’çŸ¥ã‚ŠãŸã„"
            }
          }
          EOF

          echo "TEST_ID=$TEST_ID" >> $GITHUB_ENV
          echo "âœ… Test environment created with ID: $TEST_ID"

      # Factcheckã‚¸ãƒ§ãƒ–ã®ãƒ†ã‚¹ãƒˆ
      - name: Test Factcheck Generation
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            è¨˜äº‹ã®ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã€å“è³ªã‚¹ã‚³ã‚¢ã‚’ç®—å‡ºã—ã¦ãã ã•ã„ã€‚
            
            ã‚¿ã‚¹ã‚¯:
            1. ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§å†…å®¹ã‚’ç¢ºèª:
               - output/${{ env.TEST_ID }}/final_article.md: è¨˜äº‹æœ¬æ–‡
               - output/${{ env.TEST_ID }}/research_results.json: ãƒªã‚µãƒ¼ãƒçµæœ
            
            2. ä»¥ä¸‹ã®è¦³ç‚¹ã§ãƒã‚§ãƒƒã‚¯:
               - äº‹å®Ÿã®æ­£ç¢ºæ€§ï¼ˆãƒªã‚µãƒ¼ãƒçµæœã¨ã®ç…§åˆï¼‰
               - è–¬æ©Ÿæ³•ãƒ»æ™¯è¡¨æ³•ã®éµå®ˆ
               - æ•°å€¤ã‚„çµ±è¨ˆã®æ­£ç¢ºæ€§
               - åŒ»å­¦çš„ãƒ»ç§‘å­¦çš„ä¸»å¼µã®å¦¥å½“æ€§
            
            3. ä¿®æ­£ãŒå¿…è¦ãªå ´åˆ:
               - final_article.md ã‚’ç›´æ¥ç·¨é›†
            
            4. å“è³ªãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ:
               - output/${{ env.TEST_ID }}/factcheck_report.json ã¨ã—ã¦ä»¥ä¸‹ã®å½¢å¼ã§ä¿å­˜:
               {
                 "overall_quality_score": 85,
                 "fact_accuracy_score": 90,
                 "legal_compliance_score": 95,
                 "scientific_validity_score": 80,
                 "source_reliability_score": 85,
                 "issues_found": [
                   {
                     "type": "fact_error",
                     "description": "å•é¡Œã®èª¬æ˜",
                     "location": "è¨˜äº‹å†…ã®å ´æ‰€",
                     "severity": "high/medium/low",
                     "corrected": true/false
                   }
                 ],
                 "recommendations": ["æ”¹å–„ææ¡ˆ1", "æ”¹å–„ææ¡ˆ2"],
                 "timestamp": "ç¾åœ¨æ™‚åˆ»",
                 "total_issues": 3,
                 "corrected_issues": 2
               }
            
            5. ãƒšãƒ«ã‚½ãƒŠã¸ã®é…æ…®:
               - ãƒšãƒ«ã‚½ãƒŠãŒèª¤è§£ã—ã‚„ã™ã„è¡¨ç¾ã®ä¿®æ­£
               - ã‚ˆã‚Šåˆ†ã‹ã‚Šã‚„ã™ã„èª¬æ˜ã¸ã®æ”¹å–„
            
            ã€é‡è¦ã€‘å¿…ãšWriteãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ output/${{ env.TEST_ID }}/factcheck_report.json ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
            ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¯å®Œå…¨ãƒ‘ã‚¹ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚
          
          allowed_tools: |
            Read,
            Write,
            Edit
          
          claude_env: |
            ARTICLE_ID=${{ env.TEST_ID }}
          
          max_turns: "10"

      - name: Verify Factcheck Output
        run: |
          echo "ğŸ” Checking factcheck output..."
          if [ -f "output/${{ env.TEST_ID }}/factcheck_report.json" ]; then
            echo "âœ… factcheck_report.json created successfully"
            echo "ğŸ“„ Content:"
            cat output/${{ env.TEST_ID }}/factcheck_report.json | jq '.' || cat output/${{ env.TEST_ID }}/factcheck_report.json
          else
            echo "âŒ factcheck_report.json NOT found!"
            echo "ğŸ“ Contents of test directory:"
            ls -la output/${{ env.TEST_ID }}/
          fi

      # SEOãƒ¡ã‚¿ã‚¸ãƒ§ãƒ–ã®ãƒ†ã‚¹ãƒˆ
      - name: Test SEO Metadata Generation
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            è¨˜äº‹ã®SEOãƒ¡ã‚¿æƒ…å ±ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
            
            ã‚¿ã‚¹ã‚¯:
            1. ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§å†…å®¹ã‚’ç†è§£:
               - output/${{ env.TEST_ID }}/final_article.md: è¨˜äº‹æœ¬æ–‡
               - output/${{ env.TEST_ID }}/input_params.json: å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆãƒ¡ã‚¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å«ã‚€ï¼‰
               - output/${{ env.TEST_ID }}/phase1_output.json: åˆ†æçµæœ
            
            2. output/${{ env.TEST_ID }}/seo_metadata.json ã¨ã—ã¦ä»¥ä¸‹ã®å½¢å¼ã§ä¿å­˜:
               {
                 "title": "è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ60æ–‡å­—ä»¥å†…ï¼‰",
                 "meta_description": "è¨˜äº‹ã®è¦ç´„ï¼ˆ120-160æ–‡å­—ï¼‰",
                 "meta_keywords": ["ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰1", "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰2", ...],
                 "og_title": "OGPç”¨ã‚¿ã‚¤ãƒˆãƒ«",
                 "og_description": "OGPç”¨èª¬æ˜æ–‡",
                 "focus_keyword": "ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰",
                 "secondary_keywords": ["ã‚µãƒ–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰1", "ã‚µãƒ–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰2"],
                 "keyword_density": {
                   "ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰": 2.5,
                   "ã‚µãƒ–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰1": 1.2
                 },
                 "schema_type": "Article",
                 "estimated_reading_time": "5åˆ†",
                 "word_count": 3200,
                 "created_at": "ç¾åœ¨æ™‚åˆ»"
               }
            
            3. SEOæœ€é©åŒ–ã®ãƒã‚¤ãƒ³ãƒˆ:
               - ãƒ¡ã‚¿ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã¯æ¤œç´¢çµæœã§è¡¨ç¤ºã•ã‚Œã‚‹é‡è¦ãªè¦ç´ 
               - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯è‡ªç„¶ã«é…ç½®
               - ãƒšãƒ«ã‚½ãƒŠã®æ¤œç´¢æ„å›³ã‚’è€ƒæ…®
               - ç«¶åˆã¨å·®åˆ¥åŒ–ã§ãã‚‹è¡¨ç¾
            
            ã€é‡è¦ã€‘å¿…ãšWriteãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ output/${{ env.TEST_ID }}/seo_metadata.json ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
            ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¯å®Œå…¨ãƒ‘ã‚¹ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚
          
          allowed_tools: |
            Read,
            Write
          
          claude_env: |
            ARTICLE_ID=${{ env.TEST_ID }}
            WORD_COUNT=3200
          
          max_turns: "5"

      - name: Verify SEO Metadata Output
        run: |
          echo "ğŸ” Checking SEO metadata output..."
          if [ -f "output/${{ env.TEST_ID }}/seo_metadata.json" ]; then
            echo "âœ… seo_metadata.json created successfully"
            echo "ğŸ“„ Content:"
            cat output/${{ env.TEST_ID }}/seo_metadata.json | jq '.' || cat output/${{ env.TEST_ID }}/seo_metadata.json
          else
            echo "âŒ seo_metadata.json NOT found!"
            echo "ğŸ“ Contents of test directory:"
            ls -la output/${{ env.TEST_ID }}/
          fi

      - name: Final Test Summary
        run: |
          echo "=============================================="
          echo "ğŸ“Š TEST SUMMARY"
          echo "=============================================="
          
          FACTCHECK_EXISTS=false
          SEO_EXISTS=false
          
          if [ -f "output/${{ env.TEST_ID }}/factcheck_report.json" ]; then
            FACTCHECK_EXISTS=true
          fi
          
          if [ -f "output/${{ env.TEST_ID }}/seo_metadata.json" ]; then
            SEO_EXISTS=true
          fi
          
          echo "âœ… Test Article Created: output/${{ env.TEST_ID }}/final_article.md"
          echo "âœ… Research Results Created: output/${{ env.TEST_ID }}/research_results.json"
          
          if [ "$FACTCHECK_EXISTS" = true ]; then
            echo "âœ… Factcheck Report: CREATED"
          else
            echo "âŒ Factcheck Report: MISSING"
          fi
          
          if [ "$SEO_EXISTS" = true ]; then
            echo "âœ… SEO Metadata: CREATED"
          else
            echo "âŒ SEO Metadata: MISSING"
          fi
          
          echo ""
          echo "ğŸ“ All files in test directory:"
          ls -la output/${{ env.TEST_ID }}/
          
          # ä¸¡æ–¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿æˆåŠŸ
          if [ "$FACTCHECK_EXISTS" = true ] && [ "$SEO_EXISTS" = true ]; then
            echo ""
            echo "ğŸ‰ ALL TESTS PASSED!"
            exit 0
          else
            echo ""
            echo "âŒ TESTS FAILED - Some files are missing"
            exit 1
          fi

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ env.TEST_ID }}
          path: output/${{ env.TEST_ID }}
          retention-days: 7