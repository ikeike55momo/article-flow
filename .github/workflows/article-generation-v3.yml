name: Article Generation V3 (MCP + Imagen4)

on:
  workflow_dispatch:
    inputs:
      article_title:
        description: 'è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«'
        required: true
        type: string
        default: ''
      
      target_persona:
        description: 'ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒšãƒ«ã‚½ãƒŠï¼ˆä¾‹ï¼š30ä»£å¥³æ€§ã€å¥åº·æ„è­˜ãŒé«˜ã„ã€å­è‚²ã¦ä¸­ï¼‰'
        required: true
        type: string
        default: ''
      
      meta_keywords:
        description: 'ãƒ¡ã‚¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚«ãƒ³ãƒžåŒºåˆ‡ã‚Šï¼‰'
        required: true
        type: string
        default: ''
      
      enable_image_generation:
        description: 'ç”»åƒç”Ÿæˆã‚’æœ‰åŠ¹ã«ã™ã‚‹'
        required: false
        type: boolean
        default: true
      
      enable_drive_upload:
        description: 'Google Driveã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ã‚¸ãƒ§ãƒ–1: åˆæœŸåŒ–
  initialize:
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 5
    outputs:
      article_id: ${{ steps.init.outputs.article_id }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize article generation
        id: init
        run: |
          # ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰IDã‚’ç”Ÿæˆ
          CLEAN_TITLE=$(echo "${{ inputs.article_title }}" | sed 's/[^a-zA-Z0-9ã‚-ã‚“ã‚¢-ãƒ³ä¸€-é¾¯]/_/g' | cut -c1-50)
          ARTICLE_ID=$(date +%Y%m%d_%H%M%S)_${CLEAN_TITLE}
          echo "article_id=${ARTICLE_ID}" >> $GITHUB_OUTPUT
          echo "Article ID: ${ARTICLE_ID}"
          
          # å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p output/${ARTICLE_ID}
          
          # å…¥åŠ›æƒ…å ±ã‚’ä¿å­˜
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          cat > output/${ARTICLE_ID}/input_params.json << EOJSON
          {
            "article_id": "${ARTICLE_ID}",
            "title": "${{ inputs.article_title }}",
            "target_persona": "${{ inputs.target_persona }}",
            "meta_keywords": "${{ inputs.meta_keywords }}",
            "created_at": "${TIMESTAMP}"
          }
          EOJSON

      - name: Upload initialization artifacts
        uses: actions/upload-artifact@v4
        with:
          name: init-${{ steps.init.outputs.article_id }}
          path: output/${{ steps.init.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–2: ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ†æž
  analysis:
    needs: initialize
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 10
    outputs:
      main_keyword: ${{ steps.analyze.outputs.main_keyword }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download initialization artifacts
        uses: actions/download-artifact@v4
        with:
          name: init-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd github-actions
          pip install -r requirements.txt

      - name: Create analysis input
        run: |
          cd output/${{ needs.initialize.outputs.article_id }}
          # Phase1ãŒæœŸå¾…ã™ã‚‹å½¢å¼ã®JSONã‚’ä½œæˆ
          cat > request_params.json << EOJSON
          {
            "topic": "${{ inputs.article_title }}",
            "target_audience": "${{ inputs.target_persona }}",
            "keywords": "${{ inputs.meta_keywords }}"
          }
          EOJSON

      - name: Run Phase 1 Analysis with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            è¨˜äº‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åˆ†æžã—ã¦ã€SEOæœ€é©åŒ–ã•ã‚ŒãŸè¨˜äº‹ç”Ÿæˆã®ãŸã‚ã®è©³ç´°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
            
            å…¥åŠ›æƒ…å ±:
            - ãƒˆãƒ”ãƒƒã‚¯: ${{ inputs.article_title }}  
            - ã‚¿ãƒ¼ã‚²ãƒƒãƒˆèª­è€…: ${{ inputs.target_persona }}
            - ãƒ¡ã‚¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${{ inputs.meta_keywords }}
            
            ã‚¿ã‚¹ã‚¯:
            1. output/${{ needs.initialize.outputs.article_id }}/request_params.json ã‚’èª­ã¿è¾¼ã‚“ã§ç†è§£
            2. ä»¥ä¸‹ã®åˆ†æžã‚’å®Ÿè¡Œ:
               - ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ç‰¹å®š
               - é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æŠ½å‡ºï¼ˆ5-8å€‹ï¼‰
               - æ¤œç´¢æ„å›³ã®åˆ†æž
               - ãƒªã‚µãƒ¼ãƒã‚¯ã‚¨ãƒªã®ç”Ÿæˆï¼ˆ15-25å€‹ï¼‰
            
            3. åˆ†æžçµæžœã‚’ output/${{ needs.initialize.outputs.article_id }}/phase1_output.json ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼ˆçµ¶å¯¾ãƒ‘ã‚¹æŒ‡å®šï¼‰
            
            é‡è¦ï¼šä»¥ä¸‹ã®å½¢å¼ã§analysisã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å«ã‚€JSONã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
            {
              "analysis": {
                "main_keyword": "æŠ½å‡ºã—ãŸãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰",
                "related_keywords": ["é–¢é€£1", "é–¢é€£2", "é–¢é€£3", "é–¢é€£4", "é–¢é€£5"],
                "search_intent": "informational",
                "content_type": "how-to", 
                "tone": "friendly",
                "key_points": ["ãƒã‚¤ãƒ³ãƒˆ1", "ãƒã‚¤ãƒ³ãƒˆ2", "ãƒã‚¤ãƒ³ãƒˆ3"],
                "research_queries": ["ã‚¯ã‚¨ãƒª1", "ã‚¯ã‚¨ãƒª2", "ã‚¯ã‚¨ãƒª3", "ã‚¯ã‚¨ãƒª4", "ã‚¯ã‚¨ãƒª5", "ã‚¯ã‚¨ãƒª6", "ã‚¯ã‚¨ãƒª7", "ã‚¯ã‚¨ãƒª8", "ã‚¯ã‚¨ãƒª9", "ã‚¯ã‚¨ãƒª10", "ã‚¯ã‚¨ãƒª11", "ã‚¯ã‚¨ãƒª12", "ã‚¯ã‚¨ãƒª13", "ã‚¯ã‚¨ãƒª14", "ã‚¯ã‚¨ãƒª15"],
                "competitor_analysis_needed": true,
                "local_seo_focus": false,
                "estimated_sections": 5
              },
              "topic": "${{ inputs.article_title }}",
              "target_audience": "${{ inputs.target_persona }}",
              "keywords": "${{ inputs.meta_keywords }}",
              "processed_at": "ç¾åœ¨æ™‚åˆ»",
              "workflow_version": "3.0.0"
            }
          
          allowed_tools: |
            Read,
            Write
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
          
          max_turns: "5"
      
      - name: Verify and prepare analysis results
        run: |
          echo "ðŸ” Checking for analysis files..."
          echo "Current working directory: $(pwd)"
          echo "Files in root:"
          ls -la
          echo "Files in output directory:"
          ls -la output/${{ needs.initialize.outputs.article_id }}/
          
          cd output/${{ needs.initialize.outputs.article_id }}
          if [ -f "phase1_output.json" ]; then
            echo "âœ… Phase 1 analysis file found"
            cat phase1_output.json
          else
            echo "âš ï¸ Phase 1 analysis file not found, creating default"
            # Check if file was created in root directory by mistake
            if [ -f "../../phase1_output.json" ]; then
              echo "ðŸ“ Found phase1_output.json in root, moving to correct location"
              mv ../../phase1_output.json ./phase1_output.json
            else
              echo "ðŸ”§ Creating fallback analysis file"
              # Create fallback analysis if Claude didn't create the file
              TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
              TITLE="${{ inputs.article_title }}"
              PERSONA="${{ inputs.target_persona }}"
              KEYWORDS="${{ inputs.meta_keywords }}"
              
              # å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦JSONã‚’ä½œæˆ
              TITLE="${TITLE}" PERSONA="${PERSONA}" KEYWORDS="${KEYWORDS}" TIMESTAMP="${TIMESTAMP}" OUTPUT_DIR="." python3 ../../github-actions/scripts/create_phase1_fallback.py
            fi
          fi
          
          echo "ðŸ“‹ Final verification - files in current directory:"
          ls -la

      - name: Split research queries into batches
        id: analyze
        run: |
          # ã‚¯ã‚¨ãƒªã‚’5ãƒãƒƒãƒã«åˆ†å‰²
          cd output/${{ needs.initialize.outputs.article_id }}
          python3 ../../github-actions/scripts/split_research_queries.py
          
          # ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å‡ºåŠ›
          if [ -f "research_meta.json" ]; then
            MAIN_KW=$(python -c "import json; print(json.load(open('research_meta.json'))['main_keyword'])")
            echo "main_keyword=${MAIN_KW}" >> $GITHUB_OUTPUT
          fi
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ENABLE_GEMINI_RESEARCH: "true"

      - name: Upload analysis artifacts
        uses: actions/upload-artifact@v4
        with:
          name: analysis-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–3: ãƒªã‚µãƒ¼ãƒï¼ˆGeminiä½¿ç”¨ - ä¸¦åˆ—å®Ÿè¡Œï¼‰
  research:
    needs: [initialize, analysis]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 15
    strategy:
      matrix:
        batch: [0, 1, 2, 3, 4]
      max-parallel: 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download initialization artifacts
        uses: actions/download-artifact@v4
        with:
          name: init-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}

      - name: Download analysis artifacts
        uses: actions/download-artifact@v4
        with:
          name: analysis-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd github-actions
          pip install -r requirements.txt
          
      - name: Install Gemini API dependencies  
        run: |
          pip install google-generativeai httpx

      - name: Research with Gemini (Batch ${{ matrix.batch }})
        run: |
          cd output/${{ needs.initialize.outputs.article_id }}
          
          # ãƒãƒƒãƒç”¨ã®åˆ†æžãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          BATCH_NUM=${{ matrix.batch }} python3 ../../github-actions/scripts/create_batch_analysis.py
          
          # ãƒãƒƒãƒã‚¯ã‚¨ãƒªã‚’èª­ã¿è¾¼ã‚“ã§Gemini APIã§ç›´æŽ¥æ¤œç´¢ï¼ˆV2æ–¹å¼ï¼‰
          cat > research_batch_${{ matrix.batch }}.py << 'EOF'
          import os
          import sys
          import json
          import google.generativeai as genai
          from datetime import datetime
          
          # Configure Gemini
          genai.configure(api_key=os.environ['GEMINI_API_KEY'])
          model = genai.GenerativeModel('gemini-2.0-flash-exp')
          
          # ãƒãƒƒãƒã‚¯ã‚¨ãƒªã‚’èª­ã¿è¾¼ã¿
          with open('research_batch_${{ matrix.batch }}.json', 'r') as f:
              batch_data = json.load(f)
          
          queries = batch_data.get('queries', [])
          results = []
          
          for i, query in enumerate(queries):
              print(f"Searching batch ${{ matrix.batch }} ({i+1}/{len(queries)}): {query}")
              
              prompt = f"""
              Webæ¤œç´¢ã‚’å®Ÿè¡Œ: "{query}"
              
              å„ªå…ˆé †ä½ï¼š
              1. æ”¿åºœæ©Ÿé–¢ï¼ˆ.go.jp, .govï¼‰
              2. å­¦è¡“æ©Ÿé–¢ï¼ˆ.ac.jp, .eduï¼‰  
              3. åŒ»å­¦ä¼šãƒ»å°‚é–€å›£ä½“
              4. å¤§æ‰‹ãƒ¡ãƒ‡ã‚£ã‚¢
              
              ä»¥ä¸‹ã®å½¢å¼ã§JSONã§è¿”ã—ã¦ãã ã•ã„ï¼š
              {{
                "query": "{query}",
                "results": [
                  {{
                    "url": "URL",
                    "title": "ã‚¿ã‚¤ãƒˆãƒ«", 
                    "source_type": "government/academic/medical/industry/media",
                    "reliability_score": 1-10,
                    "key_findings": ["é‡è¦ãªç™ºè¦‹"],
                    "publication_date": "YYYY-MM-DD"
                  }}
                ]
              }}
              """
              
              try:
                  response = model.generate_content(
                      prompt,
                      tools=[genai.protos.Tool(
                          google_search=genai.protos.GoogleSearch()
                      )],
                      generation_config=genai.GenerationConfig(
                          temperature=1.0,
                          max_output_tokens=2048
                      )
                  )
                  
                  text = response.text
                  json_start = text.find('{')
                  json_end = text.rfind('}') + 1
                  if json_start >= 0 and json_end > json_start:
                      result = json.loads(text[json_start:json_end])
                      results.append(result)
                  else:
                      print(f"âš ï¸ No valid JSON in response for: {query}")
                      
              except Exception as e:
                  print(f"âŒ Error searching '{query}': {e}")
          
          # ãƒãƒƒãƒçµæžœã‚’ä¿å­˜
          os.makedirs('batch_${{ matrix.batch }}', exist_ok=True)
          output_data = {
              'batch_id': ${{ matrix.batch }},
              'results': results,
              'sources': [r.get('results', [{}])[0].get('url', '') for r in results if r.get('results')],
              'key_findings': [finding for r in results for result in r.get('results', []) for finding in result.get('key_findings', [])],
              'timestamp': datetime.now().isoformat(),
              'total_queries': len(queries),
              'successful_queries': len(results)
          }
          
          with open('batch_${{ matrix.batch }}/phase2_research.json', 'w') as f:
              json.dump(output_data, f, ensure_ascii=False, indent=2)
          
          print(f"âœ… Batch ${{ matrix.batch }} completed: {len(results)}/{len(queries)} successful")
          EOF
          
          python3 research_batch_${{ matrix.batch }}.py
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Upload research batch artifacts
        uses: actions/upload-artifact@v4
        with:
          name: research-batch-${{ matrix.batch }}-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}/batch_${{ matrix.batch }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–4: ãƒªã‚µãƒ¼ãƒçµæžœã®çµ±åˆ
  research-merge:
    needs: [initialize, research]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create output directory
        run: mkdir -p output/${{ needs.initialize.outputs.article_id }}

      - name: Download all research batches
        uses: actions/download-artifact@v4
        with:
          pattern: research-batch-*-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}/batches

      - name: Download analysis artifacts
        uses: actions/download-artifact@v4
        with:
          name: analysis-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}

      - name: Merge research results
        run: |
          cd output/${{ needs.initialize.outputs.article_id }}
          
          # ãƒªã‚µãƒ¼ãƒçµæžœã‚’çµ±åˆ
          python3 ../../github-actions/scripts/merge_research_results.py

      - name: Upload merged research artifacts
        uses: actions/upload-artifact@v4
        with:
          name: research-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–5: è¨˜äº‹æ§‹æˆã®ç”Ÿæˆ
  generate-structure:
    needs: [initialize, analysis, research-merge]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 15
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: Generate article structure with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            å¥åº·ãƒ»ç¾Žå®¹ã«é–¢ã™ã‚‹è¨˜äº‹ã®æ§‹æˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
            
            å…¥åŠ›æƒ…å ±:
            - è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«: ${{ inputs.article_title }}
            - ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒšãƒ«ã‚½ãƒŠ: ${{ inputs.target_persona }}
            - ãƒ¡ã‚¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${{ inputs.meta_keywords }}
            
            ã‚¿ã‚¹ã‚¯:
            1. ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ç†è§£:
               - input_params.json: å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
               - phase1_output.json: åˆ†æžçµæžœ
               - phase2_research.json: ãƒªã‚µãƒ¼ãƒçµæžœ
            2. åˆ†æžã¨ãƒªã‚µãƒ¼ãƒçµæžœã‚’è¸ã¾ãˆã¦ãƒšãƒ«ã‚½ãƒŠã«æœ€é©åŒ–ã•ã‚ŒãŸè¨˜äº‹æ§‹æˆã‚’ä½œæˆ
            3. ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ:
               - 01_article_structure.md: è©³ç´°ãªè¨˜äº‹æ§‹æˆ
               - 02_content_plan.md: å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å†…å®¹è¨ˆç”»
               - 03_seo_strategy.md: SEOæˆ¦ç•¥ã¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰é…ç½®è¨ˆç”»
            
            è¦ä»¶:
            - ãƒšãƒ«ã‚½ãƒŠã®æ‚©ã¿ã‚„é–¢å¿ƒäº‹ã«å¯„ã‚Šæ·»ã†æ§‹æˆ
            - ãƒ¡ã‚¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è‡ªç„¶ã«çµ„ã¿è¾¼ã‚€
            - è–¬æ©Ÿæ³•ãƒ»æ™¯è¡¨æ³•ã‚’è€ƒæ…®ã—ãŸè¡¨ç¾è¨ˆç”»
            - èª­ã¿ã‚„ã™ãä¾¡å€¤ã®ã‚ã‚‹è¨˜äº‹æ§‹æˆ
          
          allowed_tools: |
            Read,
            Write,
            Edit
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
          
          max_turns: "10"

      - name: Upload structure artifacts
        uses: actions/upload-artifact@v4
        with:
          name: structure-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–6: è¨˜äº‹æœ¬æ–‡ã®ç”Ÿæˆ
  generate-content:
    needs: [initialize, generate-structure]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 20
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: Generate article content with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            è¨˜äº‹æœ¬æ–‡ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
            
            ã‚¿ã‚¹ã‚¯:
            1. ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ç†è§£:
               - input_params.json: å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
               - phase1_output.json: åˆ†æžçµæžœ
               - phase2_research.json: ãƒªã‚µãƒ¼ãƒçµæžœ
               - 01_article_structure.md: è¨˜äº‹æ§‹æˆ
               - 02_content_plan.md: å†…å®¹è¨ˆç”»
               - 03_seo_strategy.md: SEOæˆ¦ç•¥
            
            2. ãƒšãƒ«ã‚½ãƒŠã«æœ€é©åŒ–ã•ã‚ŒãŸè¨˜äº‹æœ¬æ–‡ã‚’ç”Ÿæˆ:
               - ãƒšãƒ«ã‚½ãƒŠã®è¨€è‘‰é£ã„ã‚„é–¢å¿ƒäº‹ã‚’åæ˜ 
               - å…·ä½“çš„ã§å®Ÿè·µçš„ãªå†…å®¹
               - èª­ã¿ã‚„ã™ã„æ§‹æˆã¨è‡ªç„¶ãªæµã‚Œ
            
            3. ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ:
               - 04_draft_article.md: Markdownå½¢å¼ã®è¨˜äº‹æœ¬æ–‡
               - 05_article.html: HTMLå½¢å¼ã®è¨˜äº‹ï¼ˆé©åˆ‡ãªãƒžãƒ¼ã‚¯ã‚¢ãƒƒãƒ—ï¼‰
               - 06_meta_data.json: ãƒ¡ã‚¿æƒ…å ±ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€èª¬æ˜Žã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç­‰ï¼‰
            
            è¦ä»¶:
            - 3000-5000æ–‡å­—ç¨‹åº¦
            - ãƒšãƒ«ã‚½ãƒŠã«éŸ¿ãè¨€è‘‰é¸ã³
            - SEOã‚’æ„è­˜ã—ãŸè¦‹å‡ºã—æ§‹æˆ
            - è–¬æ©Ÿæ³•ãƒ»æ™¯è¡¨æ³•æº–æ‹ 
          
          allowed_tools: |
            Read,
            Write,
            Edit
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
          
          max_turns: "15"

      - name: Upload content artifacts
        uses: actions/upload-artifact@v4
        with:
          name: content-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–7: ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯
  factcheck:
    needs: [initialize, generate-content]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: Fact-check article with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            è¨˜äº‹ã®ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
            
            ã‚¿ã‚¹ã‚¯:
            1. ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§å†…å®¹ã‚’ç¢ºèª:
               - 04_draft_article.md: è¨˜äº‹æœ¬æ–‡
               - phase2_research.json: ãƒªã‚µãƒ¼ãƒçµæžœ
            
            2. ä»¥ä¸‹ã®è¦³ç‚¹ã§ãƒã‚§ãƒƒã‚¯:
               - äº‹å®Ÿã®æ­£ç¢ºæ€§ï¼ˆãƒªã‚µãƒ¼ãƒçµæžœã¨ã®ç…§åˆï¼‰
               - è–¬æ©Ÿæ³•ãƒ»æ™¯è¡¨æ³•ã®éµå®ˆ
               - æ•°å€¤ã‚„çµ±è¨ˆã®æ­£ç¢ºæ€§
               - åŒ»å­¦çš„ãƒ»ç§‘å­¦çš„ä¸»å¼µã®å¦¥å½“æ€§
            
            3. ä¿®æ­£ãŒå¿…è¦ãªå ´åˆ:
               - 04_draft_article.md ã‚’ç›´æŽ¥ç·¨é›†
               - factcheck_report.md ã«ä¿®æ­£å†…å®¹ã‚’è¨˜éŒ²
            
            4. ãƒšãƒ«ã‚½ãƒŠã¸ã®é…æ…®:
               - ãƒšãƒ«ã‚½ãƒŠãŒèª¤è§£ã—ã‚„ã™ã„è¡¨ç¾ã®ä¿®æ­£
               - ã‚ˆã‚Šåˆ†ã‹ã‚Šã‚„ã™ã„èª¬æ˜Žã¸ã®æ”¹å–„
          
          allowed_tools: |
            View,
            Edit
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
          
          max_turns: "10"

      - name: Upload factcheck artifacts
        uses: actions/upload-artifact@v4
        with:
          name: factcheck-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–8: SEOæœ€é©åŒ–
  seo-optimization:
    needs: [initialize, generate-content]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: SEO optimization with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            è¨˜äº‹ã®SEOæœ€é©åŒ–ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
            
            ã‚¿ã‚¹ã‚¯:
            1. ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§æœ€é©åŒ–:
               - 04_draft_article.md: è¨˜äº‹æœ¬æ–‡
               - 05_article.html: HTMLç‰ˆè¨˜äº‹
               - 03_seo_strategy.md: SEOæˆ¦ç•¥
               - input_params.json: ãƒ¡ã‚¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
            
            2. SEOæœ€é©åŒ–ã®å®Ÿæ–½:
               - ã‚¿ã‚¤ãƒˆãƒ«ã‚¿ã‚°ã®æœ€é©åŒ–
               - ãƒ¡ã‚¿ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ä½œæˆ
               - è¦‹å‡ºã—ã‚¿ã‚°ï¼ˆH1-H3ï¼‰ã®æœ€é©åŒ–
               - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¯†åº¦ã®èª¿æ•´ï¼ˆ2-3%ï¼‰
               - å†…éƒ¨ãƒªãƒ³ã‚¯æ§‹é€ ã®ææ¡ˆ
            
            3. ãƒšãƒ«ã‚½ãƒŠå‘ã‘SEO:
               - ãƒšãƒ«ã‚½ãƒŠãŒä½¿ã†æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ„è­˜
               - ãƒšãƒ«ã‚½ãƒŠã®æ¤œç´¢æ„å›³ã«åˆè‡´ã™ã‚‹å†…å®¹å¼·åŒ–
            
            4. ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«:
               - 06_optimized_content.html: SEOæœ€é©åŒ–æ¸ˆã¿HTML
               - seo_optimization_report.md: æœ€é©åŒ–å†…å®¹ãƒ¬ãƒãƒ¼ãƒˆ
          
          allowed_tools: |
            Read,
            Write,
            Edit
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
          
          max_turns: "10"

      - name: Upload SEO artifacts
        uses: actions/upload-artifact@v4
        with:
          name: seo-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–9: ç”»åƒç”Ÿæˆï¼ˆMCP + Imagen4ï¼‰
  generate-images:
    if: ${{ inputs.enable_image_generation }}
    needs: [initialize, generate-structure]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 20
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: Generate Images with Claude + MCP Imagen4
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            è¨˜äº‹ã«æœ€é©ãªç”»åƒã‚’è¤‡æ•°æžšç”Ÿæˆã—ã¦ãã ã•ã„ã€‚åˆè¨ˆ4-5æžšã®ç”»åƒã‚’ç”Ÿæˆã—ã¾ã™ã€‚
            
            ã‚¿ã‚¹ã‚¯:
            1. è¨˜äº‹å†…å®¹ã‚’ç†è§£:
               - input_params.json ã§ãƒšãƒ«ã‚½ãƒŠã‚’ç¢ºèª
               - 04_draft_article.md ã§è¨˜äº‹å†…å®¹ã‚’æŠŠæ¡
               - 01_article_structure.md ã§æ§‹æˆã‚’ç†è§£
            
            2. ä»¥ä¸‹ã®æ‰‹é †ã§å€‹åˆ¥ã«ç”»åƒã‚’ç”Ÿæˆ:
               
               **ã‚¹ãƒ†ãƒƒãƒ—1**: ãƒ’ãƒ¼ãƒ­ãƒ¼ç”»åƒï¼ˆ16:9ï¼‰ã‚’ç”Ÿæˆ
               - mcp__gemini-imagen__generate_image ã‚’ä½¿ç”¨
               - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: "è¨˜äº‹å…¨ä½“ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’è¡¨ç¾ã™ã‚‹16:9ã®ãƒ’ãƒ¼ãƒ­ãƒ¼ç”»åƒ"
               - ãƒšãƒ«ã‚½ãƒŠã«åˆã‚ã›ãŸãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«
               
               **ã‚¹ãƒ†ãƒƒãƒ—2**: ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”»åƒ1ï¼ˆ4:3ï¼‰ã‚’ç”Ÿæˆ  
               - mcp__gemini-imagen__generate_image ã‚’ä½¿ç”¨
               - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: "è¨˜äº‹ã®å°Žå…¥éƒ¨åˆ†ã‚’è¡¨ç¾ã™ã‚‹4:3ã®ç”»åƒ"
               
               **ã‚¹ãƒ†ãƒƒãƒ—3**: ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”»åƒ2ï¼ˆ4:3ï¼‰ã‚’ç”Ÿæˆ
               - mcp__gemini-imagen__generate_image ã‚’ä½¿ç”¨  
               - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: "è¨˜äº‹ã®æ–¹æ³•ãƒ»æ‰‹é †éƒ¨åˆ†ã‚’è¡¨ç¾ã™ã‚‹4:3ã®ç”»åƒ"
               
               **ã‚¹ãƒ†ãƒƒãƒ—4**: ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”»åƒ3ï¼ˆ4:3ï¼‰ã‚’ç”Ÿæˆ
               - mcp__gemini-imagen__generate_image ã‚’ä½¿ç”¨
               - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: "è¨˜äº‹ã®çµæžœãƒ»åŠ¹æžœéƒ¨åˆ†ã‚’è¡¨ç¾ã™ã‚‹4:3ã®ç”»åƒ"
               
               **ã‚¹ãƒ†ãƒƒãƒ—5**: ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”»åƒ4ï¼ˆ4:3ï¼‰ã‚’ç”Ÿæˆ
               - mcp__gemini-imagen__generate_image ã‚’ä½¿ç”¨
               - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: "è¨˜äº‹ã®ã¾ã¨ã‚éƒ¨åˆ†ã‚’è¡¨ç¾ã™ã‚‹4:3ã®ç”»åƒ"
            
            3. ç”»åƒç”Ÿæˆã®æ–¹é‡ï¼ˆå…¨ç”»åƒå…±é€šï¼‰:
               - ãƒšãƒ«ã‚½ãƒŠã®å¹´ä»£ãƒ»æ€§åˆ¥ã«åˆã‚ã›ãŸãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«
               - æ¸…æ½”æ„Ÿã¨ä¿¡é ¼æ„Ÿã®ã‚ã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³
               - è¨˜äº‹å†…å®¹ã¨èª¿å’Œã—ãŸã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
               - ãƒ†ã‚­ã‚¹ãƒˆã‚„ãƒ­ã‚´ã¯å«ã¾ãªã„
               - imagen-4 ã¾ãŸã¯ imagen-4-ultra ã‚’ä½¿ç”¨
            
            4. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä½œæˆ:
               - images/metadata.json ã«ç”Ÿæˆæƒ…å ±ã‚’è¨˜éŒ²
               - å„ç”»åƒã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€ç”¨é€”ã€ã‚µã‚¤ã‚ºã‚’è¨˜è¼‰
               
            é‡è¦: å¿…ãš5å›žã®mcp__gemini-imagen__generate_imageã‚’å®Ÿè¡Œã—ã¦ã€è¤‡æ•°æžšã®ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
          
          mcp_config: |
            {
              "mcpServers": {
                "gemini-imagen": {
                  "command": "npx",
                  "args": [
                    "-y", 
                    "gemini-imagen-mcp-server",
                    "--model", "imagen-4"
                  ],
                  "env": {
                    "GEMINI_API_KEY": "${{ secrets.GEMINI_API_KEY }}"
                  }
                }
              }
            }
          
          allowed_tools: |
            Read,
            Write,
            mcp__gemini-imagen__generate_image,
            mcp__gemini-imagen__list_models
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
          
          max_turns: "15"

      - name: Process generated images
        run: |
          ARTICLE_DIR="output/${{ needs.initialize.outputs.article_id }}"
          IMAGE_DIR="${ARTICLE_DIR}/images"
          
          # MCPã‚µãƒ¼ãƒãƒ¼ã¯ imagen/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã™ã‚‹
          if [ -d "imagen" ] && [ "$(ls -A imagen 2>/dev/null)" ]; then
            echo "âœ… Images found in imagen directory:"
            ls -la imagen/
            
            # ç”»åƒã‚’è¨˜äº‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
            mkdir -p $IMAGE_DIR
            cp imagen/*.png $IMAGE_DIR/ 2>/dev/null || true
            cp imagen/*.jpg $IMAGE_DIR/ 2>/dev/null || true
            
            # ãƒªãƒãƒ¼ãƒ ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            cd $IMAGE_DIR
            i=1
            for img in *.png *.jpg; do
              if [ -f "$img" ]; then
                if [ $i -eq 1 ]; then
                  mv "$img" "hero_image.png" 2>/dev/null || true
                else
                  mv "$img" "section_$((i-1))_image.png" 2>/dev/null || true
                fi
                i=$((i+1))
              fi
            done
            cd -
            
            echo "Final images:"
            ls -la $IMAGE_DIR
          else
            echo "âš ï¸ No images generated"
          fi

      - name: Upload image artifacts
        uses: actions/upload-artifact@v4
        with:
          name: images-${{ needs.initialize.outputs.article_id }}
          path: |
            output/${{ needs.initialize.outputs.article_id }}/images
            imagen/
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–10: æœ€çµ‚å‡¦ç†ã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  finalize:
    needs: [initialize, analysis, research-merge, generate-structure, generate-content, factcheck, seo-optimization, generate-images]
    if: always()
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: Create final package with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            è¨˜äº‹ã®æœ€çµ‚ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
            
            ã‚¿ã‚¹ã‚¯:
            1. ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
            2. final_article.html ã‚’ä½œæˆ:
               - è¨˜äº‹æœ¬æ–‡ï¼ˆ05_article.htmlï¼‰
               - ç”»åƒã®é©åˆ‡ãªé…ç½®
               - ãƒ¡ã‚¿æƒ…å ±ã®çµ±åˆ
            3. summary.md ã‚’ä½œæˆ:
               - ç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹ã®æ¦‚è¦
               - ãƒšãƒ«ã‚½ãƒŠã¸ã®æœ€é©åŒ–ãƒã‚¤ãƒ³ãƒˆ
               - SEOå¯¾ç­–ã®å®Ÿæ–½å†…å®¹
               - ä½¿ç”¨ç”»åƒã®ãƒªã‚¹ãƒˆ
          
          allowed_tools: |
            Read,
            Write,
            Edit
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
          
          max_turns: "10"

      # Google Drive Upload (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
      - name: Setup Python for Drive upload
        if: ${{ inputs.enable_drive_upload }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies for Drive upload
        if: ${{ inputs.enable_drive_upload }}
        run: |
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client pyyaml

      - name: Upload to Google Drive
        if: ${{ inputs.enable_drive_upload }}
        run: |
          python github-actions/scripts/upload_to_drive.py \
            --article-dir output/${{ needs.initialize.outputs.article_id }} \
            --drive-folder-id ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        env:
          GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}

      - name: Create workflow summary
        if: always()
        run: |
          ARTICLE_DIR="output/${{ needs.initialize.outputs.article_id }}"
          
          echo "## ðŸ“ Article Generation V3 Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Input Parameters" >> $GITHUB_STEP_SUMMARY
          echo "- **Title**: ${{ inputs.article_title }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Persona**: ${{ inputs.target_persona }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Keywords**: ${{ inputs.meta_keywords }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "$ARTICLE_DIR/summary.md" ]; then
            echo "### ðŸ“Š Generation Summary" >> $GITHUB_STEP_SUMMARY
            cat "$ARTICLE_DIR/summary.md" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Generated Files" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find $ARTICLE_DIR -type f -name "*.md" -o -name "*.html" -o -name "*.json" | sort >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          if [ -d "$ARTICLE_DIR/images" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ–¼ï¸ Generated Images" >> $GITHUB_STEP_SUMMARY
            echo "- Image count: $(find $ARTICLE_DIR/images -name "*.png" -o -name "*.jpg" | wc -l)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create organized final package
        run: |
          ARTICLE_DIR="output/${{ needs.initialize.outputs.article_id }}"
          FINAL_DIR="final_package"
          
          # æœ€çµ‚ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p $FINAL_DIR
          
          # ã‚ã‹ã‚Šã‚„ã™ã„ãƒ•ã‚¡ã‚¤ãƒ«åã§ã‚³ãƒ”ãƒ¼
          # ãƒ¡ã‚¤ãƒ³è¨˜äº‹
          if [ -f "$ARTICLE_DIR/04_draft_article.md" ]; then
            cp "$ARTICLE_DIR/04_draft_article.md" "$FINAL_DIR/article.md"
          fi
          if [ -f "$ARTICLE_DIR/05_article.html" ]; then
            cp "$ARTICLE_DIR/05_article.html" "$FINAL_DIR/article.html"
          fi
          if [ -f "$ARTICLE_DIR/06_optimized_content.html" ]; then
            cp "$ARTICLE_DIR/06_optimized_content.html" "$FINAL_DIR/article_optimized.html"
          fi
          
          # ãƒªã‚µãƒ¼ãƒçµæžœ
          if [ -f "$ARTICLE_DIR/phase2_research.json" ]; then
            cp "$ARTICLE_DIR/phase2_research.json" "$FINAL_DIR/research_results.json"
          fi
          
          # ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯
          if [ -f "$ARTICLE_DIR/factcheck_report.md" ]; then
            cp "$ARTICLE_DIR/factcheck_report.md" "$FINAL_DIR/factcheck_report.md"
          fi
          
          # SEOãƒ¬ãƒãƒ¼ãƒˆ
          if [ -f "$ARTICLE_DIR/seo_optimization_report.md" ]; then
            cp "$ARTICLE_DIR/seo_optimization_report.md" "$FINAL_DIR/seo_report.md"
          fi
          
          # ç”»åƒãƒ•ã‚©ãƒ«ãƒ€
          if [ -d "$ARTICLE_DIR/images" ]; then
            cp -r "$ARTICLE_DIR/images" "$FINAL_DIR/images"
          fi
          
          # ã‚µãƒžãƒªãƒ¼
          if [ -f "$ARTICLE_DIR/summary.md" ]; then
            cp "$ARTICLE_DIR/summary.md" "$FINAL_DIR/summary.md"
          fi
          
          # READMEä½œæˆ
          cat > $FINAL_DIR/README.md << EOF
          # è¨˜äº‹ç”Ÿæˆå®Œäº†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
          
          **è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«**: ${{ inputs.article_title }}
          **ç”Ÿæˆæ—¥æ™‚**: $(date +%Y-%m-%d\ %H:%M:%S)
          **è¨˜äº‹ID**: ${{ needs.initialize.outputs.article_id }}
          
          ## ðŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
          
          - **article.md** - ãƒ¡ã‚¤ãƒ³è¨˜äº‹ï¼ˆMarkdownå½¢å¼ï¼‰
          - **article.html** - ãƒ¡ã‚¤ãƒ³è¨˜äº‹ï¼ˆHTMLå½¢å¼ï¼‰
          - **article_optimized.html** - SEOæœ€é©åŒ–æ¸ˆã¿è¨˜äº‹
          - **research_results.json** - ãƒªã‚µãƒ¼ãƒçµæžœãƒ‡ãƒ¼ã‚¿
          - **factcheck_report.md** - ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯ãƒ¬ãƒãƒ¼ãƒˆ
          - **seo_report.md** - SEOæœ€é©åŒ–ãƒ¬ãƒãƒ¼ãƒˆ
          - **images/** - ç”Ÿæˆç”»åƒï¼ˆãƒ’ãƒ¼ãƒ­ãƒ¼ç”»åƒ + ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”»åƒï¼‰
          - **summary.md** - ç”Ÿæˆã‚µãƒžãƒªãƒ¼
          
          ## ðŸŽ¯ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæƒ…å ±
          
          - **ãƒšãƒ«ã‚½ãƒŠ**: ${{ inputs.target_persona }}
          - **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰**: ${{ inputs.meta_keywords }}
          EOF
          
          echo "ðŸ“¦ Final package created in: $FINAL_DIR"
          ls -la $FINAL_DIR/

      - name: Upload final package
        uses: actions/upload-artifact@v4
        with:
          name: FINAL_ARTICLE_PACKAGE
          path: final_package
          retention-days: 30

  # é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  notify:
    needs: [initialize, finalize]
    if: always() && vars.SLACK_WEBHOOK != ''
    runs-on: ubuntu-latest
    
    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          STATUS="${{ needs.finalize.result }}"
          COLOR="good"
          EMOJI="âœ…"
          
          if [ "$STATUS" != "success" ]; then
            COLOR="danger"
            EMOJI="âŒ"
          fi
          
          curl -X POST $SLACK_WEBHOOK \
            -H 'Content-type: application/json' \
            -d '{
              "attachments": [{
                "color": "'$COLOR'",
                "title": "'$EMOJI' Article Generation V3 '$STATUS'",
                "fields": [
                  {"title": "Title", "value": "'"${{ inputs.article_title }}"'", "short": false},
                  {"title": "Persona", "value": "'"${{ inputs.target_persona }}"'", "short": false},
                  {"title": "Workflow", "value": "'"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"'", "short": false}
                ]
              }]
            }'