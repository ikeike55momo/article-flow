name: Article Generation V3 (MCP + Imagen4)

on:
  workflow_dispatch:
    inputs:
      article_title:
        description: 'Ë®ò‰∫ã„Çø„Ç§„Éà„É´'
        required: true
        type: string
        default: ''
      
      target_persona:
        description: '„Çø„Éº„Ç≤„ÉÉ„Éà„Éö„É´„ÇΩ„ÉäÔºà‰æãÔºö30‰ª£Â•≥ÊÄß„ÄÅÂÅ•Â∫∑ÊÑèË≠ò„ÅåÈ´ò„ÅÑ„ÄÅÂ≠êËÇ≤„Å¶‰∏≠Ôºâ'
        required: true
        type: string
        default: ''
      
      meta_keywords:
        description: '„É°„Çø„Ç≠„Éº„ÉØ„Éº„ÉâÔºà„Ç´„É≥„ÉûÂå∫Âàá„ÇäÔºâ'
        required: true
        type: string
        default: ''
      
      enable_image_generation:
        description: 'ÁîªÂÉèÁîüÊàê„ÇíÊúâÂäπ„Å´„Åô„Çã'
        required: false
        type: boolean
        default: true
      
      enable_drive_upload:
        description: 'Google Drive„Å∏„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.11'

jobs:
  # „Ç∏„Éß„Éñ1: ÂàùÊúüÂåñ
  initialize:
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 5
    outputs:
      article_id: ${{ steps.init.outputs.article_id }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize article generation
        id: init
        run: |
          # „Çø„Ç§„Éà„É´„Åã„ÇâID„ÇíÁîüÊàê
          CLEAN_TITLE=$(echo "${{ inputs.article_title }}" | sed 's/[^a-zA-Z0-9„ÅÇ-„Çì„Ç¢-„É≥‰∏Ä-ÈæØ]/_/g' | cut -c1-50)
          ARTICLE_ID=$(date +%Y%m%d_%H%M%S)_${CLEAN_TITLE}
          echo "article_id=${ARTICLE_ID}" >> $GITHUB_OUTPUT
          echo "Article ID: ${ARTICLE_ID}"
          
          # Âá∫Âäõ„Éá„Ç£„É¨„ÇØ„Éà„É™‰ΩúÊàê
          mkdir -p output/${ARTICLE_ID}
          
          # ÂÖ•ÂäõÊÉÖÂ†±„Çí‰øùÂ≠ò
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          cat > output/${ARTICLE_ID}/input_params.json << EOJSON
          {
            "article_id": "${ARTICLE_ID}",
            "title": "${{ inputs.article_title }}",
            "target_persona": "${{ inputs.target_persona }}",
            "meta_keywords": "${{ inputs.meta_keywords }}",
            "created_at": "${TIMESTAMP}"
          }
          EOJSON

      - name: Upload initialization artifacts
        uses: actions/upload-artifact@v4
        with:
          name: init-${{ steps.init.outputs.article_id }}
          path: output/${{ steps.init.outputs.article_id }}
          retention-days: 30

  # „Ç∏„Éß„Éñ2: „É™„ÇØ„Ç®„Çπ„ÉàÂàÜÊûê
  analysis:
    needs: initialize
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 10
    outputs:
      main_keyword: ${{ steps.analyze.outputs.main_keyword }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download initialization artifacts
        uses: actions/download-artifact@v4
        with:
          name: init-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd github-actions
          pip install -r requirements.txt

      - name: Create analysis input
        run: |
          cd output/${{ needs.initialize.outputs.article_id }}
          # Phase1„ÅåÊúüÂæÖ„Åô„ÇãÂΩ¢Âºè„ÅÆJSON„Çí‰ΩúÊàê
          cat > request_params.json << EOJSON
          {
            "topic": "${{ inputs.article_title }}",
            "target_audience": "${{ inputs.target_persona }}",
            "keywords": "${{ inputs.meta_keywords }}"
          }
          EOJSON

      - name: Run Phase 1 Analysis
        id: analyze
        run: |
          cd github-actions
          python scripts/phase1_request_analysis.py \
            --params-file ../output/${{ needs.initialize.outputs.article_id }}/request_params.json \
            --output-dir ../output/${{ needs.initialize.outputs.article_id }}
          
          # „ÇØ„Ç®„É™„Çí5„Éê„ÉÉ„ÉÅ„Å´ÂàÜÂâ≤
          cd ../output/${{ needs.initialize.outputs.article_id }}
          echo -n "" > split_queries.py
          echo "import json" >> split_queries.py
          echo "import math" >> split_queries.py
          echo "" >> split_queries.py
          echo "# ÂàÜÊûêÁµêÊûú„ÇíË™≠„ÅøËæº„Åø" >> split_queries.py
          echo "with open('phase1_output.json', 'r') as f:" >> split_queries.py
          echo "    data = json.load(f)" >> split_queries.py
          echo "" >> split_queries.py
          echo "queries = data.get('analysis', {}).get('research_queries', [])" >> split_queries.py
          echo "total_queries = len(queries)" >> split_queries.py
          echo "batch_size = math.ceil(total_queries / 5)" >> split_queries.py
          echo "" >> split_queries.py
          echo "# ÂêÑ„Éê„ÉÉ„ÉÅ„ÅÆ„ÇØ„Ç®„É™„Çí‰øùÂ≠ò" >> split_queries.py
          echo "for i in range(5):" >> split_queries.py
          echo "    start_idx = i * batch_size" >> split_queries.py
          echo "    end_idx = min((i + 1) * batch_size, total_queries)" >> split_queries.py
          echo "    batch_queries = queries[start_idx:end_idx]" >> split_queries.py
          echo "    " >> split_queries.py
          echo "    batch_data = {" >> split_queries.py
          echo "        'batch_id': i," >> split_queries.py
          echo "        'queries': batch_queries," >> split_queries.py
          echo "        'total_batches': 5" >> split_queries.py
          echo "    }" >> split_queries.py
          echo "    " >> split_queries.py
          echo "    with open(f'research_batch_{i}.json', 'w') as f:" >> split_queries.py
          echo "        json.dump(batch_data, f, ensure_ascii=False, indent=2)" >> split_queries.py
          echo "" >> split_queries.py
          echo "# „É°„ÇøÊÉÖÂ†±„Çí‰øùÂ≠ò" >> split_queries.py
          echo "meta = {" >> split_queries.py
          echo "    'total_queries': total_queries," >> split_queries.py
          echo "    'batch_count': 5," >> split_queries.py
          echo "    'batch_size': batch_size," >> split_queries.py
          echo "    'main_keyword': data.get('analysis', {}).get('main_keyword', '')" >> split_queries.py
          echo "}" >> split_queries.py
          echo "with open('research_meta.json', 'w') as f:" >> split_queries.py
          echo "    json.dump(meta, f, ensure_ascii=False, indent=2)" >> split_queries.py
          python3 split_queries.py
          
          # „É°„Ç§„É≥„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂá∫Âäõ
          if [ -f "research_meta.json" ]; then
            MAIN_KW=$(python -c "import json; print(json.load(open('research_meta.json'))['main_keyword'])")
            echo "main_keyword=${MAIN_KW}" >> $GITHUB_OUTPUT
          fi
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Upload analysis artifacts
        uses: actions/upload-artifact@v4
        with:
          name: analysis-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # „Ç∏„Éß„Éñ3: „É™„Çµ„Éº„ÉÅÔºàGemini‰ΩøÁî® - ‰∏¶ÂàóÂÆüË°åÔºâ
  research:
    needs: [initialize, analysis]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 15
    strategy:
      matrix:
        batch: [0, 1, 2, 3, 4]
      max-parallel: 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download initialization artifacts
        uses: actions/download-artifact@v4
        with:
          name: init-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd github-actions
          pip install -r requirements.txt

      - name: Research with Gemini (Batch ${{ matrix.batch }})
        run: |
          cd output/${{ needs.initialize.outputs.article_id }}
          
          # „Éê„ÉÉ„ÉÅÁî®„ÅÆÂàÜÊûê„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê
          echo -n "" > create_batch_analysis.py
          echo "import json" >> create_batch_analysis.py
          echo "" >> create_batch_analysis.py
          echo "# „Ç™„É™„Ç∏„Éä„É´„ÅÆÂàÜÊûêÁµêÊûú„ÇíË™≠„ÅøËæº„Åø" >> create_batch_analysis.py
          echo "with open('phase1_output.json', 'r') as f:" >> create_batch_analysis.py
          echo "    original_data = json.load(f)" >> create_batch_analysis.py
          echo "" >> create_batch_analysis.py
          echo "# „Åì„ÅÆ„Éê„ÉÉ„ÉÅ„ÅÆ„ÇØ„Ç®„É™„ÇíË™≠„ÅøËæº„Åø" >> create_batch_analysis.py
          echo "with open('research_batch_\${{ matrix.batch }}.json', 'r') as f:" >> create_batch_analysis.py
          echo "    batch_data = json.load(f)" >> create_batch_analysis.py
          echo "" >> create_batch_analysis.py
          echo "# „Éê„ÉÉ„ÉÅÁî®„ÅÆÂàÜÊûê„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê" >> create_batch_analysis.py
          echo "batch_analysis = original_data.copy()" >> create_batch_analysis.py
          echo "batch_analysis['analysis']['research_queries'] = batch_data['queries']" >> create_batch_analysis.py
          echo "" >> create_batch_analysis.py
          echo "with open('batch_\${{ matrix.batch }}_analysis.json', 'w') as f:" >> create_batch_analysis.py
          echo "    json.dump(batch_analysis, f, ensure_ascii=False, indent=2)" >> create_batch_analysis.py
          python3 create_batch_analysis.py
          
          cd ../../github-actions
          python scripts/phase2_research_gemini.py \
            --params-file ../output/${{ needs.initialize.outputs.article_id }}/batch_${{ matrix.batch }}_analysis.json \
            --output-dir ../output/${{ needs.initialize.outputs.article_id }}/batch_${{ matrix.batch }}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Upload research batch artifacts
        uses: actions/upload-artifact@v4
        with:
          name: research-batch-${{ matrix.batch }}-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}/batch_${{ matrix.batch }}
          retention-days: 30

  # „Ç∏„Éß„Éñ4: „É™„Çµ„Éº„ÉÅÁµêÊûú„ÅÆÁµ±Âêà
  research-merge:
    needs: [initialize, research]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create output directory
        run: mkdir -p output/${{ needs.initialize.outputs.article_id }}

      - name: Download all research batches
        uses: actions/download-artifact@v4
        with:
          pattern: research-batch-*-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}/batches

      - name: Download analysis artifacts
        uses: actions/download-artifact@v4
        with:
          name: analysis-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}

      - name: Merge research results
        run: |
          cd output/${{ needs.initialize.outputs.article_id }}
          
          # „É™„Çµ„Éº„ÉÅÁµêÊûú„ÇíÁµ±Âêà
          echo -n "" > merge_research.py
          echo "import json" >> merge_research.py
          echo "import os" >> merge_research.py
          echo "from pathlib import Path" >> merge_research.py
          echo "from datetime import datetime" >> merge_research.py
          echo "" >> merge_research.py
          echo "# ÂÖ®„Éê„ÉÉ„ÉÅ„ÅÆÁµêÊûú„ÇíÂèéÈõÜ" >> merge_research.py
          echo "all_results = []" >> merge_research.py
          echo "all_sources = []" >> merge_research.py
          echo "all_key_findings = []" >> merge_research.py
          echo "" >> merge_research.py
          echo "# „Éê„ÉÉ„ÉÅ„Éá„Ç£„É¨„ÇØ„Éà„É™„ÇíÊé¢Á¥¢" >> merge_research.py
          echo "batch_dirs = sorted(Path('batches').glob('research-batch-*'))" >> merge_research.py
          echo "" >> merge_research.py
          echo "for batch_dir in batch_dirs:" >> merge_research.py
          echo "    # ÂêÑ„Éê„ÉÉ„ÉÅ„ÅÆphase2_research.json„ÇíË™≠„ÅøËæº„Åø" >> merge_research.py
          echo "    research_file = batch_dir / 'phase2_research.json'" >> merge_research.py
          echo "    if research_file.exists():" >> merge_research.py
          echo "        with open(research_file, 'r') as f:" >> merge_research.py
          echo "            batch_data = json.load(f)" >> merge_research.py
          echo "            " >> merge_research.py
          echo "            # ÁµêÊûú„ÇíÁµ±Âêà" >> merge_research.py
          echo "            if 'results' in batch_data:" >> merge_research.py
          echo "                all_results.extend(batch_data['results'])" >> merge_research.py
          echo "            if 'sources' in batch_data:" >> merge_research.py
          echo "                all_sources.extend(batch_data['sources'])" >> merge_research.py
          echo "            if 'key_findings' in batch_data:" >> merge_research.py
          echo "                all_key_findings.extend(batch_data['key_findings'])" >> merge_research.py
          echo "" >> merge_research.py
          echo "# Áµ±Âêà„Åï„Çå„ÅüÁµêÊûú„Çí‰øùÂ≠ò" >> merge_research.py
          echo "merged_research = {" >> merge_research.py
          echo "    'results': all_results," >> merge_research.py
          echo "    'sources': list(set(all_sources)),  # ÈáçË§á„ÇíÈô§Âéª" >> merge_research.py
          echo "    'key_findings': all_key_findings," >> merge_research.py
          echo "    'total_queries': len(all_results)," >> merge_research.py
          echo "    'timestamp': str(datetime.now())" >> merge_research.py
          echo "}" >> merge_research.py
          echo "" >> merge_research.py
          echo "with open('phase2_research.json', 'w') as f:" >> merge_research.py
          echo "    json.dump(merged_research, f, ensure_ascii=False, indent=2)" >> merge_research.py
          echo "" >> merge_research.py
          echo "print(f'Merged {len(batch_dirs)} batches with {len(all_results)} total results')" >> merge_research.py
          python3 merge_research.py

      - name: Upload merged research artifacts
        uses: actions/upload-artifact@v4
        with:
          name: research-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # „Ç∏„Éß„Éñ5: Ë®ò‰∫ãÊßãÊàê„ÅÆÁîüÊàê
  generate-structure:
    needs: [initialize, analysis, research-merge]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 15
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: Generate article structure with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            ÂÅ•Â∫∑„ÉªÁæéÂÆπ„Å´Èñ¢„Åô„ÇãË®ò‰∫ã„ÅÆÊßãÊàê„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            
            ÂÖ•ÂäõÊÉÖÂ†±:
            - Ë®ò‰∫ã„Çø„Ç§„Éà„É´: ${{ inputs.article_title }}
            - „Çø„Éº„Ç≤„ÉÉ„Éà„Éö„É´„ÇΩ„Éä: ${{ inputs.target_persona }}
            - „É°„Çø„Ç≠„Éº„ÉØ„Éº„Éâ: ${{ inputs.meta_keywords }}
            
            „Çø„Çπ„ÇØ:
            1. ‰ª•‰∏ã„ÅÆ„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Çì„ÅßÁêÜËß£:
               - input_params.json: ÂÖ•Âäõ„Éë„É©„É°„Éº„Çø
               - phase1_output.json: ÂàÜÊûêÁµêÊûú
               - phase2_research.json: „É™„Çµ„Éº„ÉÅÁµêÊûú
            2. ÂàÜÊûê„Å®„É™„Çµ„Éº„ÉÅÁµêÊûú„ÇíË∏è„Åæ„Åà„Å¶„Éö„É´„ÇΩ„Éä„Å´ÊúÄÈÅ©Âåñ„Åï„Çå„ÅüË®ò‰∫ãÊßãÊàê„Çí‰ΩúÊàê
            3. ‰ª•‰∏ã„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÁîüÊàê:
               - 01_article_structure.md: Ë©≥Á¥∞„Å™Ë®ò‰∫ãÊßãÊàê
               - 02_content_plan.md: ÂêÑ„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆÂÜÖÂÆπË®àÁîª
               - 03_seo_strategy.md: SEOÊà¶Áï•„Å®„Ç≠„Éº„ÉØ„Éº„ÉâÈÖçÁΩÆË®àÁîª
            
            Ë¶Å‰ª∂:
            - „Éö„É´„ÇΩ„Éä„ÅÆÊÇ©„Åø„ÇÑÈñ¢ÂøÉ‰∫ã„Å´ÂØÑ„ÇäÊ∑ª„ÅÜÊßãÊàê
            - „É°„Çø„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíËá™ÁÑ∂„Å´ÁµÑ„ÅøËæº„ÇÄ
            - Ëñ¨Ê©üÊ≥ï„ÉªÊôØË°®Ê≥ï„ÇíËÄÉÊÖÆ„Åó„ÅüË°®ÁèæË®àÁîª
            - Ë™≠„Åø„ÇÑ„Åô„Åè‰æ°ÂÄ§„ÅÆ„ÅÇ„ÇãË®ò‰∫ãÊßãÊàê
          
          allowed_tools: |
            View,
            Write,
            Edit
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
          
          max_turns: "10"

      - name: Upload structure artifacts
        uses: actions/upload-artifact@v4
        with:
          name: structure-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # „Ç∏„Éß„Éñ6: Ë®ò‰∫ãÊú¨Êñá„ÅÆÁîüÊàê
  generate-content:
    needs: [initialize, generate-structure]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 20
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: Generate article content with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            Ë®ò‰∫ãÊú¨Êñá„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            
            „Çø„Çπ„ÇØ:
            1. ‰ª•‰∏ã„ÅÆ„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Çì„ÅßÁêÜËß£:
               - input_params.json: ÂÖ•Âäõ„Éë„É©„É°„Éº„Çø
               - phase1_output.json: ÂàÜÊûêÁµêÊûú
               - phase2_research.json: „É™„Çµ„Éº„ÉÅÁµêÊûú
               - 01_article_structure.md: Ë®ò‰∫ãÊßãÊàê
               - 02_content_plan.md: ÂÜÖÂÆπË®àÁîª
               - 03_seo_strategy.md: SEOÊà¶Áï•
            
            2. „Éö„É´„ÇΩ„Éä„Å´ÊúÄÈÅ©Âåñ„Åï„Çå„ÅüË®ò‰∫ãÊú¨Êñá„ÇíÁîüÊàê:
               - „Éö„É´„ÇΩ„Éä„ÅÆË®ÄËëâÈÅ£„ÅÑ„ÇÑÈñ¢ÂøÉ‰∫ã„ÇíÂèçÊò†
               - ÂÖ∑‰ΩìÁöÑ„ÅßÂÆüË∑µÁöÑ„Å™ÂÜÖÂÆπ
               - Ë™≠„Åø„ÇÑ„Åô„ÅÑÊßãÊàê„Å®Ëá™ÁÑ∂„Å™ÊµÅ„Çå
            
            3. ‰ª•‰∏ã„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÁîüÊàê:
               - 04_draft_article.md: MarkdownÂΩ¢Âºè„ÅÆË®ò‰∫ãÊú¨Êñá
               - 05_article.html: HTMLÂΩ¢Âºè„ÅÆË®ò‰∫ãÔºàÈÅ©Âàá„Å™„Éû„Éº„ÇØ„Ç¢„ÉÉ„ÉóÔºâ
               - 06_meta_data.json: „É°„ÇøÊÉÖÂ†±Ôºà„Çø„Ç§„Éà„É´„ÄÅË™¨Êòé„ÄÅ„Ç≠„Éº„ÉØ„Éº„ÉâÁ≠âÔºâ
            
            Ë¶Å‰ª∂:
            - 3000-5000ÊñáÂ≠óÁ®ãÂ∫¶
            - „Éö„É´„ÇΩ„Éä„Å´Èüø„ÅèË®ÄËëâÈÅ∏„Å≥
            - SEO„ÇíÊÑèË≠ò„Åó„ÅüË¶ãÂá∫„ÅóÊßãÊàê
            - Ëñ¨Ê©üÊ≥ï„ÉªÊôØË°®Ê≥ïÊ∫ñÊã†
          
          allowed_tools: |
            View,
            Write,
            Edit
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
          
          max_turns: "15"

      - name: Upload content artifacts
        uses: actions/upload-artifact@v4
        with:
          name: content-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # „Ç∏„Éß„Éñ7: „Éï„Ç°„ÇØ„Éà„ÉÅ„Çß„ÉÉ„ÇØ
  factcheck:
    needs: [initialize, generate-content]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: Fact-check article with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            Ë®ò‰∫ã„ÅÆ„Éï„Ç°„ÇØ„Éà„ÉÅ„Çß„ÉÉ„ÇØ„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            
            „Çø„Çπ„ÇØ:
            1. ‰ª•‰∏ã„ÅÆ„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Çì„ÅßÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç:
               - 04_draft_article.md: Ë®ò‰∫ãÊú¨Êñá
               - phase2_research.json: „É™„Çµ„Éº„ÉÅÁµêÊûú
            
            2. ‰ª•‰∏ã„ÅÆË¶≥ÁÇπ„Åß„ÉÅ„Çß„ÉÉ„ÇØ:
               - ‰∫ãÂÆü„ÅÆÊ≠£Á¢∫ÊÄßÔºà„É™„Çµ„Éº„ÉÅÁµêÊûú„Å®„ÅÆÁÖßÂêàÔºâ
               - Ëñ¨Ê©üÊ≥ï„ÉªÊôØË°®Ê≥ï„ÅÆÈÅµÂÆà
               - Êï∞ÂÄ§„ÇÑÁµ±Ë®à„ÅÆÊ≠£Á¢∫ÊÄß
               - ÂåªÂ≠¶ÁöÑ„ÉªÁßëÂ≠¶ÁöÑ‰∏ªÂºµ„ÅÆÂ¶•ÂΩìÊÄß
            
            3. ‰øÆÊ≠£„ÅåÂøÖË¶Å„Å™Â†¥Âêà:
               - 04_draft_article.md „ÇíÁõ¥Êé•Á∑®ÈõÜ
               - factcheck_report.md „Å´‰øÆÊ≠£ÂÜÖÂÆπ„ÇíË®òÈå≤
            
            4. „Éö„É´„ÇΩ„Éä„Å∏„ÅÆÈÖçÊÖÆ:
               - „Éö„É´„ÇΩ„Éä„ÅåË™§Ëß£„Åó„ÇÑ„Åô„ÅÑË°®Áèæ„ÅÆ‰øÆÊ≠£
               - „Çà„ÇäÂàÜ„Åã„Çä„ÇÑ„Åô„ÅÑË™¨Êòé„Å∏„ÅÆÊîπÂñÑ
          
          allowed_tools: |
            View,
            Edit
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
          
          max_turns: "10"

      - name: Upload factcheck artifacts
        uses: actions/upload-artifact@v4
        with:
          name: factcheck-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # „Ç∏„Éß„Éñ8: SEOÊúÄÈÅ©Âåñ
  seo-optimization:
    needs: [initialize, generate-content]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: SEO optimization with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            Ë®ò‰∫ã„ÅÆSEOÊúÄÈÅ©Âåñ„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            
            „Çø„Çπ„ÇØ:
            1. ‰ª•‰∏ã„ÅÆ„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Çì„ÅßÊúÄÈÅ©Âåñ:
               - 04_draft_article.md: Ë®ò‰∫ãÊú¨Êñá
               - 05_article.html: HTMLÁâàË®ò‰∫ã
               - 03_seo_strategy.md: SEOÊà¶Áï•
               - input_params.json: „É°„Çø„Ç≠„Éº„ÉØ„Éº„ÉâÁ¢∫Ë™ç
            
            2. SEOÊúÄÈÅ©Âåñ„ÅÆÂÆüÊñΩ:
               - „Çø„Ç§„Éà„É´„Çø„Ç∞„ÅÆÊúÄÈÅ©Âåñ
               - „É°„Çø„Éá„Ç£„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥„ÅÆ‰ΩúÊàê
               - Ë¶ãÂá∫„Åó„Çø„Ç∞ÔºàH1-H3Ôºâ„ÅÆÊúÄÈÅ©Âåñ
               - „Ç≠„Éº„ÉØ„Éº„ÉâÂØÜÂ∫¶„ÅÆË™øÊï¥Ôºà2-3%Ôºâ
               - ÂÜÖÈÉ®„É™„É≥„ÇØÊßãÈÄ†„ÅÆÊèêÊ°à
            
            3. „Éö„É´„ÇΩ„ÉäÂêë„ÅëSEO:
               - „Éö„É´„ÇΩ„Éä„Åå‰Ωø„ÅÜÊ§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÊÑèË≠ò
               - „Éö„É´„ÇΩ„Éä„ÅÆÊ§úÁ¥¢ÊÑèÂõ≥„Å´ÂêàËá¥„Åô„ÇãÂÜÖÂÆπÂº∑Âåñ
            
            4. ÁîüÊàê„Éï„Ç°„Ç§„É´:
               - 06_optimized_content.html: SEOÊúÄÈÅ©ÂåñÊ∏à„ÅøHTML
               - seo_optimization_report.md: ÊúÄÈÅ©ÂåñÂÜÖÂÆπ„É¨„Éù„Éº„Éà
          
          allowed_tools: |
            View,
            Write,
            Edit
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
          
          max_turns: "10"

      - name: Upload SEO artifacts
        uses: actions/upload-artifact@v4
        with:
          name: seo-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # „Ç∏„Éß„Éñ9: ÁîªÂÉèÁîüÊàêÔºàMCP + Imagen4Ôºâ
  generate-images:
    if: ${{ inputs.enable_image_generation }}
    needs: [initialize, generate-structure]
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 20
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: Generate Images with Claude + MCP Imagen4
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            Ë®ò‰∫ã„Å´ÊúÄÈÅ©„Å™ÁîªÂÉè„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            
            „Çø„Çπ„ÇØ:
            1. Ë®ò‰∫ãÂÜÖÂÆπ„ÇíÁêÜËß£:
               - input_params.json „Åß„Éö„É´„ÇΩ„Éä„ÇíÁ¢∫Ë™ç
               - 04_draft_article.md „ÅßË®ò‰∫ãÂÜÖÂÆπ„ÇíÊääÊè°
               - 01_article_structure.md „ÅßÊßãÊàê„ÇíÁêÜËß£
            
            2. „Éö„É´„ÇΩ„Éä„Å´Èüø„ÅèÁîªÂÉè„ÇíÁîüÊàê:
               - „Éí„Éº„É≠„ÉºÁîªÂÉèÔºà16:9Ôºâ: Ë®ò‰∫ãÂÖ®‰Ωì„ÅÆ„Ç§„É°„Éº„Ç∏
               - „Çª„ÇØ„Ç∑„Éß„É≥ÁîªÂÉèÔºà4:3Ôºâ: ‰∏ªË¶Å„Çª„ÇØ„Ç∑„Éß„É≥Áî®Ôºà3-4ÊûöÔºâ
               
               ÈáçË¶Å: ÊúÄÈÅ©Âåñ„Åï„Çå„Åü„Ç≥„É≥„ÉÜ„É≥„ÉÑÔºà06_optimized_content.htmlÔºâ„ÇíÂèÇÁÖß
            
            3. ÁîªÂÉèÁîüÊàê„ÅÆÊñπÈáù:
               - „Éö„É´„ÇΩ„Éä„ÅÆÂπ¥‰ª£„ÉªÊÄßÂà•„Å´Âêà„Çè„Åõ„Åü„Éì„Ç∏„É•„Ç¢„É´
               - Ê∏ÖÊΩîÊÑü„Å®‰ø°È†ºÊÑü„ÅÆ„ÅÇ„Çã„Éá„Ç∂„Ç§„É≥
               - Ë®ò‰∫ãÂÜÖÂÆπ„Å®Ë™øÂíå„Åó„Åü„Ç´„É©„Éº„Éë„É¨„ÉÉ„Éà
               - „ÉÜ„Ç≠„Çπ„Éà„ÇÑ„É≠„Ç¥„ÅØÂê´„Åæ„Å™„ÅÑ
            
            4. MCP„ÉÑ„Éº„É´„ÅÆ‰ΩøÁî®:
               - mcp__gemini-imagen__list_models „Åß„É¢„Éá„É´Á¢∫Ë™ç
               - mcp__gemini-imagen__generate_image „ÅßÁîªÂÉèÁîüÊàê
               - imagen-4 „Åæ„Åü„ÅØ imagen-4-ultra „Çí‰ΩøÁî®
            
            5. „É°„Çø„Éá„Éº„Çø‰ΩúÊàê:
               - images/metadata.json „Å´ÁîüÊàêÊÉÖÂ†±„ÇíË®òÈå≤
               - ÂêÑÁîªÂÉè„ÅÆ„Éó„É≠„É≥„Éó„Éà„Å®Áî®ÈÄî„ÇíË®òËºâ
          
          mcp_config: |
            {
              "mcpServers": {
                "gemini-imagen": {
                  "command": "npx",
                  "args": [
                    "-y", 
                    "gemini-imagen-mcp-server",
                    "--model", "imagen-4"
                  ],
                  "env": {
                    "GEMINI_API_KEY": "${{ secrets.GEMINI_API_KEY }}"
                  }
                }
              }
            }
          
          allowed_tools: |
            View,
            Write,
            mcp__gemini-imagen__generate_image,
            mcp__gemini-imagen__list_models
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
          
          max_turns: "15"

      - name: Process generated images
        run: |
          ARTICLE_DIR="output/${{ needs.initialize.outputs.article_id }}"
          IMAGE_DIR="${ARTICLE_DIR}/images"
          
          # MCP„Çµ„Éº„Éê„Éº„ÅØ imagen/ „Éá„Ç£„É¨„ÇØ„Éà„É™„Å´‰øùÂ≠ò„Åô„Çã
          if [ -d "imagen" ] && [ "$(ls -A imagen 2>/dev/null)" ]; then
            echo "‚úÖ Images found in imagen directory:"
            ls -la imagen/
            
            # ÁîªÂÉè„ÇíË®ò‰∫ã„Éá„Ç£„É¨„ÇØ„Éà„É™„Å´„Ç≥„Éî„Éº
            mkdir -p $IMAGE_DIR
            cp imagen/*.png $IMAGE_DIR/ 2>/dev/null || true
            cp imagen/*.jpg $IMAGE_DIR/ 2>/dev/null || true
            
            # „É™„Éç„Éº„É†Ôºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
            cd $IMAGE_DIR
            i=1
            for img in *.png *.jpg; do
              if [ -f "$img" ]; then
                if [ $i -eq 1 ]; then
                  mv "$img" "hero_image.png" 2>/dev/null || true
                else
                  mv "$img" "section_$((i-1))_image.png" 2>/dev/null || true
                fi
                i=$((i+1))
              fi
            done
            cd -
            
            echo "Final images:"
            ls -la $IMAGE_DIR
          else
            echo "‚ö†Ô∏è No images generated"
          fi

      - name: Upload image artifacts
        uses: actions/upload-artifact@v4
        with:
          name: images-${{ needs.initialize.outputs.article_id }}
          path: |
            output/${{ needs.initialize.outputs.article_id }}/images
            imagen/
          retention-days: 30

  # „Ç∏„Éß„Éñ10: ÊúÄÁµÇÂá¶ÁêÜ„Å®„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
  finalize:
    needs: [initialize, generate-content, factcheck, seo-optimization, generate-images]
    if: always()
    runs-on: ubuntu-latest
    environment: GA
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ needs.initialize.outputs.article_id }}'
          path: output/${{ needs.initialize.outputs.article_id }}
          merge-multiple: true

      - name: Create final package with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            Ë®ò‰∫ã„ÅÆÊúÄÁµÇ„Éë„ÉÉ„Ç±„Éº„Ç∏„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            
            „Çø„Çπ„ÇØ:
            1. „Åô„Åπ„Å¶„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÁ¢∫Ë™ç
            2. final_article.html „Çí‰ΩúÊàê:
               - Ë®ò‰∫ãÊú¨ÊñáÔºà05_article.htmlÔºâ
               - ÁîªÂÉè„ÅÆÈÅ©Âàá„Å™ÈÖçÁΩÆ
               - „É°„ÇøÊÉÖÂ†±„ÅÆÁµ±Âêà
            3. summary.md „Çí‰ΩúÊàê:
               - ÁîüÊàê„Åï„Çå„ÅüË®ò‰∫ã„ÅÆÊ¶ÇË¶Å
               - „Éö„É´„ÇΩ„Éä„Å∏„ÅÆÊúÄÈÅ©Âåñ„Éù„Ç§„É≥„Éà
               - SEOÂØæÁ≠ñ„ÅÆÂÆüÊñΩÂÜÖÂÆπ
               - ‰ΩøÁî®ÁîªÂÉè„ÅÆ„É™„Çπ„Éà
          
          allowed_tools: |
            View,
            Write,
            Edit
          
          claude_env: |
            ARTICLE_ID=${{ needs.initialize.outputs.article_id }}
          
          max_turns: "10"

      # Google Drive Upload („Ç™„Éó„Ç∑„Éß„É≥)
      - name: Setup Python for Drive upload
        if: ${{ inputs.enable_drive_upload }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies for Drive upload
        if: ${{ inputs.enable_drive_upload }}
        run: |
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client

      - name: Upload to Google Drive
        if: ${{ inputs.enable_drive_upload }}
        run: |
          python github-actions/scripts/upload_to_drive.py \
            --article-dir output/${{ needs.initialize.outputs.article_id }} \
            --drive-folder-id ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        env:
          GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}

      - name: Create workflow summary
        if: always()
        run: |
          ARTICLE_DIR="output/${{ needs.initialize.outputs.article_id }}"
          
          echo "## üìù Article Generation V3 Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Input Parameters" >> $GITHUB_STEP_SUMMARY
          echo "- **Title**: ${{ inputs.article_title }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Persona**: ${{ inputs.target_persona }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Keywords**: ${{ inputs.meta_keywords }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "$ARTICLE_DIR/summary.md" ]; then
            echo "### üìä Generation Summary" >> $GITHUB_STEP_SUMMARY
            cat "$ARTICLE_DIR/summary.md" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Generated Files" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find $ARTICLE_DIR -type f -name "*.md" -o -name "*.html" -o -name "*.json" | sort >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          if [ -d "$ARTICLE_DIR/images" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üñºÔ∏è Generated Images" >> $GITHUB_STEP_SUMMARY
            echo "- Image count: $(find $ARTICLE_DIR/images -name "*.png" -o -name "*.jpg" | wc -l)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload final package
        uses: actions/upload-artifact@v4
        with:
          name: final-article-${{ needs.initialize.outputs.article_id }}
          path: output/${{ needs.initialize.outputs.article_id }}
          retention-days: 30

  # ÈÄöÁü•Ôºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
  notify:
    needs: [initialize, finalize]
    if: always() && vars.SLACK_WEBHOOK != ''
    runs-on: ubuntu-latest
    
    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          STATUS="${{ needs.finalize.result }}"
          COLOR="good"
          EMOJI="‚úÖ"
          
          if [ "$STATUS" != "success" ]; then
            COLOR="danger"
            EMOJI="‚ùå"
          fi
          
          curl -X POST $SLACK_WEBHOOK \
            -H 'Content-type: application/json' \
            -d '{
              "attachments": [{
                "color": "'$COLOR'",
                "title": "'$EMOJI' Article Generation V3 '$STATUS'",
                "fields": [
                  {"title": "Title", "value": "'"${{ inputs.article_title }}"'", "short": false},
                  {"title": "Persona", "value": "'"${{ inputs.target_persona }}"'", "short": false},
                  {"title": "Workflow", "value": "'"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"'", "short": false}
                ]
              }]
            }'